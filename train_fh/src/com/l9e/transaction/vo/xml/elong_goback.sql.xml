<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="elongGoBack">
	<!-- 查询发起撤销订单，开始通知 -->
	<select id="getOrderGoBackIdList" resultClass="java.util.HashMap">
		select n.order_id,n.notify_num from  elong_goback_notify n
		WHERE (n.notify_status='00' OR (n.notify_status='11' AND 
		n.notify_time <![CDATA[<=]]> DATE_SUB(NOW(),INTERVAL 1 MINUTE)))
		AND n.notify_num <![CDATA[<]]> 6
		ORDER BY n.create_time DESC
		LIMIT 0,10
	</select>
	
	<!-- 更新订单回库通知表 -->
	<update id="updateGoBackNotify" parameterClass="java.util.HashMap">
		update elong_goback_notify set 
		notify_time=NOW()
		<isNotNull prepend="," property="notify_status">
				notify_status=#notify_status:VARCHAR#
		</isNotNull>
		<isNotNull prepend="," property="notify_num">
				notify_num=#notify_num:VARCHAR#
		</isNotNull>
		<isNotNull prepend="," property="notify_finish_time">
				notify_finish_time=NOW()
		</isNotNull>
		where order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 更新订单为撤销失败 -->
	<update id="updateGoBackOrderInfoStatusFail" parameterClass="java.lang.String">
		update   elong_orderinfo set 
			order_status='52'
		where order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 备份车票信息 -->
	<insert id="insertAllElongCpInfo" parameterClass="java.lang.String">
		insert into elong_orderinfo_cp_goback select * from 
			(select * from elong_orderinfo_cp where order_id=#order_id:VARCHAR#)as a
	</insert>
	
	<!-- 备份订单信息 -->
	<insert id="insertElongOrderInfo" parameterClass="java.lang.String">
		insert into elong_orderinfo_goback select * from 
			(select * from elong_orderinfo where order_id=#order_id:VARCHAR#)as a
	</insert>
	
	<delete id="deleteAllElongCpInfo">
		delete from elong_orderinfo_cp where order_id=#order_id:VARCHAR#
	</delete>
	
	<delete id="deleteAllElongNotifyInfo">
		delete from elong_orderinfo_notify where order_id=#order_id:VARCHAR#
	</delete>
	
	<delete id="deleteAllElongOrderInfo">
		delete from elong_orderinfo where order_id=#order_id:VARCHAR#
	</delete>
	
	<delete id="deleteAllSysCpInfo">
		delete from cp_orderinfo_cp where order_id=#order_id:VARCHAR#
	</delete>
	
	<delete id="deleteAllSysNotifyInfo">
		delete from cp_orderinfo_notify where order_id=#order_id:VARCHAR#
	</delete>
	
	<delete id="deleteAllSysOrderInfo">
		delete from cp_orderinfo where order_id=#order_id:VARCHAR#
	</delete>
</sqlMap>