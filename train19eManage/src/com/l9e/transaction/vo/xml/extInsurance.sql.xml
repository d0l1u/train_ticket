<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="extInsurance">
	
	<!-- 查询条数 -->
	<select id="queryInsuranceListCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT COUNT(1)
		FROM ext_orderinfo_bx bx 
		LEFT JOIN ext_orderinfo hc ON bx.order_id=hc.order_id 
		LEFT JOIN ext_merchantinfo me ON me.merchant_id=hc.merchant_id
		WHERE hc.order_status=#order_status# 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				bx.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="telephone">
				bx.telephone=#telephone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				bx.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				bx.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="bx_code">
				bx.bx_code=#bx_code:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="bx_status">
				bx.bx_status in
				<iterate open="(" close=")" conjunction=","
					property="bx_status">
					#bx_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="merchant_id">
	         	  hc.merchant_id in
		          <iterate open="(" close=")" conjunction="," property="merchant_id">
		            	#merchant_id[]:VARCHAR#
		      	  </iterate>
	      	</isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询列表 -->
	<select id="queryInsuranceList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT bx.bx_id,bx.order_id,bx.cp_id,bx.from_name,bx.to_name,bx.user_name,bx.create_time,me.merchant_id,me.merchant_name,
			bx.telephone,bx.bx_status,bx.pay_money,bx.buy_money,bx.effect_date,bx.train_no,bx.bx_code 
		FROM ext_orderinfo_bx bx 
		LEFT JOIN ext_orderinfo hc ON bx.order_id=hc.order_id 
		LEFT JOIN ext_merchantinfo me ON me.merchant_id=hc.merchant_id
		WHERE hc.order_status=#order_status#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				bx.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="telephone">
				bx.telephone=#telephone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				bx.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				bx.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="bx_code">
				bx.bx_code=#bx_code:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="bx_status">
				bx.bx_status in
				<iterate open="(" close=")" conjunction=","
					property="bx_status">
					#bx_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="merchant_id">
	         	  hc.merchant_id in
		          <iterate open="(" close=")" conjunction="," property="merchant_id">
		            	#merchant_id[]:VARCHAR#
		      	  </iterate>
	      	</isNotEmpty>
		</dynamic>
		ORDER BY bx.create_time DESC LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询明细 -->
	<select id="queryInsuranceInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT bx.bx_id,bx.order_id,bx.cp_id,bx.from_name,bx.to_name,bx.ids_type,
			bx.user_name,bx.user_ids,bx.create_time,bx.telephone,bx.bx_status,bx.bx_code,
			bx.pay_money,bx.buy_money,bx.effect_date,bx.train_no 
		FROM ext_orderinfo_bx bx 
		WHERE bx.order_id=#order_id# AND bx.bx_id=#bx_id#
	</select>
	
	<!-- 添加日志 -->
	<insert id="addLog" parameterClass="java.util.HashMap">
		INSERT INTO ext_orderinfo_history (order_id,order_optlog,create_time,opter)
		VALUES(#order_id#,#log#,NOW(),#opt_person#)
	</insert>
	
	<!-- 查询日志 -->
	<select id="queryLog" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
			DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
			hs.opter
		FROM ext_orderinfo_history hs 
		WHERE hs.order_id=#order_id:VARCHAR#
			order by hs.create_time asc
	</select>
	
	<!-- 重新投保 -->
	<update id="updateInsuranceStatusSendAgain" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_bx bx SET bx.bx_status=#bx_status# WHERE bx.bx_id=#bx_id# AND bx.order_id=#order_id# 
	</update>
	
	<!-- 退保 -->
	<update id="updateInsuranceStatusNeedCancel" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_bx bx SET bx.bx_status=#bx_status# WHERE bx.bx_id=#bx_id# AND bx.order_id=#order_id# 
	</update>

	
</sqlMap>
