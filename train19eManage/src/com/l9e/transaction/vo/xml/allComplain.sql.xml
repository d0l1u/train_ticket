<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="allComplain">

	<!-- 查询条目 -->
	<select id="queryComplainListCount"
		parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT 
		  COUNT(cc.complain_id) 
		FROM
		  cp_complain cc
		WHERE 1=1 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="question_type">
				question_type in
				<iterate open="(" close=")" conjunction=","
					property="question_type">
					#question_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="channel">
				channel in
				<iterate open="(" close=")" conjunction=","
					property="channel">
					#channel[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="reply_season">
				reply_season in
				<iterate open="(" close=")" conjunction=","
					property="reply_season">
					#reply_season[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="permission">
				permission in
				<iterate open="(" close=")" conjunction=","
					property="permission">
					#permission[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			
		<!--	<isNotEmpty prepend=" and " property="create_time">
				 DATE_FORMAT(cc.create_time,'%Y-%m-%d')  = #create_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="reply_time">
				 DATE_FORMAT(cc.reply_time,'%Y-%m-%d')  = #reply_time:VARCHAR#
			  </isNotEmpty>  -->
			 <isNotEmpty prepend=" and " property="begin_create_time">
				cc.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				cc.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
		</dynamic>
	</select>

	<!-- 查询投诉列表 -->
	<select id="queryComplainList" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT 
		  cc.complain_id,
		  cc.agent_id,
 		  cc.question_type,
		  cc.question,
		  cc.answer,
		  cc.permission,
		  cc.user_name,
		  cc.user_phone,
		  cc.province_id,
		  cc.city_id,cc.user_id,
		  cc.reply_season,
		  DATE_FORMAT(cc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		  DATE_FORMAT(cc.reply_time,'%Y-%m-%d %H:%i:%s') AS reply_time,
		  cc.opt_person ,
		  cc.channel
		FROM cp_complain cc 
	 	WHERE 1=1
	 	
		<dynamic prepend="">
			<!--	<isNotEmpty prepend=" and " property="create_time">
				 DATE_FORMAT(cc.create_time,'%Y-%m-%d')  = #create_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="reply_time">
				 DATE_FORMAT(cc.reply_time,'%Y-%m-%d')  = #reply_time:VARCHAR#
			  </isNotEmpty>  -->
			 <isNotEmpty prepend=" and " property="begin_create_time">
				cc.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				cc.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="question_type">
				  cc.question_type in 
				<iterate open="(" close=")" conjunction=","
					property="question_type">
					#question_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="channel">
	         	  cc.channel in 
		          <iterate open="(" close=")" conjunction="," 
		          property="channel">
		            	#channel[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	  <isNotEmpty prepend=" and " property="reply_season">
	         	  cc.reply_season in 
		          <iterate open="(" close=")" conjunction="," 
		          property="reply_season">
		            	#reply_season[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	  	<isNotEmpty prepend=" and " property="permission">
				permission in
				<iterate open="(" close=")" conjunction=","
					property="permission">
					#permission[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		</dynamic>
		ORDER BY create_time DESC LIMIT #everyPagefrom:Integer#,
		#pageSize:Integer#
	</select>

	<!-- 查询详细 -->
	<select id="queryComplainParticularInfo"
		parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT 
		cc.complain_id, 
		cc.question, 
		cc.answer,
		cc.channel,cc.user_id,
		cc.user_name,
		cc.user_phone,cc.reply_season,
		ifnull(cc.permission,'1')AS permission,
		DATE_FORMAT(cc.reply_time,'%Y-%m-%d %H:%i:%s')AS reply_time,
		cc.question_type, 
		hu.user_name,
		hu.user_phone,
		(genp.area_name)AS province_name,
		(genc.area_name)AS city_name 
		FROM cp_complain cc
		LEFT JOIN hc_userinfo hu ON cc.agent_id = hu.user_id LEFT JOIN
		gen_area genp ON cc.province_id = genp.area_no LEFT JOIN
		gen_area genc ON cc.city_id = genc.area_no WHERE
		cc.complain_id=#complain_id#
		

	</select>
	<!-- 查询历史记录 -->
	<select id="queryHistroyByComplainId" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT 
		  cc.complain_id,
		  cc.reply_time,
 		  cc.reply_person,
		  cc.our_reply
		  
		FROM cp_complain_history cc WHERE
		cc.complain_id=#complain_id#
		ORDER BY reply_time DESC
	</select>

	<!-- 修改详细 -->
	<update id="updateComplainParticularInfo"
		parameterClass="com.l9e.transaction.vo.AllComplainVo">
		update cp_complain
		<dynamic prepend="set">
			<isNotEmpty prepend="," property="permission">
				permission=#permission:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="answer">
				answer=#answer:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				opt_person=#opt_person:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="reply_season">
				reply_season=#reply_season:VARCHAR#
			</isNotEmpty>
			,reply_time =now()
		</dynamic>
		where complain_id=#complain_id#
	</update>
	<!-- 增加操作日志 -->
	<insert id="addComplainHistoryInfo" parameterClass="com.l9e.transaction.vo.AllComplainVo">
		INSERT INTO cp_complain_history (complain_id,reply_time,reply_person,our_reply)
		VALUES(#complain_id#,NOW(),#opt_person#,#answer#)
	</insert>

	<!-- 删除投诉与建议信息 -->
	<delete id="deleteComplain" parameterClass="java.lang.String">
		DELETE FROM cp_complain WHERE complain_id=#complain_id#
	</delete>
	
	<!-- 查询统计 -->
	<select id="queryComplainStatCount" resultClass="java.util.HashMap">
		SELECT cc.question_type,cc.permission ,cc.reply_time FROM cp_complain cc 
	</select>
	
	<!-- 插入日志信息 -->
	<!-- <insert id="insertLog" parameterClass="java.util.HashMap">
		INSERT INTO cp_complain_history (complain_id,reply_time,reply_person,our_reply)
		VALUES(#complain_id#,NOW(),#opt_person#,#answer#)
	</insert>
 -->

	<!-- 省市联动 -->

	<!-- 查询全部省信息 -->
	<select id="getProvince"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=1 ORDER
		BY area_id ASC
	</select>

	<!-- 根据省id查询本省的所有市信息 -->
	<select id="getCity" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=2 AND
		area_parentno=#provinceid# ORDER BY area_id ASC
	</select>

	<!-- 根据市id查询本市的所有区信息 -->
	<select id="getArea" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=3 AND
		area_parentno=#cityid# ORDER BY area_id ASC
	</select>
	
	<select id="querySupervise_nameToArea_no" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT area_no,area_name FROM gen_area WHERE area_name=#area_name# AND area_rank='1'
	</select>
</sqlMap>


