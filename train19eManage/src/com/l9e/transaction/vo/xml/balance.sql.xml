<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="balance">
	<!-- 查询支付商户对应订单号-->
	<select id="queryOrderId" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT order_id from cp_orderinfo where  bank_pay_seq = #sh_order_id:VARCHAR#
	</select>
	
	<!--  插入对账表 -->
	<insert id="insertBalanceAccountOne" parameterClass="java.util.Map">
		insert into cp_balance_account
		<dynamic prepend="(">
			create_time,
		<isNotEmpty prepend="," property="stream_id">
			stream_id
		</isNotEmpty>
		<isNotEmpty prepend="," property="cw_seq">
			cw_seq
		</isNotEmpty>
		<isNotEmpty prepend="," property="yw_seq">
			yw_seq
		</isNotEmpty>
		<isNotEmpty prepend="," property="sh_order_id">
			sh_order_id
		</isNotEmpty>
		<isNotEmpty prepend="," property="sp_name">
			sp_name
		</isNotEmpty>
		<isNotEmpty prepend="," property="sp_create_time">
			sp_create_time
		</isNotEmpty>
		<isNotEmpty prepend="," property="user_account">
			user_account
		</isNotEmpty>
		<isNotEmpty prepend="," property="in_money">
			in_money
		</isNotEmpty>
		<isNotEmpty prepend="," property="out_money">
			out_money
		</isNotEmpty>
		<isNotEmpty prepend="," property="surplus_money">
			surplus_money
		</isNotEmpty>
		<isNotEmpty prepend="," property="channel">
			channel
		</isNotEmpty>
		<isNotEmpty prepend="," property="business_status">
			business_status
		</isNotEmpty>
		<isNotEmpty prepend="," property="remark">
			remark
		</isNotEmpty>
		<isNotEmpty prepend="," property="our_account">
			our_account
		</isNotEmpty>
		<isNotEmpty prepend="," property="order_id">
			order_id
		</isNotEmpty>
		</dynamic>
		) VALUES 
		<dynamic prepend="(">
				now(),
		<isNotEmpty prepend="," property="stream_id">
			#stream_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="cw_seq">
			#cw_seq:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="yw_seq">
			#yw_seq:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="sh_order_id">
			#sh_order_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="sp_name">
			#sp_name:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="sp_create_time">
			#sp_create_time:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="user_account">
			#user_account:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="in_money">
			#in_money:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="out_money">
			#out_money:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="surplus_money">
			#surplus_money:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="channel">
			#channel:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="business_status">
			#business_status:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="remark">
			#remark:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="our_account">
			#our_account:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="order_id">
			#order_id:VARCHAR#
		</isNotEmpty>
			)
		</dynamic>
	</insert>
	
	
	
	<insert id="insertBalanceAccount" parameterClass="java.util.List">
		insert into cp_balance_account(	
			create_time,
			stream_id,
			cw_seq,
			yw_seq,
			sh_order_id,
			sp_name,
			sp_create_time,
			user_account,
			in_money,
			out_money,
			surplus_money,
			channel,
			business_status,
			remark,
			our_account,
			order_id
			) VALUES 
		<iterate conjunction=",">  
			(
			now(),
			#list[].stream_id:VARCHAR#,
			#list[].cw_seq:VARCHAR#,
			#list[].yw_seq:VARCHAR#,
			#list[].sh_order_id:VARCHAR#,
			#list[].sp_name:VARCHAR#,
			#list[].sp_create_time:VARCHAR#,
			#list[].user_account:VARCHAR#,
			#list[].in_money:VARCHAR#,
			#list[].out_money:VARCHAR#,
			#list[].surplus_money:VARCHAR#,
			#list[].channel:VARCHAR#,
			#list[].business_status:VARCHAR#,
			#list[].remark:VARCHAR#,
			#list[].our_account:VARCHAR#,
			#list[].order_id:VARCHAR#
			)
			</iterate>
	</insert>
	
	
	<select id="queryBalanceAccountListCount" resultClass="java.lang.Integer">
		select count(1) from cp_balance_account
		 where 1=1 
		 <isNotEmpty  property="sh_order_id">
			and (sh_order_id=#sh_order_id:VARCHAR# or order_id=#sh_order_id:VARCHAR#)
		 </isNotEmpty>
		 <isNotEmpty  property="orderIdIsNotNull">
			and order_id is null
		 </isNotEmpty>
		  <isNotEmpty  property="begin_info_time">
			and	sp_create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty  property="end_info_time">
			and	sp_create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
		</isNotEmpty>
	</select>
	
	<select id="queryBalancAccountList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select * from cp_balance_account
		 where 1=1 
		 <isNotEmpty  property="sh_order_id">
			and (sh_order_id=#sh_order_id:VARCHAR# or order_id=#sh_order_id:VARCHAR#)
		 </isNotEmpty>
		 <isNotEmpty  property="orderIdIsNotNull">
			and order_id is null
		 </isNotEmpty>
		 <isNotEmpty  property="begin_info_time">
			and	sp_create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty  property="end_info_time">
			and	sp_create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
		</isNotEmpty>
		 
		 LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<update id="updateOrderId" parameterClass="java.util.Map">
		update cp_balance_account set order_id=#order_id:VARCHAR#  WHERE id=#id:VARCHAR# 
	</update>
	
	<select id="queryOrderIdByOrderInfo" resultClass="java.lang.String">
		select order_id from cp_orderinfo where 
		buy_money=#buy_money:VARCHAR# and
		DATE_SUB(out_ticket_time,INTERVAL 2 MINUTE)<![CDATA[<=]]>#pay_time:VARCHAR# 
		and #pay_time:VARCHAR#<![CDATA[<=]]>out_ticket_time
		limit 0,1;
	</select>
	
	<select id="queryOrderIdByPaySeq" resultClass="java.lang.String">
		select order_id from cp_orderinfo where  bank_pay_seq=#bank_pay_seq:VARCHAR# 
	</select>
	
	
	
	
	<insert id="insertFile" parameterClass="java.util.HashMap">
		INSERT INTO file_balance_account 
		<dynamic prepend="(">
			<isNotEmpty  property="filename">
				 filename,
			</isNotEmpty>
			<isNotEmpty  property="filepath">
				filepath,
			</isNotEmpty>
			<isNotEmpty  property="bill_time">
				bill_time,
			</isNotEmpty>
			<isNotEmpty  property="opt_name">
				opt_name,
			</isNotEmpty>
			create_time
			)
		</dynamic>
		 values
		<dynamic prepend="(">
			<isNotEmpty  property="filename">
				 #filename:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="filepath">
				 #filepath:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="bill_time">
				#bill_time:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="opt_name">
				#opt_name:VARCHAR#,
			</isNotEmpty>
				NOW()
			)
		</dynamic>
		<!-- 
		(filename,filepath,bill_time,create_time,opt_name)
		VALUES(#filename#,#filepath#,#bill_time#,NOW(),#opt_name#) 
		-->
	</insert>
	
	<!-- 数据库中满足查询条件的总条数 -->
	<select id="queryFileCount" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT COUNT(id) FROM file_balance_account WHERE 1=1 
		<dynamic prepend="">
	      	  <isNotEmpty prepend=" and " property="begin_info_time">
				create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="end_info_time">
				create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			  </isNotEmpty>
	    </dynamic>
	</select>
	
	<!-- 按照条件查询数据库中的内容，并列出 -->
	<select id="queryFileList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT id,filename,filepath,bill_time,opt_name,create_time FROM file_balance_account WHERE 1=1  
		<dynamic prepend="">
	      	  <isNotEmpty prepend=" and " property="begin_info_time">
				create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="end_info_time">
				create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			  </isNotEmpty>
	    </dynamic>
	    ORDER BY create_time DESC
	</select>
	
	
	<!-- 根据id查询文件的路径 -->
	<select id="queryFilepath" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT filepath FROM file_balance_account WHERE id=#id#
	</select>
	
	<!-- 根据id删除文件信息 -->
	<delete id="deleteFile" parameterClass="java.lang.String">
		DELETE FROM file_balance_account WHERE id=#id#
	</delete>
	
	<select id="queryOrderList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select order_id ,order_name,pay_money,buy_money,order_status,
		DATE_FORMAT(create_time,'%Y-%m-%d %T') create_time
		,DATE_FORMAT(pay_time, '%Y-%m-%d %T') pay_time
		,DATE_FORMAT(out_ticket_time, '%Y-%m-%d %T') out_ticket_time
		,out_ticket_type,opt_ren,out_ticket_billno,train_no,from_city,to_city,from_time,to_time,travel_time,seat_type,account_id,worker_id,out_ticket_account,bank_pay_seq,error_info,option_time,channel,ext_seattype,level from cp_orderinfo where   buy_money= #buy_money:VARCHAR#
		and pay_time<![CDATA[>=]]>#out_ticket_time_begin:VARCHAR#
		and pay_time<![CDATA[<=]]>#out_ticket_time_end:VARCHAR#
		limit 0,15
	</select>
	
	
	<update id="updateBalancAccount" parameterClass="java.util.Map">
		update cp_balance_account set order_id=#order_id:VARCHAR#  where  out_money=#pay_money:VARCHAR#
		and sp_create_time <![CDATA[>=]]>#time_start:VARCHAR#
		and sp_create_time	<![CDATA[<=]]>#time_end:VARCHAR#
		and order_id is null
	</update>
	
	<select id="selectUpdateCount" parameterClass="java.util.Map" resultClass="java.lang.Integer">
		select count(1) from cp_balance_account where  out_money=#pay_money:VARCHAR#
		and sp_create_time <![CDATA[>=]]>#time_start:VARCHAR#
		and sp_create_time	<![CDATA[<=]]>#time_end:VARCHAR#
		and order_id is null
	</select>
	
	
	<sql id="queryRefund_where">
		<dynamic prepend="">
	     refund_time <![CDATA[>=]]>#dateStart:VARCHAR#
		and refund_time <![CDATA[<=]]>#dateEnd:VARCHAR#
        </dynamic>
	</sql>
	
	
	<select id="queryAppRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from app_orderinfo_refundstream 
		where  refund_status='33' and
		<include refid="queryRefund_where"/>
		group by order_id
	</select>
	
	<select id="queryInnerRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from inner_orderinfo_refundstream 
		where   refund_status='44' and
		<include refid="queryRefund_where"/>
		group by order_id
	</select>
	
	<select id="queryElongRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from elong_orderinfo_refundstream 
		where  refund_status='11' and
		<include refid="queryRefund_where"/>
		group by order_id
	</select>
	<select id="queryExtRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from ext_orderinfo_refundstream 
		where  refund_status='33' and
		<include refid="queryRefund_where"/>
		group by order_id
	</select>
	<select id="queryHcRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from hc_orderinfo_refundstream 
		where  refund_status='44' and refund_type='1' and
		<include refid="queryRefund_where"/>
		group by order_id
	</select>
	<select id="queryQunarRefund" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		select sum(ifnull(actual_refund_money,0)+ifnull(alter_tickets_money,0)) all_refund_money,order_id from qunar_orderinfo_refund 
		where  refund_status='11' and
		 verify_time <![CDATA[>=]]>#dateStart:VARCHAR#
		and verify_time <![CDATA[<=]]>#dateEnd:VARCHAR#
		group by order_id
	</select>
	

	
	
	<select id="queryRefundMoney"  resultClass="java.lang.String">
		select sum(in_money) from cp_balance_account where order_id=#order_id:VARCHAR#
	</select>
	
	
	<update id="updateRefundResult" >
		update cp_balance_account set refund_result=#refund_result:VARCHAR#  WHERE order_id=#order_id:VARCHAR# and out_money=0 
	</update>
	
</sqlMap>