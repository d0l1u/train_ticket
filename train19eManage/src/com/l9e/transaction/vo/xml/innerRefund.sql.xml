<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="innerRefund">
	
	<!-- 查询列表条数 -->
	<select id="queryRefundTicketCount"  parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(stream_id) FROM inner_orderinfo_refundstream hm 
		LEFT JOIN inner_orderinfo ho ON ho.order_id=hm.order_id 
		WHERE 1=1 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_seq">
				hm.refund_seq=#refund_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_12306_seq">
				hm.refund_12306_seq=#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="opt_person">
				opt_person=#opt_person:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				hm.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				hm.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_type">
				hm.refund_type in
				<iterate open="(" close=")" conjunction=","
					property="refund_type">
					#refund_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		    <isNotEmpty prepend=" and " property="refund_status">
				hm.refund_status in
				<iterate open="(" close=")" conjunction=","
					property="refund_status">
					#refund_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="inner_channel">
				ho.inner_channel in
				<iterate open="(" close=")" conjunction=","
					property="inner_channel">
					#inner_channel[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询列表 -->
	<select id="queryRefundTicketList" parameterClass="java.util.HashMap" 
	resultClass="java.util.HashMap">
		SELECT hm.stream_id,hm.order_id,hm.refund_type,hm.refund_money,hm.refund_status, hm.opt_person,
		ho.inner_channel,hm.return_optlog,ho.pay_channel,
		DATE_FORMAT(hm.create_time,'%Y-%m-%d %H:%i:%s')AS create_time,hm.cp_id,hm.refund_percent,
		DATE_FORMAT(hm.refund_plan_time,'%Y-%m-%d %H:%i:%s')AS refund_plan_time,hm.actual_refund_money,
		(hn.dealer_id)AS refund_note,DATE_FORMAT( ho.from_time, '%Y-%m-%d %H:%i:%s' ) AS from_time
		FROM inner_orderinfo_refundstream hm LEFT JOIN inner_orderinfo ho ON ho.order_id=hm.order_id
		LEFT JOIN refund_note hn ON hm.order_id= hn.order_id WHERE 1=1
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_seq">
				hm.refund_seq=#refund_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_12306_seq">
				hm.refund_12306_seq=#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="opt_person">
				opt_person=#opt_person:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				hm.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				hm.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_type">
				refund_type in
				<iterate open="(" close=")" conjunction=","
					property="refund_type">
					#refund_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		    <isNotEmpty prepend=" and " property="refund_status">
				refund_status in
				<iterate open="(" close=")" conjunction=","
					property="refund_status">
					#refund_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="inner_channel">
				ho.inner_channel in
				<iterate open="(" close=")" conjunction=","
					property="inner_channel">
					#inner_channel[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		</dynamic>
		ORDER BY ho.from_time LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询明细 -->
	<select id="queryRefundTicketInfo" parameterClass="java.util.HashMap" 
		resultClass="java.util.HashMap">
		SELECT 
		  hm.stream_id,
		  hm.order_id,
		  hm.refund_type,
		  hm.cp_id,
		  hm.refund_money,
		  hm.create_time,
		  hm.refund_purl,
		  hm.user_remark,
		  hm.our_remark,
		  hm.actual_refund_money,
		  hm.refund_12306_seq,
		  hm.refund_status,
		  hm.inner_channel,
		  DATE_FORMAT(hm.refund_plan_time, '%Y-%m-%d %H:%i:%s') AS refund_plan_time,
		  hm.refund_percent,
		  hm.alter_tickets_money,
		  change_ticket_info 
		FROM
		  inner_orderinfo_refundstream hm 
		WHERE 1 = 1 
		and	hm.stream_id=#stream_id:VARCHAR#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="cp_id">
				hm.cp_id=#cp_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</select>

	<!-- 增加操作日志cp_id -->
	<insert id="addCpRefundTicket_log" parameterClass="java.util.HashMap">
		INSERT INTO inner_orderinfo_history (order_id,cp_id,order_optlog,create_time,order_time,opter)
		VALUES(#order_id#,#cp_id#,#opt_person_log#,NOW(),#order_time#,#opt_person#)
	</insert>
	
	<!-- 增加操作日志order_id -->
	<insert id="addOrderRefundTicket_log" parameterClass="java.util.HashMap">
		INSERT INTO inner_orderinfo_history (order_id,order_optlog,create_time,order_time,opter)
		VALUES(#order_id#,#opt_person_log#,NOW(),#order_time#,#opt_person#)
	</insert>
	
	<!-- 执行退款 -->
	<update id="updateRefundTicketInfo" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream
		<dynamic prepend="SET">
				refund_status='11' ,
			<isNotEmpty prepend="," property="refund_money">
				refund_money=#refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				actual_refund_money=#actual_refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="alter_tickets_money">
				alter_tickets_money=#alter_tickets_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_limit">
				<isEqual property="refund_limit" compareValue="15">
					refund_plan_time = DATE_ADD(now(),INTERVAL 15 DAY)
				</isEqual>
				<isEqual property="refund_limit" compareValue="1">
					refund_plan_time = DATE_ADD(now(),INTERVAL 5 MINUTE)
				</isEqual>
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				our_remark =#our_remark:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				refund_12306_seq =#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_ticket_info">
				change_ticket_info=#change_ticket_info#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				opt_person =#opt_person:VARCHAR#
			</isNotEmpty>
			,verify_time=NOW()
		</dynamic>
			WHERE 1=1 and refund_status='00' and stream_id =#stream_id#
			<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 更新退款状态 -->
	<update id="updateRefund_StatusTo11" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_status='11' 
		WHERE 1=1
		and refund_status='00' and stream_id =#stream_id#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 查询日志信息 -->
	<select id="queryHistroyByCpId" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
		DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,hs.opter
		FROM inner_orderinfo_history hs 
		WHERE hs.cp_id=#cp_id#
		order by hs.create_time asc
	</select>
	
	<!-- 查询差额退款日志 -->
	<select id="queryHistroyByOrderId" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
		DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,hs.opter
		FROM inner_orderinfo_history hs 
		WHERE hs.order_id=#order_id:VARCHAR#
		order by hs.create_time asc
	</select>
	
	
	<!-- 修改主表中can_refund为1与更新refund_total -->
	<update id="updateOrderInfo_can_refundTo1_And_refund_total" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo SET can_refund='1'
		<dynamic prepend="">
			<isNotEmpty prepend="," property="refund_total">
			refund_total=#refund_total#
			</isNotEmpty>
		</dynamic>
		WHERE order_id=#order_id#
	</update>
	
	<!-- 修改退款状态为拒绝退款同时备注,操作人和审核时间也会修改 -->
	<update id="updateRefund_StatusTo55" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_status='55',hm.our_remark=#our_remark#,hm.opt_person=#opt_person#,hm.verify_time=NOW()
		WHERE 1=1
		and (refund_status = '00' or refund_status = '66')
		and stream_id =#stream_id:VARCHAR#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 差额退款流程：更改退款金额，退款状态，操作人，审核时间 -->
	<update id="updateDifferRefund" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_money=#refund_money#,hm.opt_person=#opt_person#,hm.verify_time=NOW(),
		hm.refund_plan_time=DATE_ADD(NOW(),INTERVAL 5 MINUTE),hm.refund_status='11'
		WHERE hm.stream_id=#stream_id# AND hm.order_id=#order_id#
	</update>
	
	<!-- 线下退款流程：更改退款金额，退款状态，操作人，审核时间 -->
	<update id="updateOfflineRefund" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_money=#refund_money#,hm.opt_person=#opt_person#,hm.verify_time=NOW(),
		hm.refund_plan_time=DATE_ADD(NOW(),INTERVAL 5 MINUTE),hm.refund_status='77'
		WHERE hm.stream_id=#stream_id# AND hm.order_id=#order_id#
	</update>
	
	<!-- 增加差额退款 -->
	<insert id="refundTicketAdd" parameterClass="java.util.HashMap" >
		INSERT INTO inner_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				 order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				 refund_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				 refund_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				 refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				 create_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				 refund_status
			</isNotEmpty>
			<isNotEmpty prepend="," property="inner_channel">
				 inner_channel
			</isNotEmpty>
			<isNotEmpty prepend="," property="notify_num">
				 notify_num
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				 opt_person
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_remark">
				 user_remark
			</isNotEmpty>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				'2'
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				#refund_seq#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				#refund_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				now()
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				'00'
			</isNotEmpty>
			<isNotEmpty prepend="," property="inner_channel">
				#inner_channel#
			</isNotEmpty>
			<isNotEmpty prepend="," property="notify_num">
				'0'
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				#opt_person#
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_remark">
				#user_remark#
			</isNotEmpty>
			)
		</dynamic>
	</insert>
	<!-- 查询buy_money和ticket_pay_money -->
	<select id="queryBuyMoney_TicketPayMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(pay_money,0),CHAR)ticket_pay_money 
		FROM inner_orderinfo WHERE order_id=#order_id#
	</select>
	
	<!-- 查询order_id是否存在  -->
	<select id="queryRefundTicketOrderId" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT order_id FROM inner_orderinfo WHERE order_id=#order_id#  
	</select>
	
	<!-- 查看order_id是否已经生成差额退款 -->
	<select id="queryRefundTicketOrderIdExists" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT DISTINCT order_id FROM inner_orderinfo_refundstream WHERE order_id=#order_id#
	</select>
	
	<!-- 全额退款流程：更改退款金额，退款状态，操作人，审核时间 -->
	<update id="updateOut_Ticket_Refund" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_money=#refund_money#,hm.opt_person=#opt_person#,hm.verify_time=NOW(),
		hm.refund_plan_time=DATE_ADD(NOW(),INTERVAL 5 MINUTE),hm.refund_status='11'
		WHERE hm.stream_id=#stream_id# AND hm.order_id=#order_id#
	</update>
	
	<!-- 更新通知次数 -->
	<update id="updateRefreshNotice" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm SET hm.notify_num=#notify_num# WHERE hm.refund_status=#refund_status#
	</update>
	
	<!-- 差看退款表总金额 -->
	<select id="querySumRefundMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(SUM(refund_money),0),char)AS refund_money FROM inner_orderinfo_refundstream 
		WHERE  order_id=#order_id#  AND refund_status <![CDATA[<>]]>'55' and refund_status <![CDATA[<>]]>'22'
		AND refund_status <![CDATA[<>]]>'66'
	</select>
	
	<!-- 查询queryRefundMoney -->
	<select id="queryRefundMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(refund_money,0),CHAR) refund_money,stream_id 
		FROM inner_orderinfo_refundstream WHERE stream_id=#stream_id#
	</select>
	
	<!-- 查询预订订单信息 -->
	<select id="queryBookOrderInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT hc.order_id,hc.order_status,
		hc.pay_money,DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS
		pay_time,hc.out_ticket_billno,
		hc.out_ticket_type,DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d
		%H:%i:%s') AS out_ticket_time, NULL AS fund_type,
		hc.from_city,hc.to_city,DATE_FORMAT(hc.from_time,'%H:%i') AS
		from_time, DATE_FORMAT(hc.to_time,'%H:%i') AS
		to_time,hc.travel_time, CONVERT(hc.ticket_pay_money,CHAR) AS
		ticket_pay_money,CONVERT(hc.bx_pay_money,CHAR) AS bx_pay_money,
		hc.inner_channel,
		hc.train_no,
		hc.seat_type, 
		hc.buy_money,IFNULL(hc.refund_deadline_ignore,0)AS refund_deadline_ignore,
	    hc.refund_total
		
		FROM inner_orderinfo hc 
		WHERE
		hc.order_id=#order_id:VARCHAR#
	</select>
	
	
	<!-- 查询预订订单-保险 -->
	<select id="queryBookOrderInfoBx" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT bx.bx_id,bx.order_id,bx.from_name,
		bx.to_name,bx.ids_type,bx.user_name,
		bx.user_ids,bx.create_time,bx.modify_time,
		bx.telephone,bx.bx_status,bx.bx_code,
		bx.bx_billno,bx.pay_money,bx.buy_money FROM cp_orderinfo_bx bx
		WHERE bx.order_id=#order_id:VARCHAR#
	</select>
	
	
	<!-- 查询预订订单-车票 -->
	<select id="queryBookOrderInfoCp" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.cp_id,cp.order_id,cp.user_name,cp.train_box,cp.seat_no,
		cp.ticket_type,cp.ids_type, cp.user_ids,cp.telephone,
		cp.create_time,cp.pay_money,
		cp.buy_money,cp.modify_time,cp.seat_type,(hp.NAME)AS
		name_type,bx.bx_code FROM inner_orderinfo_cp cp LEFT JOIN
		cp_orderinfo_bx bx ON cp.cp_id=bx.cp_id LEFT JOIN inner_productinfo
		hp ON bx.product_id=hp.product_id WHERE
		cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询存在  -->
	<select id="queryRefundTicket" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT DISTINCT p.cp_id,p.user_name,p.buy_money,o.inner_channel FROM inner_orderinfo_cp p,inner_orderinfo o WHERE
		p.order_id=o.order_id AND p.order_id=#order_id# 
	</select>
	
	<!-- 增加线下退款 -->
	<insert id="queryRefundTicketAdd" parameterClass="java.util.HashMap" >
		INSERT INTO inner_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				 order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				 refund_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="cp_id">
				 cp_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				 refund_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				 refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				 actual_refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				 create_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				 our_remark
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				 refund_12306_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				 refund_status
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				 opt_person
			</isNotEmpty>
			<isNotEmpty prepend="," property="inner_channel">
				 inner_channel
			</isNotEmpty>
			
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				#refund_type#
			</isNotEmpty>
			<isNotEmpty prepend="," property="cp_id">
				#cp_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				#refund_seq#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				#refund_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				#actual_refund_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				now()
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				#our_remark#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				#refund_12306_seq#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				#refund_status#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				#opt_person#
			</isNotEmpty>
			<isNotEmpty prepend="," property="inner_channel">
				 #inner_channel#
			</isNotEmpty>
		
			)
		</dynamic>
	</insert>
	
	<!--退款失败重新退款 -->
	<update id="refundTicketAgain" parameterClass="java.util.HashMap">
		UPDATE inner_orderinfo_refundstream hm 
		SET hm.refund_status='11',hm.pay_channel='alipay' ,hm.opt_person=#opt_person#
		WHERE 1=1
		and refund_status='34' 
		and stream_id =#stream_id#
		and order_id =#order_id:VARCHAR#
	</update>
</sqlMap>