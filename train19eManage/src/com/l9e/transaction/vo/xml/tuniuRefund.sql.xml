<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="tuniuRefund">
	
	<!-- 查询列表条数 -->
	<select id="queryRefundTicketCount"  parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(hm.refund_id) FROM tuniu_orderinfo_refund hm 
		LEFT JOIN tuniu_notify_refund fy ON fy.refund_id=hm.refund_id
		WHERE 1=1 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_seq">
				hm.refund_seq=#refund_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="opt_person">
				hm.opt_person=#opt_person:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				hm.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				hm.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_type">
				hm.refund_type in
				<iterate open="(" close=")" conjunction=","
					property="refund_type">
					#refund_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		    <isNotEmpty prepend=" and " property="refund_status">
				hm.refund_status in
				<iterate open="(" close=")" conjunction=","
					property="refund_status">
					#refund_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			 <isNotEmpty prepend=" and " property="notify_status">
				fy.notify_status in
				<iterate open="(" close=")" conjunction=","
					property="notify_status">
					#notify_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询列表 -->
	<select id="queryRefundTicketList" parameterClass="java.util.HashMap" 
	resultClass="java.util.HashMap">
		SELECT hm.refund_id,hm.order_id,hm.refund_type,hm.refund_money,hm.out_ticket_billno,
		hm.refund_status,hm.refund_seq,hm.refund_12306_seq,'tuniu' AS channel,
		hm.opt_person,fy.notify_num,fy.notify_status,DATE_FORMAT(hm.verify_time,'%Y-%m-%d %H:%i:%s') AS verify_time,
		DATE_FORMAT(hm.create_time,'%Y-%m-%d %H:%i:%s')AS create_time,hm.cp_id,
		hm.actual_refund_money, hm.detail_refund,hm.detail_alter,
		CONVERT(hn.ticket_num,CHAR) AS ticket_num
		FROM tuniu_orderinfo_refund hm 
		LEFT JOIN tuniu_orderinfo hn ON hm.order_id= hn.order_id 
		LEFT JOIN tuniu_notify_refund fy ON fy.refund_id=hm.refund_id
		WHERE 1=1 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_seq">
				hm.refund_seq=#refund_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="opt_person">
				hm.opt_person=#opt_person:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_create_time">
				hm.create_time <![CDATA[>=]]> #begin_create_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_create_time">
				hm.create_time <![CDATA[<]]> DATE_ADD(#end_create_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_type">
				hm.refund_type in
				<iterate open="(" close=")" conjunction=","
					property="refund_type">
					#refund_type[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		    <isNotEmpty prepend=" and " property="refund_status">
				hm.refund_status in
				<iterate open="(" close=")" conjunction=","
					property="refund_status">
					#refund_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			 <isNotEmpty prepend=" and " property="notify_status">
				fy.notify_status in
				<iterate open="(" close=")" conjunction=","
					property="notify_status">
					#notify_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
		</dynamic>
		ORDER BY hm.create_time LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询存在  -->
	<select id="queryChangeRefundTicket" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT DISTINCT p.new_cp_id AS cp_id,p.user_name,p.change_buy_money, o.out_ticket_billno,'tuniu' AS channel FROM elong_orderinfo_change o
		LEFT JOIN  elong_change_cp p ON p.change_id=o.change_id 
	    WHERE o.change_status ='34' AND p.order_id=#order_id# 
	</select>
	
	<!-- 查询明细 -->
	<select id="queryRefundTicketInfo" parameterClass="java.util.HashMap" 
		resultClass="java.util.HashMap">
		SELECT 
		  hm.refund_id,
		  hm.order_id,
		  hm.refund_type,
		  hm.cp_id,
		  hm.refund_money,
		  hm.create_time,
		  hm.user_remark,
		  hm.our_remark,
		  hm.actual_refund_money,
		  hm.verify_time,
		  hm.refund_12306_seq,
		  hm.refund_status,
		  hm.refund_seq ,
		  hm.detail_refund,
		  hm.detail_alter  
		FROM
		  tuniu_orderinfo_refund hm 
		WHERE 1 = 1 
		and	hm.refund_id=#refund_id:VARCHAR#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				hm.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="cp_id">
				hm.cp_id=#cp_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</select>

	<!-- 增加操作日志cp_id -->
	<insert id="addCpRefundTicket_log" parameterClass="java.util.HashMap">
		INSERT INTO tuniu_orderinfo_history (order_id,cp_id,order_optlog,create_time,order_time,opter)
		VALUES(#order_id#,#cp_id#,#opt_person_log#,NOW(),#order_time#,#opt_person#)
	</insert>
	
	<!-- 增加操作日志order_id -->
	<insert id="addOrderRefundTicket_log" parameterClass="java.util.HashMap">
		INSERT INTO tuniu_orderinfo_history (order_id,order_optlog,create_time,order_time,opter)
		VALUES(#order_id#,#opt_person_log#,NOW(),#order_time#,#opt_person#)
	</insert>
	
	<!-- 执行退款 -->
	<update id="updateRefundTicketInfo" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund
		<dynamic prepend="SET">
				refund_status='11' ,
			<isNotEmpty prepend="," property="refund_money">
				refund_money=#refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				actual_refund_money=#actual_refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="alter_tickets_money">
				alter_tickets_money=#alter_tickets_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_limit">
				<isEqual property="refund_limit" compareValue="15">
					refund_plan_time = DATE_ADD(now(),INTERVAL 15 DAY)
				</isEqual>
				<isEqual property="refund_limit" compareValue="1">
					refund_plan_time = DATE_ADD(now(),INTERVAL 5 MINUTE)
				</isEqual>
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				our_remark =#our_remark:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				refund_12306_seq =#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				opt_person =#opt_person:VARCHAR#
			</isNotEmpty>
			,verify_time=NOW()
		</dynamic>
			WHERE 1=1 and (refund_status='00'  or refund_status='03' or refund_status='07' or refund_status='99') and refund_id =#refund_id#
			<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 更新退款状态 -->
	<update id="updateRefund_StatusTo11" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund hm 
		SET hm.refund_status='11' 
		WHERE 1=1
		and refund_status='00' and refund_id =#refund_id#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 查询日志信息 -->
	<select id="queryHistroyByCpId" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
		DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,hs.opter
		FROM tuniu_orderinfo_history hs 
		WHERE hs.cp_id=#cp_id#
		order by hs.create_time desc
	</select>
	
	<!-- 查询差额退款日志 -->
	<select id="queryHistroyByOrderId" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
		DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,hs.opter
		FROM tuniu_orderinfo_history hs 
		WHERE hs.order_id=#order_id:VARCHAR#
		order by hs.create_time desc
	</select>
	
	
	<!-- 修改退款状态为拒绝退款同时备注,操作人和审核时间也会修改 -->
	<update id="updateRefund_StatusTo55" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund hm 
		SET hm.refund_status='22',hm.our_remark=#our_remark#,hm.opt_person=#opt_person#,hm.verify_time=NOW()
		WHERE 1=1
		and (refund_status = '00' or refund_status='03' or refund_status='07' or refund_status='99')
		and refund_id =#refund_id:VARCHAR#
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id =#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 查询buy_money和ticket_pay_money -->
	<select id="queryBuyMoney_TicketPayMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(pay_money,0),CHAR)ticket_pay_money 
		FROM tuniu_orderinfo WHERE order_id=#order_id#
	</select>
	
	<!-- 查询order_id是否存在  -->
	<select id="queryRefundTicketOrderId" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT order_id FROM tuniu_orderinfo WHERE order_id=#order_id#  
	</select>
	
	<!-- 查询cp_id是否存在  -->
	<select id="queryRefundStationTicketCpId" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT DISTINCT cp_id FROM tuniu_orderinfo_cp WHERE order_id=#order_id# AND cp_id=#cp_id#
	</select>
	
	<!-- 查询cp_id是否已经生成退款  -->
	<select id="queryCpidIsRefund" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT cp_id FROM tuniu_orderinfo_refund WHERE order_id=#order_id# AND cp_id=#cp_id#
	</select>
	
	<!-- 全额退款流程：更改退款金额，退款状态，操作人，审核时间 -->
	<update id="updateOut_Ticket_Refund" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund hm 
		SET hm.refund_money=#refund_money#,hm.opt_person=#opt_person#,hm.verify_time=NOW(),
		hm.refund_plan_time=DATE_ADD(NOW(),INTERVAL 5 MINUTE),hm.refund_status='11'
		WHERE hm.refund_id=#refund_id# AND hm.order_id=#order_id#
	</update>
	
	<!-- 出票失败退款流程：tuniu_orderinfo_refundeopnotify -->
	<update id="updateOutTicketRefundEOP" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refundeopnotify SET notify_time=NOW(),notify_status='22' 
		WHERE order_id=#order_id# and refund_seq=#refund_seq#
	</update>
	
	<!-- 更新通知次数 -->
	<update id="updateRefreshNotice" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund hm SET hm.notify_num=#notify_num# WHERE hm.refund_status=#refund_status#
	</update>
	
	<!-- 差看退款表总金额 -->
	<select id="querySumRefundMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(SUM(refund_money),0),char)AS refund_money FROM tuniu_orderinfo_refund 
		WHERE  order_id=#order_id#  AND refund_status <![CDATA[<>]]>'55' and refund_status  <![CDATA[<>]]>'22'
	</select>
	
	<!-- 查询queryRefundMoney -->
	<select id="queryRefundMoney" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(refund_money,0),CHAR)ticket_refund_money ,refund_id 
		FROM tuniu_orderinfo_refund WHERE refund_id=#refund_id#
	</select>
	
	<!-- 查询预订订单信息 -->
	<select id="queryBookOrderInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT 
		  hc.order_id,
		  hc.order_status,
		  hc.pay_money,
		  hc.out_ticket_billno,
		  DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
		  hc.from_city,
		  hc.to_city,
		  hc.from_time,
		  hc.to_time,
		  hc.pay_money,
		  hc.train_no,
		  hc.buy_money
		FROM
		  tuniu_orderinfo hc 
		  LEFT JOIN
		  tuniu_orderinfo_refund re 
		  ON re.order_id = hc.order_id 
		WHERE
		hc.order_id=#order_id:VARCHAR# LIMIT 0,1
	</select>
	
	
	<!-- 查询预订订单-车票 -->
	<select id="queryBookOrderInfoCp" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT 
		  cp.cp_id,
		  cp.order_id,
		  cp.user_name,
		  cp.train_box,
		  cp.seat_no,
		  cp.ticket_type,
		  cp.ids_type,
		  cp.user_ids,
		  cp.telephone,
		  cp.create_time,
		  cp.pay_money,
		  cp.buy_money,
		  cp.seat_type
		FROM
		  tuniu_orderinfo_cp cp 
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 根据refund_seq查询tuniu_orderinfo_refund有几条退款记录 -->
	<select id="queryRefundCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT  COUNT(order_id) FROM tuniu_orderinfo_refund WHERE refund_seq=#refund_seq# and refund_status='00'
	</select>
	<!-- 更新tuniu_orderinfo_cp表的信息（同意退款）  -->
	<update id="updateCpRefundStatusSuccess" parameterClass="java.lang.String">
		UPDATE tuniu_orderinfo_cp  
		<dynamic prepend="SET">
			refund_status='11'
		</dynamic>
		WHERE cp_id=#cp_id#
	</update>
	<!-- 更新tuniu_orderinfo_cp表的信息（拒绝退款）  -->
	<update id="updateCpRefundStatusFail" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_cp  
		<dynamic prepend="SET">
			refund_status='22',
			refund_fail_reason=#our_remark#
		</dynamic>
		WHERE cp_id=#cp_id#
	</update>
	
	<!-- 更新tuniu_orderinfo_refund表的信息（同意退款）  -->
	<update id="updateRefundNotify" parameterClass="java.util.HashMap">
		UPDATE tuniu_orderinfo_refund 
		<dynamic prepend="SET">
				refund_status='11',
			<isNotEmpty prepend="," property="refund_money">
				refund_money=#refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				actual_refund_money=#actual_refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="alter_tickets_money">
				alter_tickets_money=#alter_tickets_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_limit">
				<isEqual property="refund_limit" compareValue="15">
					refund_plan_time = DATE_ADD(now(),INTERVAL 15 DAY)
				</isEqual>
				<isEqual property="refund_limit" compareValue="1">
					refund_plan_time = DATE_ADD(now(),INTERVAL 5 MINUTE)
				</isEqual>
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				our_remark =#our_remark:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				refund_12306_seq =#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_ticket_info">
				change_ticket_info =#change_ticket_info:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				opt_person =#opt_person:VARCHAR#
			</isNotEmpty>
			,verify_time=NOW()
		</dynamic>
		WHERE order_id=#order_id# and cp_id=#cp_id# and refund_seq=#refund_seq#
	</update>
	
	<!-- 更新tuniu_notify_refund表的信息（同意退款）  -->
	<update id="updateTuniuRefundNotifyStatus" parameterClass="java.util.HashMap">
		UPDATE tuniu_notify_refund hm 
		<dynamic prepend="SET">
			hm.notify_status='11',
			notify_time=now()
		</dynamic> 
		WHERE hm.order_id=#order_id# and hm.refund_seq=#refund_seq#
	</update>
	
	<!-- 更新重新通知 -->
	<update id="updateTuniuRefundNotifyNum" parameterClass="java.util.HashMap">
		UPDATE tuniu_notify_refund SET notify_num='0',notify_time=NOW() 
		WHERE notify_id=#notify_id# 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				order_id =#order_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</update>
	
	<!-- 删除退款信息 -->
	<delete id="deleteRefundNotify" parameterClass="java.util.HashMap">
		DELETE FROM tuniu_notify_refund WHERE order_id=#order_id:VARCHAR# and refund_seq=#refund_seq:VARCHAR#
	</delete>
	
	<!-- 增加车站退票 -->
	<insert id="queryRefundStationTicketAdd" parameterClass="java.util.HashMap" >
		INSERT INTO tuniu_orderinfo_refund
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				 order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				 refund_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="cp_id">
				 cp_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				 refund_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="out_ticket_billno">
				 out_ticket_billno
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				 refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				 actual_refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="detail_refund">
				 detail_refund
			</isNotEmpty>
			<isNotEmpty prepend="," property="alter_tickets_money">
				 alter_tickets_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				 create_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_time">
				 refund_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_purl">
				 refund_purl
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_remark">
				 user_remark
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				 our_remark
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_plan_time">
				 refund_plan_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				 refund_12306_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="verify_time">
				 verify_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				 refund_status
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				 opt_person
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_percent">
				 refund_percent
			</isNotEmpty>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_type">
				#refund_type#
			</isNotEmpty>
			<isNotEmpty prepend="," property="cp_id">
				#cp_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_seq">
				#refund_seq#
			</isNotEmpty>
			<isNotEmpty prepend="," property="out_ticket_billno">
				#out_ticket_billno#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				#refund_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="actual_refund_money">
				#actual_refund_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="detail_refund">
				 #detail_refund#
			</isNotEmpty>
			<isNotEmpty prepend="," property="alter_tickets_money">
				#alter_tickets_money#
			</isNotEmpty>
			<isNotEmpty prepend="," property="create_time">
				now()
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_time">
				#refund_time#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_purl">
				#refund_purl#
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_remark">
				#user_remark#
			</isNotEmpty>
			<isNotEmpty prepend="," property="our_remark">
				#our_remark#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_plan_time">
				#refund_plan_time#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				#refund_12306_seq#
			</isNotEmpty>
			<isNotEmpty prepend="," property="verify_time">
				#verify_time#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
				#refund_status#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				#opt_person#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_percent">
				#refund_percent#
			</isNotEmpty>
			)
		</dynamic>
		
		<selectKey resultClass="java.lang.String" keyProperty="refund_id">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- 查询预订订单信息 -->
	<select id="queryOrderInfo" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hc.order_id, hc.eop_order_id, hc.eop_refund_url as notify_url, hc.order_status,
		re.refund_seq, re.refund_money, DATE_FORMAT(re.refund_time,'%Y-%m-%d %H:%i:%s') refund_time
		FROM tuniu_orderinfo hc 		
		LEFT JOIN tuniu_orderinfo_refund re ON re.order_id=hc.order_id
		WHERE hc.order_id=#order_id:VARCHAR# LIMIT 0,1
	</select>
	
	<!-- 更新日志信息 -->
	<insert id="insertLog" parameterClass="java.util.HashMap">
		INSERT INTO tuniu_orderinfo_history (order_id,order_optlog, create_time,opter,order_time) 
		VALUES (#order_id#, #content#, now(), #user#, #order_time#)
	</insert>
	
	<!-- 更新orderinfo订单信息 -->
	<update id="updateOrder" parameterClass="java.util.HashMap">
		update tuniu_orderinfo set opt_ren=#user#, opt_time=now() 
		where order_id=#order_id#
	</update>
	
	<!-- 更新refund表中操作人信息 -->
	<update id="updateRefundOpt" parameterClass="java.util.HashMap">
		update tuniu_orderinfo_refund set opt_person=#user# 
		where order_id=#order_id# AND refund_seq=#refund_seq#
	</update>
	
	<!-- 添加退款流水 -->
	<insert id="addRefundStationTicketNotify" parameterClass="java.util.HashMap">
		insert into tuniu_notify_refund
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				cp_id
			</isNotNull>
			<isNotNull prepend="," property="refund_id">
				refund_id
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="notify_status">
				notify_status
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				notify_url
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_id">
				#refund_id:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="notify_status">
				#notify_status#
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				#notify_url:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 查询cp_id是否已经生成退款  -->
	<select id="queryCpidIsRefundNum" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT count(cp_id) FROM tuniu_orderinfo_refund WHERE order_id=#order_id# AND cp_id=#cp_id#
		<dynamic prepend="">
			<isNotEmpty prepend="and" property="refund_status">
				refund_status <![CDATA[<>]]> '22' 
			</isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询是否为出票成功订单  -->
	<select id="queryStatusByOrderId" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT order_status FROM tuniu_orderinfo WHERE order_id=#order_id#
	</select>
	
	<!-- 查询商户Id  -->
	<select id="queryMerchantIdByOrderId" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT merchant_order_id FROM tuniu_orderinfo WHERE order_id=#order_id#
	</select>
	
	<!-- 查询车票票价金额  -->
	<select id="queryMoneyByCpId" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT pay_money,buy_money	FROM tuniu_orderinfo_cp WHERE order_id=#order_id# and cp_id=#cp_id#
	</select>
	
	<!-- 查询存在  -->
	<select id="queryTicketCpId" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT DISTINCT p.cp_id,p.user_name,p.buy_money,p.pay_money AS change_buy_money,o.out_ticket_billno FROM tuniu_orderinfo_cp p,tuniu_orderinfo o WHERE
		p.order_id=o.order_id AND p.order_id=#order_id# 
	</select>
	
	<!-- 差看退款表总金额 -->
	<select id="queryCpSumRefundMoney" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT CONVERT(IFNULL(SUM(refund_money),0),char)AS refund_money FROM tuniu_orderinfo_refund 
		WHERE  order_id=#order_id# AND cp_id=#cp_id#  AND refund_status <![CDATA[<>]]>'22'
	</select>
	
	
	<!-- 查询buy_money和ticket_pay_money -->
	<select id="queryCpBuyAndPayMoney" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT CONVERT(IFNULL(pay_money,0),char)ticket_pay_money ,CONVERT(IFNULL(buy_money,0),CHAR)ticket_buy_money 
		FROM tuniu_orderinfo_cp WHERE order_id=#order_id# AND cp_id=#cp_id#
	</select>
	
	<!-- 查询退款时间 -->
	<select id="queryRefundTime" parameterClass="java.util.HashMap" resultClass="java.lang.String">
		SELECT  verify_time FROM tuniu_orderinfo_refund 
		WHERE 1 = 1 
		<dynamic prepend="">
			<isNotEmpty prepend=" and " property="order_id">
				order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="cp_id">
				cp_id=#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="refund_status">
				refund_status=#refund_status:VARCHAR#
			</isNotEmpty>
		</dynamic>
		limit 1
	</select>
	
</sqlMap>