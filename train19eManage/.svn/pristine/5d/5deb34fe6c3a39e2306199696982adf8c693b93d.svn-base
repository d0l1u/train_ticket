<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="book">

	<!-- 查询预订订单条数 -->
	<select id="queryBookListCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT 
		    COUNT(hc.order_id)
		  FROM
		    hc_orderinfo hc 
		    LEFT JOIN
		    hc_userinfo hu 
		    ON hc.dealer_id = hu.user_id 
		  WHERE 1 = 1
		<dynamic prepend="">
			<isNotEqual compareValue="000000"
				property="at_province_id">
				<isNotEmpty prepend=" and " property="at_province_id">
					hc.at_province_id=#at_province_id:VARCHAR#
				</isNotEmpty>
			</isNotEqual>
			<isNotEqual compareValue="000000"
				property="at_province_id">
				<isNotEmpty prepend=" and " property="at_city_id">
					hc.at_city_id=#at_city_id:VARCHAR#
				</isNotEmpty>
			</isNotEqual>
			<isNotEmpty prepend=" and " property="order_id">
				hc.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="user_phone">
				hu.user_phone=#user_phone:VARCHAR#
			</isNotEmpty>
			<!-- 
			<isNotEmpty prepend=" and " property="eop_order_id">
				eop.eop_order_id=#eop_order_id:VARCHAR#
			</isNotEmpty>
			 -->
			<isNotEmpty prepend=" and " property="out_ticket_billno">
				hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_info_time">
				hc.create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_info_time">
				hc.create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="begin_out_time">
				hc.out_ticket_time <![CDATA[>=]]> #begin_out_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_out_time">
				hc.out_ticket_time <![CDATA[<]]> DATE_ADD(#end_out_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="order_status">
				order_status in
				<iterate open="(" close=")" conjunction=","
					property="order_status">
					#order_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_source">
				<iterate open="(" close=")" conjunction=" or " property="order_source">
					hc.order_id LIKE  CONCAT( #order_source[]:VARCHAR#, '%' ) 
				</iterate>
			</isNotEmpty>
		</dynamic>
		

	</select>

	<!-- 查询预订订单列表 -->
	<select id="queryBookList" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
	SELECT 
	  hc.order_id,
	  hc.at_province_id,
	  hc.at_city_id,
	  hc.from_city,
	  hc.to_city,
	  CONVERT(hc.ticket_pay_money, CHAR) AS ticket_pay_money,
	  CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money,
	  CONVERT(hc.ps_pay_money, CHAR) AS ps_pay_money,
	  CONVERT(hc.server_pay_money, CHAR) AS server_pay_money,
	  CONVERT(hc.pay_money, CHAR) AS pay_money,
	  hc.order_status,
	  DATE_FORMAT(hc.pay_time, '%Y-%m-%d %H:%i:%s') AS pay_time,
	  DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
	  hc.train_no,
	  DATE_FORMAT( hc.from_time, '%Y-%m-%d %H:%i:%s') AS from_time,
	  hc.out_ticket_billno,
	  hc.dealer_name,
	  hc.out_ticket_type,
	  hc.opt_ren,
	  DATE_FORMAT( hc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
	  hc.at_province_id,
	  hc.at_city_id,
	  hu.user_phone 
	FROM
	  hc_orderinfo hc 
	  LEFT JOIN hc_userinfo hu ON hc.dealer_id = hu.user_id 
	WHERE 1 = 1 
		<dynamic prepend="">
			<isNotEqual compareValue="000000"
				property="at_province_id">
				<isNotEmpty prepend=" and " property="at_province_id">
					hc.at_province_id=#at_province_id:VARCHAR#
				</isNotEmpty>
			</isNotEqual>
			<isNotEqual compareValue="000000"
				property="at_province_id">
				<isNotEmpty prepend=" and " property="at_city_id">
					hc.at_city_id=#at_city_id:VARCHAR#
				</isNotEmpty>
			</isNotEqual>
			<isNotEmpty prepend=" and " property="order_id">
				hc.order_id=#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="user_phone">
				hu.user_phone=#user_phone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="out_ticket_billno">
				hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="begin_info_time">
				hc.create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_info_time">
				hc.create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="begin_out_time">
				hc.out_ticket_time <![CDATA[>=]]> #begin_out_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="end_out_time">
				hc.out_ticket_time <![CDATA[<]]> DATE_ADD(#end_out_time:VARCHAR#,INTERVAL 1 DAY)
			</isNotEmpty>
			
			<isNotEmpty prepend=" and " property="order_status">
				order_status in
				<iterate open="(" close=")" conjunction=","
					property="order_status">
					#order_status[]:VARCHAR#
				</iterate>
			</isNotEmpty>
			<isNotEmpty prepend=" and " property="order_source">
				<iterate open="(" close=")" conjunction=" or " property="order_source">
					hc.order_id LIKE  CONCAT( #order_source[]:VARCHAR#, '%' ) 
				</iterate>
			</isNotEmpty>
		</dynamic>
		ORDER BY hc.create_time DESC
		LIMIT #everyPagefrom:Integer#,
		#pageSize:Integer#
	</select>
	
	
	
	<!-- 查询预订订单信息 -->
	<select id="queryBookOrderInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT hc.order_id,hc.order_status,hc.dealer_name,
		hc.pay_money,DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS
		pay_time,hc.out_ticket_billno,
		hc.out_ticket_type,DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d
		%H:%i:%s') AS out_ticket_time, NULL AS fund_type,
		hc.from_city,hc.to_city,DATE_FORMAT(hc.from_time,'%H:%i') AS
		from_time, DATE_FORMAT(hc.to_time,'%H:%i') AS
		to_time,hc.travel_time, CONVERT(hc.ticket_pay_money,CHAR) AS
		ticket_pay_money,CONVERT(hc.bx_pay_money,CHAR) AS bx_pay_money,
		CONVERT(hc.ps_pay_money,CHAR) AS ps_pay_money,
		CONVERT(hc.server_pay_money,CHAR) AS server_pay_money,hc.pay_money,
		ps.link_name,ps.link_phone,ps.link_mail,hc.train_no,
		hc.seat_type, ps.link_address,ps.pay_money,ps.ps_status,
		hc.buy_money,IFNULL(hc.refund_deadline_ignore,0)AS refund_deadline_ignore,
	    ps.ps_billno ,hc.refund_total,
		ps.ps_company,hu.user_phone,he.eop_order_id FROM hc_orderinfo hc 
	    LEFT JOIN cp_orderinfo_ps ps ON hc.order_id = ps.order_id
		LEFT JOIN hc_userinfo hu ON hc.dealer_id = hu.user_id 
		LEFT JOIN hc_order_eop he ON hc.order_id = he.order_id 
		WHERE
		hc.order_id=#order_id:VARCHAR#
		
	</select>
	
	<!-- 切换无视截止时间 -->
	<update id="updateSwitch_ignore" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo SET refund_deadline_ignore=#refund_deadline_ignore#,opt_ren=#opt_ren# WHERE order_id=#order_id#
	</update>
	
	<!-- 查询预订订单-保险 -->
	<select id="queryBookOrderInfoBx" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT bx.bx_id,bx.order_id,bx.from_name,
		bx.to_name,bx.ids_type,bx.user_name,
		bx.user_ids,bx.create_time,bx.modify_time,
		bx.telephone,bx.bx_status,bx.bx_code,
		bx.bx_billno,bx.pay_money,bx.buy_money FROM cp_orderinfo_bx bx
		WHERE bx.order_id=#order_id:VARCHAR#
	</select>

	<!-- 查询预订订单-车票 -->
	<select id="queryBookOrderInfoCp" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT
		cp.cp_id,cp.order_id,cp.user_name,cp.train_box,cp.seat_no,
		cp.ticket_type,cp.ids_type, cp.user_ids,cp.telephone,
		cp.create_time,cp.pay_money,
		cp.buy_money,cp.modify_time,cp.seat_type,(hp.name)AS
		name_type,bx.bx_code ,
		cp.alter_seat_type, cp.alter_train_box, cp.alter_seat_no, cp.alter_buy_money, 
		cp.alter_train_no, cp.alter_money, cp.refund_12306_money
		FROM hc_orderinfo_cp cp 
		LEFT JOIN cp_orderinfo_bx bx ON cp.cp_id=bx.cp_id 
		LEFT JOIN hc_productinfo hp ON bx.product_id=hp.product_id 
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询退款明细 -->
	<select id="queryOutTicket_info" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT hm.order_id,hm.eop_order_id,hm.refund_money,DATE_FORMAT(hm.create_time,'%Y-%m-%d %H:%i:%s')AS create_time,
		hm.refund_time,hm.user_remark,hm.our_remark,
	    hm.refund_plan_time, hm.refund_status, hm.opt_person,hm.refund_type
		FROM hc_orderinfo_refundstream hm 
		WHERE order_id =#order_id# 
		ORDER BY create_time ASC
	</select>

	<!-- 更新预定退款为退款中-->
	<update id="updateRefundForRefunding"
		parameterClass="com.l9e.transaction.vo.RefundVo">
		UPDATE hc_orderinfo_refund
		<dynamic prepend="SET">
			<isNotEmpty prepend="," property="refund_memo">
				refund_memo=#refund_memo:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				refund_money =#refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_12306_seq">
				refund_12306_seq =#refund_12306_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_limit">
				<isEqual property="refund_limit" compareValue="15">
					refund_plan_time = DATE_ADD(now(),INTERVAL 15 DAY)
				</isEqual>
				<isEqual property="refund_limit" compareValue="1">
					refund_plan_time = DATE_ADD(now(),INTERVAL 5 MINUTE)
				</isEqual>
			</isNotEmpty>
		</dynamic>
		WHERE order_id=#order_id:VARCHAR#
	</update>

	<!--  更新预定单为退款中 -->
	<update id="updateOrderForRefunding"
		parameterClass="java.lang.String">

		UPDATE hc_orderinfo_refund set refund_status='66' WHERE
		order_id=#orderid:VARCHAR#

	</update>
	<update  id="updateRefund_memo" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refund hc SET hc.refund_memo=#refund_memo# WHERE hc.order_id=#order_id#
	</update>
	<!-- 更新操作人 -->
	<update id="updateEndOpt_Ren" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo
		<dynamic prepend="SET">
			<isNotEmpty  prepend="," property="opt_ren">
				 opt_ren=#opt_ren#
			</isNotEmpty>
		</dynamic>
		WHERE order_id = #order_id#
	</update>
	<!-- 省市联动 -->
	<!-- 查询全部省信息 -->
	<select id="getProvince"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=1 ORDER
		BY area_id ASC
	</select>

	<!-- 根据省id查询本省的所有市信息 -->
	<select id="getCity" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=2 AND
		area_parentno=#provinceid# ORDER BY area_id ASC
	</select>

	<!-- 根据市id查询本市的所有区信息 -->
	<select id="getArea" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area WHERE area_rank=3 AND
		area_parentno=#cityid# ORDER BY area_id ASC
	</select>
	
	<!-- 增加操作日志 -->
	<insert id="addUserAccount" parameterClass="java.util.HashMap">
		INSERT INTO hc_orderinfo_history (order_id,order_optlog,create_time,opter)
		VALUES(#order_id#,#userAccount#,NOW(),#user#)
	</insert>
	
	<!-- 拒绝退款操作 -->
	<update id="updateRefuseRefund_Agree" parameterClass="java.lang.String">
		UPDATE hc_orderinfo_refund hc SET hc.refund_status ='88' WHERE hc.order_id=#order_id#
	</update>
	<update id="updateRefuseOrder_Status" parameterClass="java.lang.String">
		UPDATE hc_orderinfo hc SET hc.order_status='44' WHERE hc.order_id=#order_id#
	</update>
	<!-- 取消预约操作 -->
	<update id="updateCancel_book_Status" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo hc SET hc.order_status='78',hc.opt_ren=#opt_ren# WHERE hc.order_id=#order_id#
	</update>
	
	
	<!-- 查询预订订单-历史记录 -->
	<select id="queryHistroyByOrderId" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT hs.history_id, hs.order_optlog,
		DATE_FORMAT(hs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		hs.opter
		FROM hc_orderinfo_history hs 
		WHERE hs.order_id=#order_id:VARCHAR#
		order by hs.create_time asc
	</select>
	
	<!-- 差额退款 -->
	<update id="updateDifferRefunding" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_differ hd SET hd.differ_status='11',
		hd.refund_money=#refund_money# ,hd.modfiy_time=NOW(),opt_person=#user#
	    WHERE hd.order_id=#order_id# AND hd.differ_status='00'
	</update>
	
	<select id="queryAllExcel" resultClass="java.util.HashMap">
		select * from hc_orderinfo limit 0,2
	</select>
	
	<select id="querySupervise_nameToArea_no" parameterClass="java.lang.String" 
		resultClass="java.util.HashMap">
		SELECT area_no,area_name FROM gen_area WHERE area_name=#area_name# AND area_rank='1'
	</select>
	
	<!-- 查询省市区id以及对应的name -->
	<select id="queryNoAndName" resultClass="java.util.HashMap">
		SELECT (b.area_no) AS pno, (b.area_name) AS pname, (c.area_no) AS cno,(c.area_name) AS cname, (c.qno) AS qno,(c.qname) AS qname 
		FROM gen_area b JOIN
		  (SELECT e.area_no, e.area_name, e.area_parentno, d.area_no AS qno, d.area_name AS qname, d.area_parentno AS qparentno 
		  FROM
		    (SELECT a.area_no, a.area_name, a.area_parentno FROM gen_area a WHERE a.area_rank = '2') AS e 
		    JOIN
		    (SELECT g.area_no, g.area_name, g.area_parentno FROM gen_area g WHERE g.area_rank = '3') AS d 
		   ON e.area_no = d.area_parentno) AS c 
		  ON b.area_no = c.area_parentno 
		WHERE b.area_rank = '1' 
	</select>
</sqlMap>