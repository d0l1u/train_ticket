<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="statToUserinfo">
	
	<select id="queryStatList" resultClass="java.util.HashMap">
		SELECT hcu.user_id,IFNULL(b.PAY_PRE_MONEY,0)AS pre_month_total, IFNULL(b.pay_pre_count,0) pay_pre_count, 
			IFNULL(a.PAY_NOW_MONEY,0)AS this_month_total, IFNULL(a.pay_now_count,0) pay_now_count, 
			IFNULL(c.pay_money,0)AS last_pay_money,DATE_FORMAT(c.last_create_timeInfo,'%Y-%m-%d %H:%i:%s')AS last_pay_time
		FROM hc_userinfo hcu 
		LEFT JOIN (SELECT SUM(hc.pay_money) AS PAY_NOW_MONEY, hc.dealer_id, COUNT(hc.order_id) AS pay_now_count 
				FROM hc_orderinfo AS hc 
				WHERE DATE_FORMAT(create_time,'%Y-%M')= DATE_FORMAT(NOW(),'%Y-%M') AND order_status IN('44','88') 
				GROUP BY hc.dealer_id)AS a ON a.dealer_id = hcu.user_id 
		LEFT JOIN (SELECT SUM(hc.pay_money)AS PAY_PRE_MONEY,hc.dealer_id, COUNT(hc.order_id) AS pay_pre_count 
				FROM hc_orderinfo AS hc 
				WHERE DATE_FORMAT(create_time,'%Y-%M')=DATE_FORMAT(DATE_SUB(CURDATE(),INTERVAL 1 MONTH),'%Y-%M') AND order_status IN('44','88') 
				GROUP BY hc.dealer_id)AS b ON b.dealer_id =hcu.user_id 
		LEFT JOIN (SELECT m.dealer_id,(m.create_time)AS create_timeInfo,(m.create_time)AS last_create_timeInfo,m.pay_money ,m.order_status 
				FROM hc_orderinfo m 
				WHERE NOT EXISTS
					(SELECT a.order_id FROM hc_orderinfo a 
				WHERE a.create_time>m.create_time AND a.dealer_id=m.dealer_id AND
				a.order_status = m.order_status )AND m.order_status IN('88','44')) AS c
			ON c.dealer_id=hcu.user_id 
			WHERE hcu.estate='33'
			ORDER BY last_pay_time DESC 
	</select>
	
	<!-- 用循环出来的user_id查询hc_userorder_tj表 返回一个user_id -->
	<select id="queryUser" parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT hc.user_id FROM hc_userorder_tj hc WHERE hc.user_id=#queryUser_id#
	</select>
	<!-- 如果查不到user_id 则把此user_id对应的list插入进去 -->
	<insert id="addUserStat" parameterClass="java.util.HashMap">
		INSERT INTO hc_userorder_tj 
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="user_id">
				 user_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="pre_month_total">
				pre_month_total
			</isNotEmpty>
			<isNotEmpty prepend="," property="this_month_total">
				this_month_total
			</isNotEmpty>
			
			<isNotEmpty prepend="," property="last_pay_money">
				last_pay_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="last_pay_time">
				last_pay_time
			</isNotEmpty>
			<isNotEmpty prepend=","  property="pay_pre_count">
				pay_pre_count
			</isNotEmpty>
			<isNotEmpty prepend=","  property="pay_now_count">
				pay_now_count
			</isNotEmpty>
				,modify_time

			)
		</dynamic>
		 values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="user_id">
				 #user_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pre_month_total">
				#pre_month_total:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="this_month_total">
				#this_month_total:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="last_pay_money">
				#last_pay_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="last_pay_time">
				#last_pay_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=","  property="pay_pre_count">
				#pay_pre_count:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend=","  property="pay_now_count">
				#pay_now_count:VARCHAR#
			</isNotEmpty>
				,now()
			
			)
		</dynamic>
	</insert>
	<!-- 待完成 -->
	<update id="updateUserStat" parameterClass="java.util.HashMap">
		UPDATE hc_userorder_tj 
		<dynamic prepend="set">
		<isNotEmpty prepend=","  property="user_id">
			user_id=#user_id#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="pre_month_total">
			pre_month_total=#pre_month_total#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="this_month_total">
			this_month_total=#this_month_total#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="last_pay_money">
			last_pay_money=#last_pay_money#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="last_pay_time">
			last_pay_time=#last_pay_time#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="pay_pre_count">
			pay_pre_count=#pay_pre_count#
		</isNotEmpty>
		<isNotEmpty prepend=","  property="pay_now_count">
			pay_now_count=#pay_now_count#
		</isNotEmpty>
			,modify_time =now() 
		</dynamic>
		
		WHERE user_id=#user_id#
	</update>
</sqlMap>