<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="account">
	
	<typeAlias alias="account" type="com.l9e.transaction.vo.AccountVo" />
	<!-- 查询账号条数 -->
	<select id="queryAccountListCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(1)  FROM cp_accountinfo a
				WHERE 1=1 and acc_status <![CDATA[<>]]>'99'
			<dynamic prepend="">
	           <isNotEqual compareValue="000000" property="at_province_id">
	           <isNotEmpty prepend=" and " property="at_province_id">
	              a.at_province_id=#at_province_id:VARCHAR#
	          </isNotEmpty>
	          </isNotEqual>
	          <!-- 
	          <isNotEqual compareValue="000000" property="at_province_id">
	          	<isNotEmpty prepend=" and " property="at_city_id">
	              	a.at_city_id=#at_city_id:VARCHAR#
	          	</isNotEmpty>
	          </isNotEqual>
	           -->
	          <isNotEmpty prepend=" and " property="acc_username">
	              a.acc_username=#acc_username:VARCHAR#
	          </isNotEmpty>
	             <isNotEmpty prepend=" and " property="acc_mail">
	              a.acc_mail=#acc_mail:VARCHAR#
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="channel">
	              a.channel in
	               <iterate open="(" close=")" conjunction="," property="channel">
		            	#channel[]:VARCHAR#
		      	  </iterate>
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="acc_status">
	         	  acc_status in
		          <iterate open="(" close=")" conjunction="," property="acc_status">
		            	#acc_status[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	   <isNotEmpty prepend=" and " property="account_source">
	         	  a.account_source in
		          <iterate open="(" close=")" conjunction="," property="account_source">
		            	#account_source[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	  <isNotEmpty prepend=" and " property="stop_reason">
	         	  a.stop_reason in
		          <iterate open="(" close=")" conjunction="," property="stop_reason">
		            	#stop_reason[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	   <isNotEmpty prepend=" and " property="contact_num">
	         	  a.contact_num in
		          <iterate open="(" close=")" conjunction="," property="contact_num">
		            	#contact_num[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	   <isNotEmpty prepend=" and " property="begin_info_time">
				a.create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="end_info_time">
				a.create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="active_time">
				a.active_time <![CDATA[>]]> DATE_ADD(NOW(),INTERVAL -15 MINUTE)
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_0">
				 is_alive IS NULL 
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_1">
				 is_alive = '1'
			  </isNotEmpty>
			 <isEqual property="mail_set" compareValue="-1">
				and (1=2
			   <isNotEmpty prepend=" or " property="mail_163">
				 a.acc_mail like '%@163.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_19trip">
				 a.acc_mail like '%@19trip.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_qita">
				( a.acc_mail not like '%@163.com%' and a.acc_mail not like '%@19trip.com%')
			  </isNotEmpty>)
			</isEqual>
	        </dynamic>
		
	</select>
	
	<!-- 查询账号信息 -->
	<select id="queryAccountList" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT a.acc_id, a.acc_name, a.acc_username, a.acc_password, a.acc_status, TIMESTAMPDIFF(day, a.option_time, now()) AS offdays,a.acc_mail,
				DATE_FORMAT(a.option_time,'%Y-%m-%d %H:%i:%s') AS option_time,a.contact_num,
				DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%s') AS create_time, cp.pwd,
				province.area_name as province_name, city.area_name city_name, a.order_id,a.channel,
				a.stop_reason,a.opt_person,a.account_source, a.priority
				 FROM cp_accountinfo a LEFT JOIN cp_orderinfo_mail cp ON cp.address = a.acc_mail  ,
				 gen_area province, gen_area city
				WHERE 1=1 and a.at_province_id=province.area_no and a.at_province_id=city.area_no
				 and acc_status <![CDATA[<>]]>'99'
			<dynamic prepend="">
			 <isNotEqual compareValue="000000" property="at_province_id">
	           <isNotEmpty prepend=" and " property="at_province_id">
	              a.at_province_id=#at_province_id:VARCHAR#
	          </isNotEmpty>
	          </isNotEqual>
	          <!-- 
	          <isNotEqual compareValue="000000" property="at_province_id">
	          	<isNotEmpty prepend=" and " property="at_city_id">
	              	a.at_city_id=#at_city_id:VARCHAR#
	          	</isNotEmpty>
	          </isNotEqual>
	           -->
	          <isNotEmpty prepend=" and " property="acc_username">
	              a.acc_username=#acc_username:VARCHAR#
	          </isNotEmpty>
	            <isNotEmpty prepend=" and " property="acc_mail">
	              a.acc_mail=#acc_mail:VARCHAR#
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="channel">
	              a.channel in
	               <iterate open="(" close=")" conjunction="," property="channel">
		            	#channel[]:VARCHAR#
		      	  </iterate>
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="acc_status">
	         	  a.acc_status in
		          <iterate open="(" close=")" conjunction="," property="acc_status">
		            	#acc_status[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	
	      	  <isNotEqual property="account_source" compareValue="-1">
				<isNotEmpty prepend=" and " property="account_source">
					a.account_source in
					<iterate open="(" close=")" conjunction=","
						property="account_source">
						#account_source[]:VARCHAR#
					</iterate>
				</isNotEmpty>
			</isNotEqual>
	      	 <isNotEmpty prepend=" and " property="stop_reason">
	         	  a.stop_reason in
		          <iterate open="(" close=")" conjunction="," property="stop_reason">
		            	#stop_reason[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	   <isNotEmpty prepend=" and " property="contact_num">
	         	  a.contact_num in
		          <iterate open="(" close=")" conjunction="," property="contact_num">
		            	#contact_num[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	    <isNotEmpty prepend=" and " property="begin_info_time">
				a.create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="end_info_time">
				a.create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="active_time">
				a.active_time <![CDATA[>]]> DATE_ADD(NOW(),INTERVAL -15 MINUTE)
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_0">
				 is_alive IS NULL 
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_1">
				 is_alive = '1'
			  </isNotEmpty>
			   <isEqual property="mail_set" compareValue="-1">
				and (1=2
			   <isNotEmpty prepend=" or " property="mail_163">
				 a.acc_mail like '%@163.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_19trip">
				 a.acc_mail like '%@19trip.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_qita">
				 ( a.acc_mail not like '%@163.com%'and a.acc_mail not like '%@19trip.com%')
			  </isNotEmpty>)
			</isEqual>
	        </dynamic>
	        ORDER BY a.option_time DESC
        LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询账号明细信息 --><!--
	<select id="queryAccount" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT a.acc_id, a.acc_name, a.acc_username, a.acc_password, a.acc_status,a.acc_mail,  
				DATE_FORMAT(a.option_time,'%Y-%m-%d %H:%i:%s') AS option_time,
				DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%s') AS create_time, 
				a.at_province_id, a.at_city_id, province.area_name as province_name, 
				city.area_name city_name,a.order_id,a.channel,a.real_name,a.id_card 
				 FROM cp_accountinfo a, gen_area province, gen_area city
				WHERE a.acc_id=#acc_id:VARCHAR# and a.at_province_id=province.area_no and a.at_province_id=city.area_no
	</select>
	
		-->
	<!-- 查询账号明细信息 -->
	<select id="queryAccount" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT a.acc_id, a.acc_name, a.acc_username, a.acc_password, a.acc_status,a.acc_mail,  
				DATE_FORMAT(a.option_time,'%Y-%m-%d %H:%i:%s') AS option_time,
				DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%s') AS create_time, 
				a.at_province_id, a.at_city_id
				 FROM cp_accountinfo a
				WHERE a.acc_id=#acc_id:VARCHAR#
	</select>
	
	
	<!-- 更新账号信息 -->
	<update id="updateAccount" parameterClass="com.l9e.transaction.vo.AccountVo">
		UPDATE cp_accountinfo
			<dynamic prepend="SET">
				<isNotEmpty prepend="," property="acc_status">
				 	acc_status=#acc_status:VARCHAR#
				</isNotEmpty>
				<isNotEmpty prepend="," property="acc_username">
					acc_username=#acc_username:VARCHAR#
				</isNotEmpty>
				<isNotEmpty prepend="," property="acc_password">
					acc_password=#acc_password:VARCHAR#
				</isNotEmpty>
				<isEqual prepend="," compareValue="33" property="acc_status">
					order_id =''
				</isEqual>
				<isNotEmpty prepend="," property="acc_status">
					option_time=now()
				</isNotEmpty>
				<isNotEmpty prepend="," property="channel">
					channel=#channel#
				</isNotEmpty>
				<isNotEmpty prepend="," property="opt_person">
					opt_person=#opt_person#
				</isNotEmpty>
				<isNotEmpty prepend="," property="acc_mail">
					acc_mail=#acc_mail#
				</isNotEmpty>
				<isNotEmpty prepend="," property="stop_reason">
					stop_reason=#stop_reason#
				</isNotEmpty>
				<isEqual prepend="," compareValue="1" property="stop_reason">
					stop_time=now()
				</isEqual>
				<isNotEmpty prepend="," property="real_name">
					real_name=#real_name#
				</isNotEmpty>
				<isNotEmpty prepend="," property="id_card">
					id_card=#id_card#
				</isNotEmpty>
			</dynamic>
			WHERE acc_id=#acc_id:VARCHAR#
	</update>
	
	<!-- 插入账号信息 -->
	<insert id="insertAccount" parameterClass="com.l9e.transaction.vo.AccountVo">
		insert into cp_accountinfo
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="acc_status">
				 acc_status
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_username">
				acc_username
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_password">
				acc_password
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_mail">
				acc_mail
			</isNotEmpty>
			<isNotEmpty prepend="," property="at_province_id">
				at_province_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="at_city_id">
				at_city_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_status">
				create_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="channel">
				channel
			</isNotEmpty>
			<isNotEmpty prepend="," property="real_name">
				real_name
			</isNotEmpty>
			<isNotEmpty prepend="," property="id_card">
				id_card
			</isNotEmpty>
			)
		</dynamic>
		 values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="acc_status">
				 #acc_status:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_username">
				 #acc_username:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_password">
				#acc_password:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_mail">
				#acc_mail:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="at_province_id">
				#at_province_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="at_city_id">
				#at_city_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="acc_status">
				now()
			</isNotEmpty>
			<isNotEmpty prepend="," property="channel">
				#channel#
			</isNotEmpty>
			<isNotEmpty prepend="," property="real_name">
				#real_name#
			</isNotEmpty>
			<isNotEmpty prepend="," property="id_card">
				#id_card#
			</isNotEmpty>
			)
		</dynamic>
	</insert>
	
	<!-- 查看用户名是否存在 -->
	<select id="queryAcc_username" parameterClass="java.lang.String" 
	resultClass="java.lang.String">
	SELECT hc.acc_username FROM cp_accountinfo hc 
	WHERE hc.acc_username = #acc_username#
	</select>
	
	<!-- 删除账号信息 -->
	<update id="deleteAccount" parameterClass="com.l9e.transaction.vo.AccountVo">		
		UPDATE cp_accountinfo
			<dynamic prepend="SET">
				<isNotEmpty prepend="," property="acc_status">
				 	acc_status=#acc_status:VARCHAR#
				</isNotEmpty>
				<isNotEmpty prepend="," property="acc_status">
					option_time=now()
				</isNotEmpty>
				<isNotEmpty prepend="," property="channel">
					channel=#channel#
				</isNotEmpty>
				<isNotEmpty prepend="," property="opt_person">
					opt_person=#opt_person#
				</isNotEmpty>
			</dynamic>
			WHERE acc_id=#acc_id:VARCHAR#
	</update>
	
	<!-- 省市联动 -->
	
	<!-- 查询全部省信息 -->
	<select id="getProvince" resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area 
		WHERE area_rank=1 ORDER BY area_id ASC
	</select>
	
	<!-- 根据省id查询本省的所有市信息 -->
	<select id="getCity" parameterClass="java.lang.String" 
	resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area 
		WHERE area_rank=2 AND area_parentno=#provinceid# ORDER BY area_id ASC
	</select>
	
	<!-- 根据市id查询本市的所有区信息 -->
	<select id="getArea"  parameterClass="java.lang.String" 
	resultClass="com.l9e.transaction.vo.AreaVo">
		SELECT area_no, area_name FROM gen_area  
		WHERE area_rank=3 AND area_parentno=#cityid# ORDER BY area_id ASC
	</select>
	
	<!-- 增加账号操作的日志 -->
	<insert id="insertAcc_logs" parameterClass="com.l9e.transaction.vo.AccountVo">
		insert into account_logs
		<dynamic prepend="(">
			create_time,
			<isNotEmpty prepend="," property="acc_username">
				acc_username
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_logs">
				opt_logs
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				opt_person
			</isNotEmpty>
			)
		</dynamic>
		 values
		<dynamic prepend="(">
			now(),
			<isNotEmpty prepend="," property="acc_username">
				#acc_username#
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_id">
				#order_id#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_logs">
				#opt_logs#
			</isNotEmpty>
			<isNotEmpty prepend="," property="opt_person">
				#opt_person#
			</isNotEmpty>
			)
		</dynamic>
	</insert>
	
	<!-- 查询hc_orderinfo_regist表中regist_status为注册成功的数据 -->
	<select id="queryRegisterList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">		
		SELECT zc.regist_id, zc.user_name,zc.ids_card, zc.account_name, zc.account_pwd, zc.mail,zc.account_source
		FROM hc_orderinfo_regist zc
		WHERE regist_status='22' 
		AND is_output='0'
		
		AND account_source=#account_source#
		AND account_name not in (select acc_username FROM cp_accountinfo )
		ORDER BY regist_id 
		LIMIT #register_num:Integer#
	</select>

	
	<!-- 将查询到的信息插入到cp_accountinfo表中 -->	
	<insert id="addAccounts" parameterClass="java.util.List">  
		insert into cp_accountinfo(real_name, id_card, at_province_id, acc_username, acc_password, acc_mail, channel, acc_status, opt_person, option_time, create_time,account_source) values 
		<iterate conjunction=","> 
			(#queryRegisters[].user_name#,
			#queryRegisters[].ids_card#,
			#queryRegisters[].at_province_id#,
			#queryRegisters[].account_name#, 
			#queryRegisters[].account_pwd#, 
			#queryRegisters[].mail#,
			#queryRegisters[].channel#,
			#queryRegisters[].acc_status#,
			#queryRegisters[].opt_person#,
			NOW(),
			NOW(),
			#queryRegisters[].account_source#)
		</iterate>  
	</insert>
	
	
	<!-- 批量启用 -->
	<update id="startAccounts" parameterClass="java.util.HashMap">
		 UPDATE 
		    cp_accountinfo 
		  SET
		    live_time = NOW(), is_alive = '1', acc_status = '33', channel = #channel# 
		  WHERE is_alive IS NULL 
		    AND account_source =  #account_source#
		    AND contact_num = 0 
		  LIMIT #register_num# 
	</update>
	
	<!-- 为hc_orderinfo_regist表中已转移的数据做标记 -->
	<update id="updateRegisters" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_regist SET
			channel=#channel:VARCHAR#,
			is_output='1'
			WHERE regist_id in
			<iterate property="registers" conjunction="," open="(" close=")">
				#registers[].regist_id#
			</iterate>
	</update>
	
	
	<!-- 开启停用原因为取消订单过多的账号 -->
	<update id="updateStopStatus">
		UPDATE cp_accountinfo 
		SET
			acc_status='33'
		WHERE
			acc_status='22' and stop_reason='2'
	</update>
	
	
	<!-- 批量停用 -->
	<update id="updateAbatchStop" parameterClass="account">
		UPDATE cp_accountinfo SET
		<!-- 	stop_reason=#stop_reason:VARCHAR#, -->
			acc_status = '22',
			stop_reason = #stop_reason#
			WHERE acc_id =#acc_id#
	</update>
	
	<!-- 导出excel -->
	<select id="queryAccountExcel" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT a.acc_id, a.acc_name, a.acc_username, a.acc_password, a.acc_status, TIMESTAMPDIFF(day, a.option_time, now()) AS offdays,a.acc_mail,
				DATE_FORMAT(a.option_time,'%Y-%m-%d %H:%i:%s') AS option_time,a.contact_num,
				DATE_FORMAT(a.create_time,'%Y-%m-%d %H:%i:%s') AS create_time, cp.pwd,
				province.area_name as province_name, city.area_name city_name, a.order_id,a.channel,
				a.stop_reason,a.opt_person,a.account_source, a.priority
				 FROM cp_accountinfo a LEFT JOIN cp_orderinfo_mail cp ON cp.address = a.acc_mail  ,
				 gen_area province, gen_area city
				WHERE 1=1 and a.at_province_id=province.area_no and a.at_province_id=city.area_no
				 and acc_status <![CDATA[<>]]>'99'
			<dynamic prepend="">
			 <isNotEqual compareValue="000000" property="at_province_id">
	           <isNotEmpty prepend=" and " property="at_province_id">
	              a.at_province_id=#at_province_id:VARCHAR#
	          </isNotEmpty>
	          </isNotEqual>
	          <isNotEmpty prepend=" and " property="acc_username">
	              a.acc_username=#acc_username:VARCHAR#
	          </isNotEmpty>
	            <isNotEmpty prepend=" and " property="acc_mail">
	              a.acc_mail=#acc_mail:VARCHAR#
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="channel">
	              a.channel in
	               <iterate open="(" close=")" conjunction="," property="channel">
		            	#channel[]:VARCHAR#
		      	  </iterate>
	          </isNotEmpty>
	          <isNotEmpty prepend=" and " property="acc_status">
	         	  a.acc_status in
		          <iterate open="(" close=")" conjunction="," property="acc_status">
		            	#acc_status[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	
	      	  <isNotEqual property="account_source" compareValue="-1">
				<isNotEmpty prepend=" and " property="account_source">
					a.account_source in
					<iterate open="(" close=")" conjunction=","
						property="account_source">
						#account_source[]:VARCHAR#
					</iterate>
				</isNotEmpty>
			</isNotEqual>
	      	 <isNotEmpty prepend=" and " property="stop_reason">
	         	  a.stop_reason in
		          <iterate open="(" close=")" conjunction="," property="stop_reason">
		            	#stop_reason[]:VARCHAR#
		      	  </iterate>
	      	  </isNotEmpty>
	      	    <isNotEmpty prepend=" and " property="begin_info_time">
				a.create_time <![CDATA[>=]]> #begin_info_time:VARCHAR#
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="end_info_time">
				a.create_time <![CDATA[<]]> DATE_ADD(#end_info_time:VARCHAR#,INTERVAL 1 DAY)
			  </isNotEmpty>
			  <isNotEmpty prepend=" and " property="active_time">
				a.active_time <![CDATA[>]]> DATE_ADD(NOW(),INTERVAL -15 MINUTE)
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_0">
				 is_alive IS NULL 
			  </isNotEmpty>
			   <isNotEmpty prepend=" and " property="is_alive_1">
				 is_alive = '1'
			  </isNotEmpty>
			   <isEqual property="mail_set" compareValue="-1">
				and (1=2
			   <isNotEmpty prepend=" or " property="mail_163">
				 a.acc_mail like '%@163.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_19trip">
				 a.acc_mail like '%@19trip.com%'
			  </isNotEmpty>
			   <isNotEmpty prepend=" or " property="mail_qita">
				 ( a.acc_mail not like '%@163.com%'and a.acc_mail not like '%@19trip.com%')
			  </isNotEmpty>)
			</isEqual>
	        </dynamic>
	        ORDER BY a.option_time DESC
	</select>
	
	
	
</sqlMap>