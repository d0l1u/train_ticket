<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="common">
	<!-- 查询系统配置 -->
	<select id="querySysSettingByKey" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT setting_value FROM train_system_setting 
		WHERE setting_name=#key:VARCHAR#
		LIMIT 0,1 
	</select>
	
	<!-- 获取机器人数量 -->
	<select id="queryHeyanWorkNum" parameterClass="java.lang.Integer"
		resultClass="java.lang.Integer">
		select count(1) 
		from cp_workerinfo where worker_type = #worker_type# and worker_status NOT IN ('22','33')
	</select>
	
	<!-- 查询qunar功能设定 -->
	<select id="queryQunarSystemSetting" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		select * from qunar_system_setting where setting_name=#setting_name:VARCHAR#
	</select>
	
	<!-- 查询elong功能设定 -->
	<select id="queryElongSystemSetting" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		select * from elong_system_setting where setting_name=#setting_name:VARCHAR#
	</select>
	
	<!-- 获取一个随机的机器人 -->
	<select id="queryRandomWorker" resultClass="com.l9e.transaction.vo.Worker">
		select worker_id as workerId, worker_name as workerName, worker_type as workerType,worker_ext as workerExt
		from cp_workerinfo where worker_type = #worker_type:INTEGER# and worker_status NOT IN ('22','33') order by worker_id limit #limit_num:INTEGER#,1
	</select>
	
	<!-- 获取待通知的机器人 -->
	<select id="queryWaitNotify" resultClass="java.util.HashMap">
		select warn_id,robot_name,content,telephone
		from robot_warning where 
		(warn_status='0' OR (warn_status='1' AND 
			DATE_ADD(notify_time, INTERVAL 3 MINUTE)<![CDATA[<=]]>NOW()))
			AND send_num <![CDATA[<]]>5
	</select>
	<!-- 更新通知状态 -->
	<update id="updateRobotStartNotify" parameterClass="java.util.HashMap">
		update robot_warning set 
		warn_status = #new_status:VARCHAR#,
		notify_time = NOW() 
		where warn_status=#old_status:VARCHAR# 
		AND warn_id = #warn_id:INTEGER#
	</update>
	
	<!-- 获取卡单的订单信息-->
	<select id="queryLockOrderList" resultClass="java.util.HashMap">
		select order_id,order_status,option_time
		FROM cp_orderinfo WHERE option_time <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL 12 MINUTE) 
		AND (order_status = '66' OR order_status = '11' OR order_status = '88' OR order_status = '83')
	</select>
	
	<!-- 更新状态 -->
	<update id="updateCpOrderStatus" parameterClass="java.util.HashMap">
		update cp_orderinfo set 
		<isNotEmpty property="error_info">
			error_info=#error_info:DECIMAL#,
		</isNotEmpty>
		<isNotEmpty property="opt_ren">
			opt_ren=#opt_ren:DECIMAL#,
		</isNotEmpty>
		order_status = #new_order_status:VARCHAR#,
		option_time = NOW() 
		where order_status=#order_status:VARCHAR# 
		AND order_id = #order_id:INTEGER#
	</update>
	
	<insert id="addCpOrderHistory" parameterClass="java.util.HashMap">
		INSERT INTO cp_orderinfo_history (order_id,order_optlog,create_time,opter)
		VALUES(#order_id#,#order_optlog#,NOW(),#opter#)
	</insert>
	
	<!-- 更新出票成功通知状态 -->
	<update id="updateCpOrderNotify" parameterClass="java.util.HashMap">
		update cp_orderinfo_notify set notify_status = '1', 
		notify_num=0, notify_next_time=DATE_ADD(now(), interval 20 second), modify_time=now() 
		where order_id= #order_id:VARCHAR#
	</update>
	
	<!-- 获取改签卡单的订单信息-->
	<select id="queryLockAlterOrderList" resultClass="java.util.HashMap">
		select order_id,cp_id,refund_status,option_time,'qunar' 
		FROM qunar_orderinfo_refund WHERE option_time <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL 8 MINUTE) 
		AND (refund_status = '02' OR refund_status = '06')
		UNION ALL 
		SELECT order_id,cp_id,refund_status,option_time,'19e'  
		FROM hc_orderinfo_refundstream WHERE option_time <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL 8 MINUTE) 
		AND (refund_status = '02' OR refund_status = '06')
		UNION ALL 
		SELECT order_id,cp_id,refund_status,option_time,'elong'  
		FROM elong_orderinfo_refundstream WHERE option_time <![CDATA[<]]> DATE_SUB(NOW(), INTERVAL 8 MINUTE) 
		AND (refund_status = '02' OR refund_status = '06')
	</select>
	
	<!-- 更新状态 -->
	<update id="updateQunarRefundOrderStatus" parameterClass="java.util.HashMap">
		update qunar_orderinfo_refund set 
		refund_status = #new_refund_status:VARCHAR#,
		option_time = NOW() 
		where refund_status=#refund_status:VARCHAR# 
		AND order_id = #order_id:INTEGER#
	</update>
	
	<!-- 更新状态 -->
	<update id="update19eRefundOrderStatus" parameterClass="java.util.HashMap">
		update hc_orderinfo_refundstream set 
		refund_status = #new_refund_status:VARCHAR#,
		option_time = NOW() 
		where refund_status=#refund_status:VARCHAR# 
		AND order_id = #order_id:VARCHAR#
		<isNotEmpty prepend="AND" property="cp_id">
			cp_id = #cp_id:VARCHAR#
		</isNotEmpty>
	</update>
	
	<!-- 更新状态 -->
	<update id="updateElongRefundOrderStatus" parameterClass="java.util.HashMap">
		update elong_orderinfo_refundstream set 
		refund_status = #new_refund_status:VARCHAR#,
		option_time = NOW() 
		where refund_status=#refund_status:VARCHAR# 
		AND order_id = #order_id:VARCHAR# 
		<isNotEmpty prepend="AND" property="cp_id">
			cp_id = #cp_id:VARCHAR#
		</isNotEmpty>
		
	</update>
	
	<!-- 获取需要发短信的svip-->
	<select id="queryPinganMessageList" resultClass="java.lang.String">
		select order_id,order_status,option_time
		FROM cp_orderinfo_bx_test WHERE bx_status='2' and bx_channel = '3'
	</select>
	
	<!-- 获取待恢复空闲的帐号 -->
	<select id="queryAccountSeatList" resultClass="java.util.HashMap">
		select CONVERT(acc_id,CHAR) acc_id,option_time 
		FROM cp_accountinfo WHERE acc_status=#acc_status:VARCHAR# and option_time <![CDATA[<]]> #option_time:VARCHAR# 
	</select>
	
	<!-- 更新状态 -->
	<update id="updateAccountStatusFree" parameterClass="java.lang.String">
		update cp_accountinfo set 
		acc_status = '33',
		option_time = NOW() 
		where acc_id = #acc_id:INTEGER#
	</update>
	<!-- 去哪儿【系统设定】增加定时器功能-->
	<update id="updateQunarSysNoticeStaus" parameterClass="java.util.HashMap">
		update qunar_system_setting set 
		setting_value = #setting_value:VARCHAR#
		where setting_name=#setting_name:VARCHAR# 
	</update>
	
	<!-- 先获取，订票流程为先预定后支付的对外商户信息  -->
	<select id="queryExtMerchantList" resultClass="java.util.HashMap">
		select CONVERT(book_limit_time,CHAR) book_limit_time,merchant_id  
		FROM ext_merchantinfo WHERE pay_type='33' 
	</select>
	
	<!-- 获取超时未支付订单  -->
	<select id="queryLockBookOrder" resultClass="java.lang.String">
		select order_id  
		FROM cp_orderinfo 
		WHERE order_status = #order_status:VARCHAR# AND is_pay = "11" 
		AND out_ticket_time <![CDATA[<]]> DATE_SUB(NOW(),INTERVAL #book_limit_time:INTEGER# MINUTE); 
	</select>
	
	
	<!-- 更新状态 开始发送通知给前台 -->
	<update id="updateCpOrderinfoNotify" parameterClass="java.util.HashMap">
		update cp_orderinfo_notify set 
		notify_status = #notify_status:VARCHAR#,
		notify_num=0,
		notify_next_time=DATE_ADD(now(), interval 20 second),
		modify_time=now()
		where order_id = #order_id:VARCHAR#
	</update>
	
	<!-- 添加日志 -->
	<insert id="insertCpHistory" parameterClass="java.util.HashMap">
		insert into cp_orderinfo_history(order_id,order_optlog,opter,create_time) 
		values(#order_id:VARCHAR#,#order_optlog:VARCHAR#,#opter:VARCHAR#,now())
	</insert>
	
	<!-- 艺龙【系统设定】增加定时器功能-->
	<update id="updateElongSysNoticeStaus" parameterClass="java.util.HashMap">
		update elong_system_setting set 
		setting_value = #setting_value:VARCHAR#
		where setting_name=#setting_name:VARCHAR# 
	</update>
	
	<!-- 更新支付宝余额 -->
	<update id="updateBalance" parameterClass="java.util.HashMap">
		update cp_cardinfo set card_remain=#card_remain:VARCHAR#,create_time = NOW() where card_no=#card_no:VARCHAR#
	</update>
</sqlMap>