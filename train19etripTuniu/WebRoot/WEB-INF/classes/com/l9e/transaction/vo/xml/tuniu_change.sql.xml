<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="change">
	<!--查询改签信息 -->
	<select id="selectChangeInfoByParam" parameterClass="Map" resultClass="com.l9e.transaction.vo.TuniuChangeInfo">
			select 
			change_id,order_id, create_time,old_ticket_change_serial,new_ticket_change_serial,
			ticket_price_diff_change_serial,change_diff_money,change_refund_money,change_receive_money,
			book_ticket_time,fail_reason,train_no,change_train_no, from_time, change_from_time,
			travel_time,change_travel_time,from_city,to_city,out_ticket_billno,account_id,
			change_status,isasync,callbackurl,reqtoken,change_notify_status,
			change_notify_count, change_notify_time,change_notify_finish_time,
			from_station_code,to_station_code,option_time
		FROM elong_orderinfo_change
		<dynamic prepend="WHERE"> 
			<isNotEmpty property="reqtoken" prepend="AND">
				reqtoken = #reqtoken:VARCHAR#
			</isNotEmpty>
			<isNotEmpty property="change_id" prepend="AND">
				change_id = #change_id#
			</isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询改签车票信息 -->
	<select id="selectChangeCp" resultClass="com.l9e.transaction.vo.TuniuChangePassengerInfo" parameterClass="java.util.HashMap" >
		SELECT
			cp_id,
			new_cp_id,
			order_id,
			change_id,
			CONCAT(buy_money, '') buy_money,
			CONCAT(change_buy_money, '') change_buy_money,
			seat_type,
			change_seat_type,
			ticket_type,
			train_box,
			change_train_box,
			seat_no,
			change_seat_no,
			ids_type,
			user_ids,
			user_name,
			DATE_FORMAT(create_time,'%Y-%m-%d %H:%i:%s') create_time,
			is_changed,
			tn_seat_type,
			tn_ticket_type,
			tn_change_seat_type,
			tn_ids_type
		FROM elong_change_cp
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="cp_id">
				cp_id = #cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="new_cp_id">
				new_cp_id = #new_cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="order_id">
				order_id = #order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="change_id">
				change_id = #change_id:INTEGER#
			</isNotEmpty>
		</dynamic>
	</select>

	<!-- 改签 -->
	<!-- 插入改签记录 -->
	<insert id="insertChangeInfo" parameterClass="com.l9e.transaction.vo.TuniuChangeInfo">
		INSERT INTO elong_orderinfo_change
		<dynamic prepend="(">
			<isNotEmpty property="order_id">
				order_id,
			</isNotEmpty>
			<isNotEmpty property="isasync">
				isasync,
			</isNotEmpty>
			<isNotEmpty property="callbackurl">
				callbackurl,
			</isNotEmpty>
			<isNotEmpty property="reqtoken">
				reqtoken,
			</isNotEmpty>
			<isNotEmpty property="old_ticket_change_serial">
				old_ticket_change_serial,
			</isNotEmpty>
			<isNotEmpty property="new_ticket_change_serial">
				new_ticket_change_serial,
			</isNotEmpty>
			<isNotEmpty property="ticket_price_diff_change_serial">
				ticket_price_diff_change_serial,
			</isNotEmpty>
			<isNotEmpty property="change_diff_money">
				change_diff_money,
			</isNotEmpty>
			<isNotEmpty property="change_refund_money">
				change_refund_money,
			</isNotEmpty>
			<isNotEmpty property="change_receive_money">
				change_receive_money,
			</isNotEmpty>
			<isNotEmpty property="book_ticket_time">
				book_ticket_time,
			</isNotEmpty>
			<isNotEmpty property="fail_reason">
				fail_reason,
			</isNotEmpty>
			<isNotEmpty property="train_no">
				train_no,
			</isNotEmpty>
			<isNotEmpty property="change_train_no">
				change_train_no,
			</isNotEmpty>
			<isNotEmpty property="from_time">
				from_time,
			</isNotEmpty>
			<isNotEmpty property="change_from_time">
				change_from_time,
			</isNotEmpty>
			<isNotEmpty property="travel_time">
				travel_time,
			</isNotEmpty>
			<isNotEmpty property="change_travel_time">
				change_travel_time,
			</isNotEmpty>
			<isNotEmpty property="from_city">
				from_city,
			</isNotEmpty>
			<isNotEmpty property="to_city">
				to_city,
			</isNotEmpty>
			<isNotEmpty property="out_ticket_billno">
				out_ticket_billno,
			</isNotEmpty>
			<isNotEmpty property="account_id">
				account_id,
			</isNotEmpty>
			<isNotEmpty property="change_status">
				change_status,
			</isNotEmpty>
			<isNotEmpty property="change_notify_status">
				change_notify_status,
			</isNotEmpty>
			<isNotEmpty property="change_notify_time">
				change_notify_time,
			</isNotEmpty>
			<isNotEmpty property="change_notify_finish_time">
				change_notify_finish_time,
			</isNotEmpty>
			<isNotEmpty property="change_notify_count">
				change_notify_count,
			</isNotEmpty>
			<isNotEmpty property="to_station_code">
				to_station_code,
			</isNotEmpty>
			<isNotEmpty property="from_station_code">
				from_station_code,
			</isNotEmpty>
			<isNotEmpty property="ischangeto">
				ischangeto,
			</isNotEmpty>
			<isNotEmpty property="merchant_id">
				merchant_id,
			</isNotEmpty>
			<isNotEmpty property="hasSeat">
				hasSeat,
			</isNotEmpty>
			<isNotEmpty property="isChooseSeats">
				isChooseSeats,
			</isNotEmpty>
			<isNotEmpty property="chooseSeats">
				chooseSeats,
			</isNotEmpty>
			create_time
			)
		</dynamic>
		VALUES
		<dynamic prepend="(">
			<isNotEmpty property="order_id">
				#order_id:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="isasync">
				#isasync:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="callbackurl">
				#callbackurl:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="reqtoken">
				#reqtoken:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="old_ticket_change_serial">
				#old_ticket_change_serial:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="new_ticket_change_serial">
				#new_ticket_change_serial:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="ticket_price_diff_change_serial">
				#ticket_price_diff_change_serial:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_diff_money">
				#change_diff_money:DECIMAL#,
			</isNotEmpty>
			<isNotEmpty property="change_refund_money">
				#change_refund_money:DECIMAL#,
			</isNotEmpty>
			<isNotEmpty property="change_receive_money">
				#change_receive_money:DECIMAL#,
			</isNotEmpty>
			<isNotEmpty property="book_ticket_time">
				#book_ticket_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="fail_reason">
				#fail_reason:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="train_no">
				#train_no:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_train_no">
				#change_train_no:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="from_time">
				#from_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="change_from_time">
				#change_from_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="travel_time">
				#travel_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="change_travel_time">
				#change_travel_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="from_city">
				#from_city:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="to_city">
				#to_city:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="out_ticket_billno">
				#out_ticket_billno:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="account_id">
				#account_id:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_status">
				#change_status:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_notify_status">
				#change_notify_status:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_notify_time">
				#change_notify_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="change_notify_finish_time">
				#change_notify_finish_time:DATETIME#,
			</isNotEmpty>
			<isNotEmpty property="change_notify_count">
				#change_notify_count:INTEGER#,
			</isNotEmpty>
			<isNotEmpty property="to_station_code">
				#to_station_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="from_station_code">
				#from_station_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="ischangeto">
				#ischangeto#,
			</isNotEmpty>
			<isNotEmpty property="merchant_id">
				#merchant_id#,
			</isNotEmpty>
			<isNotEmpty property="hasSeat">
				#hasSeat#,
			</isNotEmpty>
			<isNotEmpty property="isChooseSeats">
				#isChooseSeats:TINYINT#,
			</isNotEmpty>
			<isNotEmpty property="chooseSeats">
				#chooseSeats:VARCHAR#,
			</isNotEmpty>
			NOW()
			)
		</dynamic>
		<selectKey keyProperty="change_id" resultClass="java.lang.Integer" type="post">
			SELECT LAST_INSERT_ID() AS change_id
		</selectKey>		
	</insert>
	<!-- 插入改签车票信息 -->
	<insert id="insertChangePassenger" parameterClass="com.l9e.transaction.vo.TuniuChangePassengerInfo" >
		INSERT INTO elong_change_cp
		<dynamic prepend="(">
			<isNotEmpty property="cp_id">
				cp_id,
			</isNotEmpty>
			<isNotEmpty property="new_cp_id">
				new_cp_id,
			</isNotEmpty>
			<isNotEmpty property="order_id">
				order_id,
			</isNotEmpty>
			<isNotEmpty property="change_id">
				change_id,
			</isNotEmpty>
			<isNotEmpty property="buy_money">
				buy_money,
			</isNotEmpty>
			<isNotEmpty property="seat_type">
				seat_type,
			</isNotEmpty>
			<isNotEmpty property="change_seat_type">
				change_seat_type,
			</isNotEmpty>
			<isNotEmpty property="ticket_type">
				ticket_type,
			</isNotEmpty>
			<isNotEmpty property="train_box">
				train_box,
			</isNotEmpty>
			<isNotEmpty property="seat_no">
				seat_no,
			</isNotEmpty>
			<isNotEmpty property="ids_type">
				ids_type,
			</isNotEmpty>
			<isNotEmpty property="user_ids">
				user_ids,
			</isNotEmpty>
			<isNotEmpty property="user_name">
				user_name,
			</isNotEmpty>
			<isNotEmpty property="is_changed">
				is_changed,
			</isNotEmpty>
			<isNotEmpty property="tn_seat_type">
				tn_seat_type,
			</isNotEmpty>
			<isNotEmpty property="tn_ticket_type">
				tn_ticket_type,
			</isNotEmpty>
			<isNotEmpty property="tn_change_seat_type">
				tn_change_seat_type,
			</isNotEmpty>
			<isNotEmpty property="tn_ids_type">
				tn_ids_type,
			</isNotEmpty>
			create_time
			)
		</dynamic>
		VALUES
		<dynamic prepend="(">
			<isNotEmpty property="cp_id">
				#cp_id:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="new_cp_id">
				#new_cp_id:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="order_id">
				#order_id:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_id">
				#change_id:INTEGER#,
			</isNotEmpty>
			<isNotEmpty property="buy_money">
				#buy_money:DECIMAL#,
			</isNotEmpty>
			<isNotEmpty property="seat_type">
				#seat_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="change_seat_type">
				#change_seat_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="ticket_type">
				#ticket_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="train_box">
				#train_box:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="seat_no">
				#seat_no:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="ids_type">
				#ids_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="user_ids">
				#user_ids:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="user_name">
				#user_name:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="is_changed">
				#is_changed:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="tn_seat_type">
				#tn_seat_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="tn_ticket_type">
				#tn_ticket_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="tn_change_seat_type">
				#tn_change_seat_type:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="tn_ids_type">
				#tn_ids_type:VARCHAR#,
			</isNotEmpty>
			NOW()
			)
		</dynamic>
		ON DUPLICATE KEY UPDATE
		create_time = NOW()
		<dynamic>
			<isNotEmpty property="change_id">
				,change_id = #change_id:INTEGER#
			</isNotEmpty>
			<isNotEmpty property="change_seat_type">
				,change_seat_type = #change_seat_type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty property="tn_change_seat_type">
				,tn_change_seat_type = #tn_change_seat_type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty property="is_changed">
				,is_changed = #is_changed:VARCHAR#
			</isNotEmpty>
			<isNotEmpty property="new_cp_id">
				,new_cp_id = #new_cp_id:VARCHAR#
			</isNotEmpty>
		</dynamic>
	</insert>
	<!-- 增加改签日志 -->
	<insert id="insertChangeLog" parameterClass="com.l9e.transaction.vo.TuniuChangeLogVO">
		INSERT INTO elong_change_logs
		(
			order_id
		<dynamic>
			<isNotEmpty property="change_id">
				,change_id
			</isNotEmpty>
			<isNotEmpty property="content">
				,content
			</isNotEmpty>
			<isNotEmpty property="opt_person">
				,opt_person
			</isNotEmpty>
		</dynamic>
		,create_time
		)
		VALUES
		(
			#order_id:VARCHAR#
			<dynamic>
				<isNotEmpty property="change_id">
				,#change_id:INTEGER#
			</isNotEmpty>
			<isNotEmpty property="content">
				,#content:VARCHAR#
			</isNotEmpty>
			<isNotEmpty property="opt_person">
				,#opt_person:VARCHAR#
			</isNotEmpty>
			</dynamic>
			,NOW()
		)
	</insert>
	
	<!-- 改签异步通知 -->
	<!-- 回调列表 -->
	<select id="selectNotifyList" resultClass="com.l9e.transaction.vo.TuniuChangeInfo" parameterClass="String">
		SELECT 
			change_id,
			order_id,
			DATE_FORMAT(create_time,'%Y-%m-%d %H:%i:%s') create_time,
			old_ticket_change_serial,
			new_ticket_change_serial,
			ticket_price_diff_change_serial,
			CONCAT(change_diff_money, '') change_diff_money,
			CONCAT(change_refund_money, '') change_refund_money,
			CONCAT(change_receive_money, '') change_receive_money,
			DATE_FORMAT(book_ticket_time,'%Y-%m-%d %H:%i:%s') book_ticket_time,
			fail_reason,
			train_no,
			change_train_no,
			DATE_FORMAT(from_time,'%Y-%m-%d %H:%i:%s') from_time,
			DATE_FORMAT(change_from_time,'%Y-%m-%d %H:%i:%s') change_from_time,
			DATE_FORMAT(change_to_time,'%Y-%m-%d %H:%i:%s') change_to_time,
			DATE_FORMAT(travel_time,'%Y-%m-%d %H:%i:%s') travel_time,
			DATE_FORMAT(change_travel_time,'%Y-%m-%d %H:%i:%s') change_travel_time,
			from_city,
			to_city,
			out_ticket_billno,
			account_id,
			change_status,
			isasync,
			callbackurl,
			reqtoken,
			change_notify_status,
			change_notify_count,
			DATE_FORMAT(change_notify_time,'%Y-%m-%d %H:%i:%s') change_notify_time,
			DATE_FORMAT(change_notify_finish_time,'%Y-%m-%d %H:%i:%s') change_notify_finish_time,
			DATE_FORMAT(pay_limit_time,'%Y-%m-%d %H:%i:%s') pay_limit_time,
			from_station_code,to_station_code
		FROM elong_orderinfo_change
		WHERE (change_notify_status = '000' OR (change_notify_status = '111' AND change_notify_time <![CDATA[<=]]> DATE_SUB(NOW(),INTERVAL 1.5 MINUTE)))
		AND change_notify_count <![CDATA[<]]> 10
		AND change_status IN ('14','15','23','24','34','35')
		and merchant_id=#merchantId:VARCHAR#
		and callbackurl  like 'http://api%'
		ORDER BY create_time DESC
		LIMIT 0,15
	</select>
	
	<!-- 更新改签记录 -->
	<update id="updateChangeInfo" parameterClass="com.l9e.transaction.vo.TuniuChangeInfo">
		UPDATE elong_orderinfo_change
		<dynamic prepend="set">
			<isNotEmpty prepend="," property="old_ticket_change_serial">
				old_ticket_change_serial = #old_ticket_change_serial:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="new_ticket_change_serial">
				new_ticket_change_serial = #new_ticket_change_serial:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ticket_price_diff_change_serial">
				ticket_price_diff_change_serial = #ticket_price_diff_change_serial:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_diff_money">
				change_diff_money = #change_diff_money:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_refund_money">
				change_refund_money = #change_refund_money:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_receive_money">
				change_receive_money = #change_receive_money:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_status">
				change_status = #change_status:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="callbackurl">
				callbackurl = #callbackurl:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_notify_status">
				change_notify_status = #change_notify_status:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_notify_count">
				change_notify_count = #change_notify_count:INTEGER#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_notify_time">
				change_notify_time = #change_notify_time:DATETIME#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_notify_finish_time">
				change_notify_finish_time = #change_notify_finish_time:DATETIME#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fee">
				fee = #fee:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="totalpricediff">
				totalpricediff = #totalpricediff:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="diffrate">
				diffrate = #diffrate:DECIMAL#
			</isNotEmpty>
			<isNotEmpty prepend="," property="change_from_time">
				change_from_time = #change_from_time#
			</isNotEmpty>
		</dynamic>
		WHERE change_id = #change_id:INTEGER#
	</update>

	<!-- 更新改签车票信息 -->
	<update id="updateChangeCp" parameterClass="com.l9e.transaction.vo.TuniuChangePassengerInfo">
		UPDATE elong_change_cp
		set is_changed = #is_changed:VARCHAR#
		WHERE cp_id = #cp_id:VARCHAR#
	</update>

</sqlMap>