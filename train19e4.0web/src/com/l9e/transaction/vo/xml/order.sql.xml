<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="order">

	<!-- 订单 -->
	<insert id="addOrderInfo" parameterClass="com.l9e.transaction.vo.OrderInfo">
		insert into hc_orderinfo
		<dynamic prepend="(">
			order_id,
			<isNotNull prepend="," property="order_name">
				order_name
			</isNotNull>
			<isNotNull prepend="," property="at_province_id">
				at_province_id
			</isNotNull>
			<isNotNull prepend="," property="at_city_id">
				at_city_id
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="user_pay_money">
				user_pay_money
			</isNotNull>
			<isNotNull prepend="," property="ticket_pay_money">
				ticket_pay_money
			</isNotNull>
			<isNotNull prepend="," property="bx_pay_money">
				bx_pay_money
			</isNotNull>
			<isNotNull prepend="," property="server_pay_money">
				server_pay_money
			</isNotNull>
			<isNotNull prepend="," property="ps_pay_money">
				ps_pay_money
			</isNotNull>
			<isNotNull prepend="," property="out_ticket_type">
				out_ticket_type
			</isNotNull>			
			<isNotNull prepend="," property="order_status">
				order_status
			</isNotNull>
				,create_time
			<isNotNull prepend="," property="dealer_name">
				dealer_name
			</isNotNull>
			<isNotNull prepend="," property="dealer_id">
				dealer_id
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				train_no
			</isNotNull>
			<isNotNull prepend="," property="from_city">
				from_city
			</isNotNull>
			<isNotNull prepend="," property="to_city">
				to_city
			</isNotNull>
			<isNotNull prepend="," property="from_time">
				from_time
			</isNotNull>
			<isNotNull prepend="," property="to_time">
				to_time
			</isNotNull>
			<isNotNull prepend="," property="travel_time">
				travel_time
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				seat_type
			</isNotNull>
			<isNotNull prepend="," property="ext_seat">
				ext_seat
			</isNotNull>
			<isNotNull prepend="," property="ticket_num">
				ticket_num
			</isNotNull>
			<isNotNull prepend="," property="ticket_ps_type">
				ticket_ps_type
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#order_id:VARCHAR#,
			<isNotNull prepend="," property="order_name">
				#order_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="at_province_id">
				#at_province_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="at_city_id">
				#at_city_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="user_pay_money">
				#user_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="ticket_pay_money">
				#ticket_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="bx_pay_money">
				#bx_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="server_pay_money">
				#server_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="ps_pay_money">
				#ps_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="out_ticket_type">
				#out_ticket_type:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="order_status">
				#order_status:VARCHAR#
			</isNotNull>
				,NOW()
			<isNotNull prepend="," property="dealer_name">
				#dealer_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="dealer_id">
				#dealer_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				#train_no:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="from_city">
				#from_city:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="to_city">
				#to_city:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="from_time">
				STR_TO_DATE(#from_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="to_time">
				STR_TO_DATE(#to_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="travel_time">
				STR_TO_DATE(#travel_time:VARCHAR#,'%Y-%m-%d')
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				#seat_type:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="ext_seat">
				#ext_seat:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ticket_num">
				#ticket_num:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="ticket_ps_type">
				#ticket_ps_type:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 车票 -->
	<insert id="addOrderInfoCp" parameterClass="com.l9e.transaction.vo.OrderInfoCp">
		insert into hc_orderinfo_cp
		<dynamic prepend="(">
			cp_id,
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				user_name
			</isNotNull>
			<isNotNull prepend="," property="ticket_type">
				ticket_type
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				ids_type
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				user_ids
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				telephone
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				seat_type
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#cp_id:VARCHAR#,
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ticket_type">
				#ticket_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				#ids_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				#user_ids:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				#telephone:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				#seat_type:DECIMAL#
			</isNotNull>
			
			)
		</dynamic>
	</insert>
	
	<!-- 保险 -->
	<insert id="addOrderInfoBx" parameterClass="com.l9e.transaction.vo.OrderInfoBx">
		insert into cp_orderinfo_bx
		<dynamic prepend="(">
			bx_id,order_channel,
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				cp_id
			</isNotNull>
			<isNotNull prepend="," property="from_name">
				from_name
			</isNotNull>
			<isNotNull prepend="," property="to_name">
				to_name
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				ids_type
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				user_name
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				user_ids
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="bx_status">
				bx_status
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="product_id">
				product_id
			</isNotNull>
			<isNotNull prepend="," property="effect_date">
				effect_date
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				train_no
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				telephone
			</isNotNull>
			<isNotNull prepend="," property="bx_channel">
				bx_channel
			</isNotNull>
			<isNotNull prepend="," property="bx_type">
				bx_type
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#bx_id:VARCHAR#,'19e',
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="from_name">
				#from_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="to_name">
				#to_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				#ids_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				#user_ids:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="bx_status">
				#bx_status:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="product_id">
				#product_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="effect_date">
				#effect_date:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				#train_no:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				#telephone:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="bx_channel">
				#bx_channel:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="bx_type">
				#bx_type:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 配送 -->
	<insert id="addOrderInfoPs" parameterClass="com.l9e.transaction.vo.OrderInfoPs">
		insert into cp_orderinfo_ps
		<dynamic prepend="(">
			order_id,
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="buy_money">
				buy_money
			</isNotNull>
			<isNotNull prepend="," property="ps_status">
				ps_status
			</isNotNull>
				,create_time
			<isNotNull prepend="," property="link_name">
				link_name
			</isNotNull>
			<isNotNull prepend="," property="link_phone">
				link_phone
			</isNotNull>
			<isNotNull prepend="," property="link_address">
				link_address
			</isNotNull>
			<isNotNull prepend="," property="link_mail">
				link_mail
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#order_id:VARCHAR#,
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="buy_money">
				#buy_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="ps_status">
				#ps_status:VARCHAR#
			</isNotNull>
				,NOW()
			<isNotNull prepend="," property="link_name">
				#link_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="link_phone">
				#link_phone:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="link_address">
				#link_address:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="link_mail">
				#link_mail:DECIMAL#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 根据订单号查询订单信息 -->
	<select id="queryOrderInfo" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.OrderInfo">
		SELECT hc.order_id,hc.order_status,hc.train_no,hc.from_city,hc.to_city,DATE_FORMAT(hc.from_time,'%H:%i') AS from_time,cp.pay_money cp_pay_money,
			DATE_FORMAT(hc.to_time,'%H:%i') AS to_time,DATE_FORMAT(hc.travel_time,'%Y-%m-%d') AS travel_time,hc.out_ticket_billno,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
			(hc.from_time <![CDATA[>]]>NOW() AND DATE_ADD(hc.from_time, INTERVAL -#refund_before_time:INTEGER# HOUR) <![CDATA[<]]>NOW()) AS is_before,
			DATE_ADD(hc.from_time, INTERVAL #refund_time:INTEGER# HOUR)<![CDATA[<]]> NOW() AS is_deadline,
			CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') AS is_repay,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
			hc.seat_type,hc.ticket_pay_money,hc.bx_pay_money,hc.server_pay_money,hc.user_pay_money,
			hc.ps_pay_money,hc.pay_money,hc.buy_money,hc.out_ticket_type,
			hc.can_refund,hc.ext_seat,hc.dealer_id ,cp.user_name,cp.ticket_type,cp.ids_type,cp.user_ids,cp.telephone,cp.train_box,cp.seat_no
			FROM hc_orderinfo hc
			LEFT JOIN hc_orderinfo_cp cp ON cp.order_id=hc.order_id
		WHERE hc.order_id=#order_id:VARCHAR# LIMIT 0,1
	</select>
	
	<!-- 根据订单号查询订单信息 (最新)-->
	<select id="queryOrderInfo2" parameterClass="java.util.HashMap"
		resultClass="com.l9e.transaction.vo.OrderInfo">
		SELECT hc.order_id,hc.order_status,hc.train_no,hc.from_city,hc.to_city,DATE_FORMAT(hc.from_time,'%H:%i') AS from_time,cp.pay_money cp_pay_money,
			DATE_FORMAT(hc.to_time,'%H:%i') AS to_time,DATE_FORMAT(hc.travel_time,'%Y-%m-%d') AS travel_time,hc.out_ticket_billno,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
			(hc.from_time <![CDATA[>]]>NOW() AND DATE_ADD(hc.from_time, INTERVAL -#refund_before_time:INTEGER# HOUR) <![CDATA[<]]>NOW()) AS is_before,
			DATE_ADD(hc.from_time, INTERVAL #refund_time:INTEGER# HOUR)<![CDATA[<]]> NOW() AS is_deadline,
			CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') AS is_repay,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
			hc.seat_type,hc.ticket_pay_money,hc.bx_pay_money,hc.server_pay_money,hc.user_pay_money,
			hc.ps_pay_money,hc.pay_money,hc.buy_money,hc.out_ticket_type,hc.ticket_ps_type,
			hc.can_refund,hc.ext_seat,hc.dealer_id ,cp.user_name,cp.ticket_type,cp.ids_type,cp.user_ids,cp.telephone,cp.train_box,cp.seat_no
			FROM hc_orderinfo hc
			LEFT JOIN hc_orderinfo_cp cp ON cp.order_id=hc.order_id
		WHERE hc.order_id=#order_id:VARCHAR# LIMIT 0,1
	</select>
	
	<!-- 根据订单号查询配送信息 -->
	<select id="queryOrderInfoPs" parameterClass="java.lang.String"
		resultClass="com.l9e.transaction.vo.OrderInfoPs">
		SELECT hc.order_id, hc.ps_billno, hc.ps_company, hc.pay_money, hc.buy_money, 
			hc.ps_status, hc.link_name, hc.link_phone, hc.link_address, hc.link_mail 
			FROM cp_orderinfo_ps hc 
		WHERE hc.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 根据订单号查询车票以及保险信息 -->
	<select id="queryOrderDetailList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.order_id,cp.cp_id,cp.seat_type,cp.pay_money AS cp_pay_money,CONVERT(cp.buy_money,CHAR) AS cp_buy_money,cp.train_box,cp.seat_no,
			CONVERT(cp.ticket_type,CHAR) AS ticket_type,cp.user_name,CONVERT(cp.ids_type,CHAR) AS ids_type,cp.user_ids,
			bx.bx_id,bx.bx_billno,bx.bx_code,bx.pay_money AS bx_pay_money,p.product_id,p.name AS bx_name
			FROM hc_orderinfo_cp cp
			LEFT JOIN cp_orderinfo_bx bx
			ON cp.order_id=bx.order_id
			AND cp.cp_id=bx.cp_id
			LEFT JOIN hc_productinfo p
			ON bx.product_id=p.product_id
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询订单列表 -->
	<select id="queryOrderList" parameterClass="java.util.HashMap"
		resultClass="com.l9e.transaction.vo.OrderInfo">
		SELECT hc.order_id, hc.order_status, hc.from_city, hc.to_city,
			hc.ticket_pay_money, hc.bx_pay_money, hc.ps_pay_money, hc.server_pay_money, hc.pay_money,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d') AS pay_time_start,
			DATE_FORMAT(hc.pay_time,'%H:%i') AS pay_time_end,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d') AS out_ticket_time_start,
			DATE_FORMAT(hc.out_ticket_time,'%H:%i') AS out_ticket_time_end,
			DATE_FORMAT(hc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
			CONVERT(hc.out_ticket_type,CHAR) AS out_ticket_type, hc.ticket_ps_type,
			(hc.from_time <![CDATA[>]]>NOW() AND DATE_ADD(hc.from_time, INTERVAL -#refund_before_time:INTEGER# HOUR) <![CDATA[<]]>NOW()) AS is_before,
			DATE_ADD(hc.from_time, INTERVAL #refund_time:INTEGER# HOUR)<![CDATA[<]]> NOW() AS is_deadline,
			CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') AS is_repay,
			IFNULL(hc.refund_deadline_ignore,'0') AS deadline_ignore,hc.can_refund
			FROM hc_orderinfo hc
		 WHERE hc.dealer_id=#agent_id:VARCHAR# 
		 <isNotEmpty prepend=" and " property="order_id">
		 	hc.order_id=#order_id:VARCHAR#
		 </isNotEmpty>
		 <isNotEmpty prepend=" and " property="out_ticket_billno">
	 		hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="create_time">
	 		DATE_FORMAT(hc.create_time,'%Y-%m-%d')=#create_time:VARCHAR#
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="oneMonthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[>]]> NOW()
	     </isNotEmpty>
	      <isNotEmpty prepend=" and " property="monthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[<]]> NOW()
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="no_pay">
	     	 CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="order_status">
	    	<iterate conjunction="or" open="(" close=")" property="order_status">
	    		hc.order_status=#order_status[]#
	   		</iterate>
	     </isNotEmpty>
	     <isEmpty prepend=" and " property="order_status">
	     		hc.order_status<![CDATA[<>]]>'dd'
	     </isEmpty>
	     GROUP BY hc.order_id
		 ORDER BY hc.create_time DESC
         LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询订单退款结果列表 -->
	<select id="queryOrderRefundList" parameterClass="java.util.HashMap"
		resultClass="com.l9e.transaction.vo.OrderInfo">
		SELECT hc.order_id, hc.order_status, hc.from_city, hc.to_city,
			hc.ticket_pay_money, hc.bx_pay_money, hc.ps_pay_money, hc.server_pay_money, hc.pay_money,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d') AS pay_time_start,
			DATE_FORMAT(hc.pay_time,'%H:%i') AS pay_time_end,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d') AS out_ticket_time_start,
			DATE_FORMAT(hc.out_ticket_time,'%H:%i') AS out_ticket_time_end,
			DATE_FORMAT(hc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
			CONVERT(hc.out_ticket_type,CHAR) AS out_ticket_type,hc.ticket_ps_type,
			(hc.from_time <![CDATA[>]]>NOW() AND DATE_ADD(hc.from_time, INTERVAL -#refund_before_time:INTEGER# HOUR) <![CDATA[<]]>NOW()) AS is_before,
			DATE_ADD(hc.from_time, INTERVAL #refund_time:INTEGER# HOUR)<![CDATA[<]]> NOW() AS is_deadline,
			CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i') AS is_repay,
			IFNULL(hc.refund_deadline_ignore,'0') AS deadline_ignore,hc.can_refund
			FROM hc_orderinfo hc
			LEFT JOIN hc_orderinfo_refundstream v
			ON hc.order_id=v.order_id AND (v.refund_type = 1 OR v.refund_type = 2 OR v.refund_type = 3 OR v.refund_type = 6 OR v.refund_type = 7) 
		 WHERE hc.dealer_id=#agent_id:VARCHAR# 
		 <isNotEmpty prepend=" and " property="order_id">
		 	hc.order_id=#order_id:VARCHAR#
		 </isNotEmpty>
		 <isNotEmpty prepend=" and " property="out_ticket_billno">
	 		hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="create_time">
	 		DATE_FORMAT(hc.create_time,'%Y-%m-%d')=#create_time:VARCHAR#
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="oneMonthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[>]]> NOW()
	     </isNotEmpty>
	      <isNotEmpty prepend=" and " property="monthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[<]]> NOW()
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="no_pay">
	     	 CONCAT( DATE_FORMAT(hc.travel_time, '%Y-%m-%d '),hc.from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="order_status">
	    	<iterate conjunction="or" open="(" close=")" property="order_status">
	    		hc.order_status=#order_status[]#
	   		</iterate>
	     </isNotEmpty>
         <isNotEmpty prepend=" and " property="refund_status">
	    	<iterate conjunction="or" open="(" close=")" property="refund_status">
	    		v.refund_status=#refund_status[]#
	   		</iterate>
	     </isNotEmpty>
	     GROUP BY hc.order_id
		 ORDER BY hc.create_time DESC
         LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询订单列表条数 -->
	<select id="queryOrderListCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(DISTINCT hc.order_id) 
			FROM hc_orderinfo hc
			LEFT JOIN hc_orderinfo_refundstream v
			ON hc.order_id=v.order_id
			AND (v.refund_type = 1 OR v.refund_type = 2 OR v.refund_type = 3 OR v.refund_type = 6 OR v.refund_type = 7) 
		WHERE hc.dealer_id=#agent_id:VARCHAR# 
	    <isNotEmpty prepend=" and " property="order_id">
	 		hc.order_id=#order_id:VARCHAR#
	    </isNotEmpty>
	    <isNotEmpty prepend=" and " property="out_ticket_billno">
	 		hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
	    </isNotEmpty>
	      <isNotEmpty prepend=" and " property="create_time">
	 		DATE_FORMAT(hc.create_time,'%Y-%m-%d')=#create_time:VARCHAR#
	     </isNotEmpty>
	         <isNotEmpty prepend=" and " property="oneMonthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[>]]> NOW()
	     </isNotEmpty>
	      <isNotEmpty prepend=" and " property="monthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[<]]> NOW()
	     </isNotEmpty>
	    <isNotEmpty prepend=" and " property="order_status">
	    	<iterate conjunction="or" open="(" close=")" property="order_status">
	    		hc.order_status=#order_status[]#
	   		</iterate>
	     </isNotEmpty>
	     <isNotEmpty prepend=" and " property="refund_status">
	    	<iterate conjunction="or" open="(" close=")" property="refund_status">
	    		v.refund_status=#refund_status[]#
	   		</iterate>
	     </isNotEmpty>
	     <isEmpty prepend=" and " property="order_status">
	     		hc.order_status<![CDATA[<>]]>'dd'
	     </isEmpty>
	</select>
	
	<!-- 查询代理商出票成功、出票失败、出票中 -->
	<select id="queryAgentOrderNum" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT 
		SUM(CASE WHEN (hc.order_status = '00' OR hc.order_status = '99') THEN 1 ELSE 0 END) AS noPayNum,
		SUM(CASE WHEN (hc.order_status = '11' OR hc.order_status = '12' OR hc.order_status = '22' OR hc.order_status = '33' OR hc.order_status = '77') THEN 1 ELSE 0 END) AS waitingNum,
		SUM(CASE WHEN (hc.order_status = '44' OR hc.order_status = 'P1' OR hc.order_status = 'P2' OR hc.order_status = 'P3') THEN 1 ELSE 0 END) AS successNum,
		SUM(CASE WHEN (hc.order_status = '45' OR hc.order_status = '78') THEN 1 ELSE 0 END) AS failNum
		FROM hc_orderinfo hc
		WHERE hc.dealer_id=#agent_id:VARCHAR# 
		AND ((hc.order_status <![CDATA[<>]]> '00' AND  hc.order_status <![CDATA[<>]]> '99') OR ((hc.order_status = '00' OR hc.order_status = '99') AND CONCAT( DATE_FORMAT(travel_time, '%Y-%m-%d '),from_time) > DATE_FORMAT(NOW(), '%Y-%m-%d %H:%i')))
	    <isNotEmpty prepend=" and " property="order_id">
	 		hc.order_id=#order_id:VARCHAR#
	    </isNotEmpty>
	    <isNotEmpty prepend=" and " property="out_ticket_billno">
	 		hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
	    </isNotEmpty>
	      <isNotEmpty prepend=" and " property="create_time">
	 		DATE_FORMAT(hc.create_time,'%Y-%m-%d')=#create_time:VARCHAR#
	     </isNotEmpty>
	         <isNotEmpty prepend=" and " property="oneMonthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[>]]> NOW()
	     </isNotEmpty>
	      <isNotEmpty prepend=" and " property="monthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[<]]> NOW()
	     </isNotEmpty>
	</select>
	
	<!-- 查询代理商退款的订单数据 -->
	<select id="queryAgentRefundNum" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT COUNT(DISTINCT v.order_id) AS refundNum
		FROM hc_orderinfo hc
		LEFT JOIN hc_orderinfo_refundstream v
			ON hc.order_id=v.order_id
			AND (v.refund_type = 1 OR v.refund_type = 2 OR v.refund_type = 3 OR v.refund_type = 6 OR v.refund_type = 7 ) 
		WHERE hc.order_status <![CDATA[<>]]> '00'
			and hc.dealer_id=#agent_id:VARCHAR# 
	    <isNotEmpty prepend=" and " property="order_id">
	 		hc.order_id=#order_id:VARCHAR#
	    </isNotEmpty>
	    <isNotEmpty prepend=" and " property="out_ticket_billno">
	 		hc.out_ticket_billno=#out_ticket_billno:VARCHAR#
	    </isNotEmpty>
	      <isNotEmpty prepend=" and " property="create_time">
	 		DATE_FORMAT(hc.create_time,'%Y-%m-%d')=#create_time:VARCHAR#
	     </isNotEmpty>
	         <isNotEmpty prepend=" and " property="oneMonthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[>]]> NOW()
	     </isNotEmpty>
	      <isNotEmpty prepend=" and " property="monthOrder">
	 		DATE_ADD(hc.create_time,INTERVAL 1 MONTH) <![CDATA[<]]> NOW()
	     </isNotEmpty>
	</select>
	
	
<!-- 更新预定退款为退款中-->
	<insert id="insertRefundForRefund" parameterClass="com.l9e.transaction.vo.RefundVo">
		insert hc_orderinfo_refund
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
					order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
					refund_create_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_memo">
					refund_memo
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
					refund_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_purl">
					refund_purl
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
					refund_status
			</isNotEmpty>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
					#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
					now()
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_memo">
					#refund_memo:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
					#refund_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_purl">
					#refund_purl:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_status">
					#refund_status:VARCHAR#
			</isNotEmpty>
			)
		</dynamic>
		</insert>
	
	<!--  更新预定单为准备退款 -->
	<update id="updateOrderForRefunding" parameterClass="java.lang.String">
	
		UPDATE hc_orderinfo set order_status='55' WHERE order_id=#orderid:VARCHAR#
			
	</update>
	
	<!-- 更新订单状态（支付） -->
	<update id="updateOrderEopInfo" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo
			SET
			order_status=#order_status:VARCHAR#
			<isEqual prepend="," compareValue="11" property="order_status">
				pay_time=NOW()
			</isEqual>
			WHERE order_id=#asp_order_id:VARCHAR#
			<isNotEmpty prepend=" and " property="old_status">
				order_status=#old_status:VARCHAR#
			</isNotEmpty>
	</update>
	
	<!-- 定时查询待退款列表 -->
	<select id="queryTimedRefundList" resultClass="java.util.HashMap">
		SELECT o.order_id, e.eop_order_id, e.eop_refund_url, 
			CONVERT(r.refund_money, CHAR) AS refund_money
			FROM hc_orderinfo o
			LEFT JOIN hc_order_eop e
			ON o.order_id=e.order_id
			LEFT JOIN hc_orderinfo_refund r
			ON o.order_id=r.order_id
			WHERE
			 r.refund_status='66'
			AND r.refund_plan_time <![CDATA[<=]]> NOW()
			ORDER BY o.create_time DESC
			LIMIT 0,5
	</select>
	
	<!-- 查询通知出票系统的订单列表 -->
	<select id="queryNotifyCpOrderInfo" 
		resultClass="java.util.HashMap">
		SELECT hc.order_id, hc.order_name, CONVERT(hc.ticket_pay_money,CHAR) AS ticket_pay_money, 
			CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money, 
			CONVERT(hc.server_pay_money, CHAR) AS server_pay_money, 
			hc.from_city, hc.to_city, DATE_FORMAT(hc.from_time,'%Y-%m-%d %H:%i:%s') as from_time,
			DATE_FORMAT(hc.to_time,'%Y-%m-%d %H:%i:%s') as to_time, DATE_FORMAT(hc.travel_time,'%Y-%m-%d') as travel_time
			,hc.train_no,CONVERT(hc.seat_type,CHAR) as seat_type,CONVERT(hc.out_ticket_type,CHAR) as out_ticket_type,hc.ext_seat 
			 FROM hc_orderinfo hc
			WHERE hc.order_status='12'
			AND hc.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询保险金额 -->
	<select id="queryBxPayMoneyAtPaySucc" parameterClass="java.lang.String" 
		resultClass="java.lang.String">
		SELECT CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money
			 FROM hc_orderinfo hc
			WHERE hc.order_status='11'
			AND hc.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 通知出票系统的车票信息 -->
	<select id="queryCpInfoList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.cp_id,cp.order_id,cp.user_name,CONVERT(cp.ticket_type,CHAR) as ticket_type,
		CONVERT(cp.ids_type,CHAR) as ids_type,cp.user_ids,CONVERT(cp.seat_type,CHAR) as seat_type,
		CONVERT(cp.pay_money,CHAR) as pay_money
			FROM hc_orderinfo_cp cp 
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 更新通知出票系统超时重发 -->
	<update id="updateOrderTimeOut" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo hc 
		SET hc.timeout = #timeout:VARCHAR#
		WHERE hc.order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 定时查询待EOP发货通知列表 -->
	<select id="queryTimedSendList" resultClass="java.util.HashMap">
		(SELECT hc.order_id,e.eop_order_id,e.send_notify_url,hc.dealer_id as user_id,hc.ticket_ps_type as ticket_ps_type,'hc' AS asp_order_type
		 FROM hc_orderinfo hc 
		LEFT JOIN hc_order_eop e 
		ON hc.order_id=e.order_id
		WHERE hc.order_status='11' 
		AND hc.create_time <![CDATA[>]]> DATE_SUB(NOW(),INTERVAL 15 DAY)
		ORDER BY hc.create_time DESC
		LIMIT 0, 5)	
		UNION 
		(SELECT jm.order_id, p.eop_order_id,p.send_notify_url,jm.user_id,'dd' AS ticket_ps_type,jm.asp_order_type
		FROM hc_jm_order jm 
		LEFT JOIN hc_order_eop p
		ON jm.order_id=p.order_id
		WHERE jm.order_status='11'
		ORDER BY jm.create_time DESC
		LIMIT 0, 5)
	</select>
	
	<!-- 查询火车票短信通知信息 -->
	<select id="queryOrderContactInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT hc.from_city,hc.to_city,DATE_FORMAT(hc.from_time,'%m月%d日%H:%i')AS from_time,hc.train_no,
			CONVERT(hc.server_pay_money, CHAR) AS server_pay_money,
			ps.link_name,ps.link_phone,u.shop_short_name
		FROM hc_orderinfo hc
		LEFT JOIN cp_orderinfo_ps ps
		ON hc.order_id=ps.order_id
		LEFT JOIN hc_userinfo u
		ON hc.dealer_id=u.user_id
		WHERE hc.order_id=#orderId:VARCHAR#
	</select>
	
	<!-- 查询火车票明细短信通知信息 -->
	<select id="queryCpContactInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.train_box,cp.seat_no,cp.user_name FROM hc_orderinfo_cp cp
		WHERE cp.order_id=#orderId:VARCHAR#
	</select>
	
	<!-- 更新退款表退款状态 -->
	<update id="updateOrderRefund" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refund
		SET 
		refund_status=#refund_status:VARCHAR#
		<isNotEmpty prepend="," property="eop_refund_time">
			refund_time=STR_TO_DATE(#eop_refund_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
		</isNotEmpty>
		WHERE order_id=#asp_order_id:VARCHAR#
		AND refund_status=#old_refund_status:VARCHAR#
	</update>
	
	<!-- 更新保险状态未发送 -->
	<update id="updateBxStatusNotSend" parameterClass="java.lang.String">
		UPDATE cp_orderinfo_bx b 
		SET b.bx_status=0
		WHERE b.order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 查询订单差额数据 -->
	<select id="queryOrderDiffer" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT CONVERT(ticket_pay_money-buy_money,CHAR) AS refund_money, order_id,
		CONVERT(IFNULL(refund_total,0),CHAR) AS refund_total FROM hc_orderinfo
		WHERE order_id=#order_id:VARCHAR#
		AND order_status='44'
		AND ticket_pay_money-buy_money>0
	</select>
	
	<!-- 添加差额退款数据 -->
	<insert id="addOrderDiffer" parameterClass="java.util.HashMap">
		insert into hc_orderinfo_differ
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="eop_order_id">
				eop_order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="eop_refund_seq">
				eop_refund_seq
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				refund_money
			</isNotEmpty>
			,create_time
			<isNotEmpty prepend="," property="differ_status">
				differ_status
			</isNotEmpty>
			,notify_num
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="eop_order_id">
				#eop_order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="eop_refund_seq">
				#eop_refund_seq:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="refund_money">
				#refund_money:VARCHAR#
			</isNotEmpty>
			,NOW()
			<isNotEmpty prepend="," property="differ_status">
				#differ_status:VARCHAR#
			</isNotEmpty>
			,0
			)
		</dynamic>
	</insert>
	
	<!-- 定时查询差额退款 -->
	<select id="queryTimedDifferRefundList" resultClass="java.util.HashMap">
		SELECT d.order_id,CONVERT(d.refund_money, CHAR) AS refund_money,
		e.eop_order_id, e.eop_refund_url
		FROM hc_orderinfo_differ d 
		LEFT JOIN hc_order_eop e
		ON d.order_id=e.order_id
		WHERE d.differ_status='11' 
		OR (d.differ_status='22'
		AND DATE_ADD(d.notify_time, INTERVAL 5 MINUTE)<![CDATA[<=]]>NOW())
		ORDER BY create_time DESC
		LIMIT 0,5
	</select>
	
	<!-- 更新差额退款请求开始 -->
	<update id="updateDifferBegin" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_differ
		SET refund_seq=#refund_seq:VARCHAR#,
		eop_order_id=#eop_order_id:VARCHAR#,
		notify_time=NOW(),
		notify_num=notify_num+1,
		differ_status=#differ_status:VARCHAR#
		WHERE order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 更新差额退款信息 -->
	<update id="updateOrderDiffer" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_differ
		SET 
		differ_status=#differ_status:VARCHAR#
		<isNotEmpty prepend="," property="eop_refund_time">
			refund_time=STR_TO_DATE(#eop_refund_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
		</isNotEmpty>
		<isNotEmpty prepend="," property="eop_refund_seq">
			eop_refund_seq=#eop_refund_seq:VARCHAR#
		</isNotEmpty>
		WHERE order_id=#order_id:VARCHAR#
		AND refund_seq=#refund_seq:VARCHAR#
		<isNotEmpty prepend=" and " property="old_differ_status">
			differ_status=#old_differ_status:VARCHAR#
		</isNotEmpty>
	</update>
	
	<!-- 根据asp退款流水号查询差额退款表个数 -->
	<select id="queryDifferCountBySeq" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM hc_orderinfo_differ d 
		WHERE d.refund_seq=#refund_seq:VARCHAR#
	</select>
	
	<!-- 查询退款需要上传小票的时间点 列车发车前3小时 -->
	<select id="queryUploadTipTime" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		SELECT DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 3 HOUR),'%Y-%m-%d %H:%i:%s') as from_time
		FROM hc_orderinfo h WHERE h.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询差价退款信息 -->
	<select id="queryDifferRefundInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT d.differ_status,CONVERT(d.refund_money,CHAR) AS refund_money FROM hc_orderinfo_differ d 
		WHERE d.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 删除老的退款信息 -->
	<delete id="deleteOldRefund" parameterClass="java.lang.String">
		DELETE FROM hc_orderinfo_refund WHERE order_id=#order_id:VARCHAR#
	</delete>
	
	<!-- 查询最近订单列表 -->
	<select id="queryLastestOrderList" parameterClass="java.util.HashMap"
		resultClass="com.l9e.transaction.vo.OrderInfo">
		SELECT hc.order_id, hc.order_status, hc.from_city, hc.to_city,
			hc.ticket_pay_money, hc.bx_pay_money, hc.ps_pay_money, hc.server_pay_money, hc.pay_money,
			DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
			DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s') AS out_ticket_time,
			DATE_FORMAT(hc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
			CONVERT(hc.out_ticket_type,CHAR) AS out_ticket_type, r.refund_status,
			NOW()>DATE_ADD(hc.from_time, INTERVAL 12 HOUR) AS is_deadline,
			IFNULL(hc.refund_deadline_ignore,'0') AS deadline_ignore,
			DATE_FORMAT(hc.travel_time,'%Y-%m-%d') AS travel_time,hc.train_no
			FROM hc_orderinfo hc
			LEFT JOIN hc_orderinfo_refund r
			ON hc.order_id=r.order_id
		 WHERE hc.order_status <![CDATA[<>]]> '00'
		 	and hc.dealer_id=#agent_id:VARCHAR# 
		 ORDER BY hc.create_time DESC
         LIMIT 0,3
	</select>
	
	<!-- 查询退款总计 -->
	<select id="queryOrderForRefund" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT CONVERT(IFNULL(h.refund_total,0),CHAR) AS refund_total,e.eop_order_id 
			FROM hc_orderinfo h 
			LEFT JOIN hc_order_eop e 
			ON h.order_id=e.order_id
		WHERE h.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 更新订单表退款总额 -->
	<update id="updateOrderRefundTotal" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo hc
		SET hc.refund_total=#refund_total:VARCHAR#
		<isNotEmpty prepend="," property="can_refund">
			hc.can_refund=#can_refund:VARCHAR#
		</isNotEmpty>
		WHERE hc.order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 添加退款流水 -->
	<insert id="addRefundStream" parameterClass="java.util.HashMap">
		insert into hc_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				eop_order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				refund_type
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				cp_id
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="refund_purl">
				refund_purl
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				user_remark
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				refund_status
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				refund_percent
			</isNotNull>
			,notify_num
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				#eop_order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				#refund_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:DECIMAL#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="refund_purl">
				#refund_purl:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				#user_remark:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				#refund_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				#refund_percent:VARCHAR#
			</isNotNull>
			,0
			)
		</dynamic>
	</insert>
	
	<!-- 退款流水中是否包含该车票的退款信息 -->
	<select id="queryRefundStreamContainCp" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM hc_orderinfo_refundstream hc
		WHERE hc.order_id=#order_id:VARCHAR#
		AND hc.cp_id=#cp_id:VARCHAR#
		AND hc.refund_type='1'
		AND hc.refund_status <![CDATA[<>]]> '55'
	</select>
	
	<!-- 查询退款流水列表 -->
	<select id="queryRefundStreamList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT rs.order_id,rs.cp_id,rs.refund_type,rs.refund_status,
		CONVERT(refund_money, CHAR) as refund_money,rs.our_remark,rs.user_remark,
		DATE_FORMAT(rs.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		DATE_FORMAT(rs.refund_time,'%Y-%m-%d %H:%i:%s') AS refund_time,
		DATE_FORMAT(rs.refund_time,'%Y-%m-%d') AS refund_time_start,
		DATE_FORMAT(rs.refund_time,'%H:%i') AS refund_time_end
		FROM hc_orderinfo_refundstream rs 
		WHERE rs.order_id=#order_id:VARCHAR#
		ORDER BY rs.refund_type, rs.create_time DESC
	</select>
	
	<!-- 查询未发生退款的票数 -->
	<select id="queryRefundLeftCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT a.num-b.num AS left_count
		FROM (SELECT COUNT(1) AS num FROM hc_orderinfo_cp 
		WHERE order_id=#order_id:VARCHAR#) AS a,( 
		SELECT COUNT(1) AS num FROM  hc_orderinfo_refundstream
		WHERE order_id=#order_id:VARCHAR#
		AND refund_type='1' and refund_status <![CDATA[<>]]> '55') AS b
	</select> 
	
	<!-- 删除老的拒绝退款的退款流水 -->
	<delete id="deleteRefundStreamOnRefuse" parameterClass="java.util.HashMap">
		DELETE FROM hc_orderinfo_refundstream
		WHERE order_id=#order_id:VARCHAR#
		AND cp_id=#cp_id:VARCHAR#
		AND refund_type='1'
		AND refund_status='55'
	</delete>
	
	<!-- 定时查询可以发起退款的退款流水 -->
	<select id="queryTimedRefundStreamList" resultClass="java.util.HashMap">
		SELECT CONVERT(rs.stream_id,CHAR) AS stream_id,rs.order_id,rs.refund_type,rs.cp_id,rs.refund_seq,
			e.eop_order_id, e.eop_refund_url, 
			CONVERT(rs.refund_money, CHAR) AS refund_money
			FROM hc_orderinfo_refundstream rs
			LEFT JOIN hc_order_eop e
			ON rs.order_id=e.order_id
			WHERE (rs.refund_status='11' OR (rs.refund_status='22' AND DATE_ADD(rs.notify_time, INTERVAL 5 MINUTE)<![CDATA[<=]]>NOW()))
			AND rs.refund_plan_time <![CDATA[<=]]> NOW()
			AND rs.notify_num <![CDATA[<]]>5
			ORDER BY rs.create_time DESC
			LIMIT 0,10
	</select>
	
	<!-- 添加订单操作日志 -->
	<insert id="addOrderOptLog" parameterClass="java.util.HashMap">
		INSERT INTO hc_orderinfo_history (order_id,cp_id,order_optlog,create_time,opter)
		VALUES(#order_id:VARCHAR#,#cp_id:VARCHAR#,#order_optlog:VARCHAR#,NOW(),#opter:VARCHAR#)
	</insert>
	
	<!-- 更新退款流水请求开始 -->
	<update id="updateRefundStreamBegin" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refundstream
		SET eop_order_id=#eop_order_id:VARCHAR#,
		notify_time=NOW(),
		notify_num=notify_num+1,
		refund_status=#refund_status:VARCHAR#
		WHERE stream_id=#stream_id:INTEGER#
		AND order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 更新退款流水状态信息 -->
	<update id="updateOrderStreamStatus" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refundstream
		SET 
		refund_status=#refund_status:VARCHAR#,
		refund_time=now() 
		<isNotEmpty prepend="," property="eop_refund_seq">
			eop_refund_seq=#eop_refund_seq:VARCHAR#
		</isNotEmpty>
		WHERE order_id=#order_id:VARCHAR#
		<isNotEmpty prepend=" and " property="refund_seq">
			refund_seq=#refund_seq:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="old_refund_status">
			refund_status=#old_refund_status:VARCHAR#
		</isNotEmpty>

	</update>
	
	<!-- 查询发车前的特殊时间点-->
	<select id="querySpecTimeBeforeFrom" resultClass="java.util.HashMap"
		parameterClass="java.lang.String">
		SELECT DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 4 HOUR),'%Y-%m-%d %H:%i:%s') AS from_time_3,
		DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 14 DAY),'%Y-%m-%d') AS from_time_15d,
		DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 24 HOUR),'%Y-%m-%d %H:%i:%s') AS from_time_24,
		DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 48 HOUR),'%Y-%m-%d %H:%i:%s') AS from_time_48
		FROM hc_orderinfo h 
		WHERE h.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询hc_orderinfo_refund -->
	<select id="queryOrderRefundForHis" resultClass="java.util.HashMap">
		SELECT r.order_id,CONVERT(r.refund_money,CHAR) AS refund_money,
		DATE_FORMAT(r.refund_create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		DATE_FORMAT(r.refund_time,'%Y-%m-%d %H:%i:%s') AS refund_time,r.refund_purl,
		r.refund_memo,DATE_FORMAT(r.refund_plan_time,'%Y-%m-%d %H:%i:%s') AS refund_plan_time,
		r.refund_12306_seq,r.refund_status,	
	        o.order_status,e.eop_order_id,e.asp_refund_seq AS refund_seq,e.eop_refund_seq 
		FROM hc_orderinfo_refund r LEFT JOIN hc_orderinfo o
		ON r.order_id=o.order_id
		LEFT JOIN hc_order_eop e 
		ON r.order_id=e.order_id
	</select>
	
	<!-- 查询hc_orderinfo_differ -->
	<select id="queryOrderDifferForHis" resultClass="java.util.HashMap">
		SELECT d.order_id,d.refund_seq,d.eop_order_id,d.eop_refund_seq,
			CONVERT(d.refund_money,CHAR) AS refund_money,
			DATE_FORMAT(d.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,d.differ_status,opt_person,			
			DATE_FORMAT(d.refund_time,'%Y-%m-%d %H:%i:%s') AS refund_time
			FROM hc_orderinfo_differ d
	</select>
	
	<!-- 添加退款流水 -->
	<insert id="addRefundStreamForHis" parameterClass="java.util.HashMap">
		insert into hc_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				eop_order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				refund_type
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				cp_id
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="eop_refund_seq">
				eop_refund_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			<isNotNull prepend="," property="create_time">
				create_time
			</isNotNull>
			<isNotNull prepend="," property="refund_time">
				refund_time
			</isNotNull>
			<isNotNull prepend="," property="refund_purl">
				refund_purl
			</isNotNull>
			<isNotNull prepend="," property="our_remark">
				our_remark
			</isNotNull>
			<isNotNull prepend="," property="refund_plan_time">
				refund_plan_time
			</isNotNull>
			<isNotNull prepend="," property="refund_12306_seq">
				refund_12306_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				refund_status
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				refund_percent
			</isNotNull>
			<isNotNull prepend="," property="opt_person">
				opt_person
			</isNotNull>
			,notify_num
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				#eop_order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				#refund_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="eop_refund_seq">
				#eop_refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="create_time">
				STR_TO_DATE(#create_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="refund_time">
				STR_TO_DATE(#refund_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="refund_purl">
				#refund_purl:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="our_remark">
				#our_remark:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_plan_time">
				STR_TO_DATE(#refund_plan_time:VARCHAR#,'%Y-%m-%d %H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="refund_12306_seq">
				#refund_12306_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				#refund_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				#refund_percent:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="opt_person">
				#opt_person:VARCHAR#
			</isNotNull>
			,0
			)
		</dynamic>
	</insert>
	
	<update id="updateOrderCanRefundForHis" parameterClass="java.lang.String">
		UPDATE hc_orderinfo SET can_refund='0' WHERE order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 查询预订订单列表 -->
	<select id="queryScanedOrderList" resultClass="java.util.HashMap">
		SELECT hc.order_id, hc.order_name, CONVERT(hc.ticket_pay_money,CHAR) AS ticket_pay_money, 
			CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money,
			CONVERT(hc.server_pay_money, CHAR) AS server_pay_money,
		 	hc.from_city, hc.to_city,DATE_FORMAT(hc.from_time,'%Y-%m-%d %H:%i:%s') as from_time,
			DATE_FORMAT(hc.to_time,'%Y-%m-%d %H:%i:%s') as to_time, DATE_FORMAT(hc.travel_time,'%Y-%m-%d') as travel_time
			,hc.train_no,CONVERT(hc.seat_type,CHAR) as seat_type,CONVERT(hc.out_ticket_type,CHAR) as out_ticket_type ,hc.ext_seat 
			 FROM hc_orderinfo hc
			WHERE hc.order_status='12'
				AND hc.timeout='1'
				AND hc.create_time <![CDATA[>]]> DATE_SUB(NOW(),INTERVAL 1 DAY)
        ORDER BY hc.create_time DESC
        LIMIT 0,5
	</select>
	
	<!-- 修改通知信息 -->
	<update id="updateScanInfoById" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo hc 
		SET hc.timeout = #timeout:VARCHAR#,
			hc.order_status='22'
		WHERE hc.order_id=#order_id:VARCHAR#
			and hc.timeout = '1'
			and hc.order_status='12'
	</update>
	
	<!-- 添加保险发票 -->
	<insert id="addOrderInfoBxfp" parameterClass="java.util.HashMap">
	insert into cp_orderinfo_bxfp
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_receiver">
				fp_receiver
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_phone">
				fp_phone
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_zip_code">
				fp_zip_code
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_address">
				fp_address
			</isNotEmpty>
			,create_time
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_receiver">
				#fp_receiver:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_phone">
				#fp_phone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_zip_code">
				#fp_zip_code:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_address">
				#fp_address:VARCHAR#
			</isNotEmpty>
			,NOW()
			)
		</dynamic>
	</insert>
	
	
	<!-- 添加活动短信 -->
	<insert id="addMsn" parameterClass="java.util.HashMap">
	insert into hc_msn
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="user_name">
				user_name
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_phone">
				user_phone
			</isNotEmpty>
			<isNotEmpty prepend="," property="content">
				content
			</isNotEmpty>
			,create_time
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_phone">
				#user_phone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="content">
				#content:VARCHAR#
			</isNotEmpty>
			,NOW()
			)
		</dynamic>
	</insert>
	
	<select id="selectRefundPassengers" resultClass="java.lang.String" parameterClass="java.lang.String">
		SELECT user_name FROM hc_orderinfo_cp 
		WHERE cp_id = #cp_id:VARCHAR#
	</select>
	
	<!-- 查询代理商销售报表列表 -->
	<select id="querySaleReportList" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT tj_id, create_time, DATE_FORMAT(order_time,'%Y-%m-%d') order_time, dealer_id, pay_money, refund_money, bx_money, 
			order_count, ticket_count, month_order_count, month_ticket_count, month_bx_money
		FROM tj_hc_ordersale hc 
		WHERE hc.dealer_id=#agent_id:VARCHAR# 
		<dynamic prepend="">
		 <isNotEmpty prepend=" and " property="begin_time">
		 	hc.order_time <![CDATA[>=]]> #begin_time:VARCHAR#
		 </isNotEmpty>
		 <isNotEmpty prepend=" and " property="end_time">
		 	hc.order_time <![CDATA[<]]> DATE_ADD(#end_time:VARCHAR#,INTERVAL 1 DAY)
		 </isNotEmpty>
		</dynamic>
		 ORDER BY hc.create_time DESC
         LIMIT #everyPagefrom:Integer#, #pageSize:Integer#
	</select>
	
	<!-- 查询代理商销售报表总条数 -->
	<select id="querySaleReportListCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT count(tj_id)
		FROM tj_hc_ordersale hc 
		WHERE hc.dealer_id=#agent_id:VARCHAR# 
		<dynamic prepend="">
		 <isNotEmpty prepend=" and " property="begin_time">
		 	hc.order_time <![CDATA[>=]]> #begin_time:VARCHAR#
		 </isNotEmpty>
		 <isNotEmpty prepend=" and " property="end_time">
		 	hc.order_time <![CDATA[<]]> DATE_ADD(#end_time:VARCHAR#,INTERVAL 1 DAY)
		 </isNotEmpty>
		</dynamic>
	</select>
	
	<!-- 查询出发日期是否超过20天 -->
	<select id="queryOrderTravelTime" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		SELECT DATEDIFF( DATE_ADD(SYSDATE(), INTERVAL 59 DAY), hc.travel_time ) differ_day
		FROM hc_orderinfo hc WHERE hc.order_id=#order_id#
	</select>
	
	<!-- 更新订单状态为77：预约购票 -->
	<update id="updateOrderStatus" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo
		SET order_status=#order_status:VARCHAR#,
			pay_time=NOW()
		WHERE order_id=#order_id:VARCHAR#
	</update>
	
	
	<!-- 定时查询可以发起退款的退款流水
	<select id="queryCanRefundStreamList" resultClass="java.util.HashMap">
		SELECT CONVERT(rs.stream_id,CHAR) AS stream_id,rs.order_id,rs.cp_id,rs.refund_type,rs.cp_id,rs.refund_seq,
			e.eop_order_id, e.eop_refund_url, 
			CONVERT(rs.refund_money, CHAR) AS refund_money
			FROM hc_orderinfo_refundstream rs
			LEFT JOIN hc_order_eop e
			ON rs.order_id=e.order_id
			WHERE rs.refund_type='1' 
			AND (rs.refund_status='11' OR (rs.refund_status='22' AND DATE_ADD(rs.notify_time, INTERVAL 5 MINUTE)<![CDATA[<=]]>NOW()))
			AND rs.refund_plan_time <![CDATA[<=]]> NOW()
			AND rs.notify_num <![CDATA[<]]>5
			ORDER BY rs.create_time DESC
			LIMIT 0,30
	</select> -->
	<select id="queryCanRefundStreamList" resultClass="java.util.HashMap">
		SELECT CONVERT(rs.stream_id,CHAR) AS stream_id,rs.order_id,rs.cp_id,
			rs.refund_type,rs.cp_id,rs.refund_seq,rs.user_remark,rs.refund_percent,
			e.eop_order_id, e.eop_refund_url, 
			CONVERT(rs.refund_money, CHAR) AS refund_money 
			FROM hc_orderinfo_refundstream rs
			LEFT JOIN hc_order_eop e
			ON rs.order_id=e.order_id
			WHERE rs.refund_type='1' 
			AND rs.refund_status='00'
			ORDER BY rs.create_time DESC
			LIMIT 0,5
	</select>
	
	
	<!-- 查询通知退票系统的订单信息 -->
	<select id="queryRefundCpOrderInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT hc.order_id, hc.train_no, hc.from_city, hc.to_city, CONVERT(DATE_FORMAT(hc.from_time,'%Y-%m-%d %H:%i:%s'), CHAR) from_time, 
		CONVERT(DATE_FORMAT(hc.travel_time,'%Y-%m-%d'), CHAR) travel_time, hc.out_ticket_billno, 
		CONVERT(DATE_FORMAT(hc.out_ticket_time,'%Y-%m-%d %H:%i:%s'), CHAR) out_ticket_time,
		cp.cp_id, CONVERT(cp.buy_money, CHAR) buy_money, CONVERT(cp.refund_12306_money, CHAR) refund_12306_money, 
		cp.user_name, CONVERT(cp.ticket_type, CHAR) ticket_type, CONVERT(cp.ids_type, CHAR)ids_type, cp.user_ids, 
		CONVERT(cp.seat_type, CHAR) seat_type, cp.train_box, cp.seat_no
		FROM hc_orderinfo hc LEFT JOIN hc_orderinfo_cp cp ON hc.order_id=cp.order_id
		WHERE hc.order_id=#order_id:VARCHAR# and cp_id=#cp_id:VARCHAR#
	</select>
	
	<!-- 查询该订单的账号信息 -->
	<select id="queryAccountOrderInfo" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT a.acc_username, a.acc_password 
		FROM cp_accountinfo a LEFT JOIN cp_orderinfo cp ON a.acc_id=cp.account_id 
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 更新hc_orderinfo_refundstream表的退款状态 -->
	<update id="updateOrderRefundStatus" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refundstream
		SET refund_status=#order_status:VARCHAR#
		WHERE order_id=#order_id:VARCHAR# and cp_id=#cp_id:VARCHAR# AND refund_type='1'
	</update>
	
	<!-- 更新cp表为改签成功 -->
	<update id="updateCPAlterInfo" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_cp 
		SET alter_money=#alter_tickets_money#
		WHERE order_id=#order_id:VARCHAR#  and cp_id=#cp_id:VARCHAR#
	</update>
	<!-- 更新cp表为退款成功
	<update id="updateCPRefundInfo" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo
			SET
			order_status=#order_status:VARCHAR#
			<isEqual prepend="," compareValue="11" property="order_status">
				pay_time=NOW()
			</isEqual>
			WHERE order_id=#asp_order_id:VARCHAR#
			<isNotEmpty prepend=" and " property="old_status">
				order_status=#old_status:VARCHAR#
			</isNotEmpty>
	</update> -->
	<!-- 更新hc_orderinfo_refundstream表的退款信息 -->
	<update id="updateRefundInfo" parameterClass="java.util.HashMap">
		UPDATE hc_orderinfo_refundstream
		SET refund_status=#refund_status:VARCHAR#,
		refund_plan_time = NOW() 
		<isNotEmpty prepend="," property="actual_refund_money">
			actual_refund_money=#actual_refund_money:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend="," property="alter_tickets_money">
			alter_tickets_money=#alter_tickets_money:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_money">
			refund_money=#refund_money:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_12306_seq">
			refund_12306_seq=#refund_12306_seq:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="our_remark">
			our_remark=#our_remark:VARCHAR#
		</isNotEmpty>
		WHERE order_id=#order_id:VARCHAR#  and cp_id=#cp_id:VARCHAR#  AND refund_type='1'
	</update>
	
	<!-- 人工出票数 -->
	<select id="queryManualOrderCount" resultClass="java.lang.Integer">
		select count(*) from cp_orderinfo where order_status='MM' and manual_order='11'
	</select>
	
	<!-- 查询待核验日志 -->
	<select id="queryNeedCheckOptlogList" resultClass="java.lang.String">
		SELECT order_optlog FROM cp_orderinfo_history WHERE order_optlog LIKE '%待核验%' AND order_id=#order_id#
	</select>
	
	<!-- 假删除待支付订单 -->
	<update id="deleteOrder" parameterClass="java.lang.String">
		update hc_orderinfo set order_status='dd' where order_id = #orderId:VARCHAR# AND order_status ='00'
	</update>
	
	<!-- 添加送票上门详细 -->
	<insert id="addOrderSpsmInfo" parameterClass="java.util.HashMap">
	insert into hc_orderinfo_pssm
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="choose_seat_num">
				choose_seat_num
			</isNotEmpty>
			<isNotEmpty prepend="," property="choose_ext">
				choose_ext
			</isNotEmpty>
			<isNotEmpty prepend="," property="link_name_ps">
				link_name_ps
			</isNotEmpty>
			<isNotEmpty prepend="," property="link_phone_ps">
				link_phone_ps
			</isNotEmpty>
			<isNotEmpty prepend="," property="province">
				province
			</isNotEmpty>
			<isNotEmpty prepend="," property="city">
				city
			</isNotEmpty>
			<isNotEmpty prepend="," property="district">
				district
			</isNotEmpty>
			<isNotEmpty prepend="," property="ps_address">
				ps_address
			</isNotEmpty>
			<isNotEmpty prepend="," property="pay_money">
				pay_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="buy_money">
				buy_money
			</isNotEmpty>
			,create_time
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="choose_seat_num">
				#choose_seat_num:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="choose_ext">
				#choose_ext:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="link_name_ps">
				#link_name_ps:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="link_phone_ps">
				#link_phone_ps:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="province">
				#province:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="city">
				#city:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="district">
				#district:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ps_address">
				#ps_address:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pay_money">
				#pay_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="buy_money">
				#buy_money:VARCHAR#
			</isNotEmpty>
			,NOW()
			)
		</dynamic>
	</insert>
	
	
	<!-- 根据订单号查询配送信息 -->
	<select id="queryOrderInfoPssm" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT order_id, ps_billno,ps_company,pay_money,ps_status,create_time,choose_seat_num,choose_ext,link_name_ps,
		link_phone_ps,province,city,district,ps_address FROM hc_orderinfo_pssm 
		WHERE order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 插入带送票上门车票明细 -->
	<insert id="insertIntoPsOutTicket" parameterClass="java.util.HashMap">
		INSERT INTO hc_orderinfo_pssm_ticket 
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_name">
				order_name
			</isNotEmpty>
			<isNotEmpty prepend="," property="ticket_pay_money">
				pay_money
			</isNotEmpty>
			<isNotEmpty prepend="," property="train_no">
				train_no
			</isNotEmpty>
			<isNotEmpty prepend="," property="from_city">
				from_city
			</isNotEmpty>
			<isNotEmpty prepend="," property="to_city">
				to_city
			</isNotEmpty>
			<isNotEmpty prepend="," property="from_time">
				from_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="to_time">
				to_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="travel_time">
				travel_time
			</isNotEmpty>
			<isNotEmpty prepend="," property="seat_type">
				seat_type
			</isNotEmpty>
			
			<isNotEmpty prepend="," property="level">
				level
			</isNotEmpty>
			,order_status,create_time,option_time
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_name">
				#order_name:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ticket_pay_money">
				#ticket_pay_money:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="train_no">
				#train_no:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="from_city">
				#from_city:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="to_city">
				#to_city:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="from_time">
				#from_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="to_time">
				#to_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="travel_time">
				#travel_time:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="seat_type">
				#seat_type:VARCHAR#
			</isNotEmpty>
			
			<isNotEmpty prepend="," property="level">
				#level:VARCHAR#
			</isNotEmpty>
			,'00',now(),now()
			)
		</dynamic>
	</insert>
	
	<!-- 插入带送票上门乘客信息明细 -->
	<insert id="insertIntoPsOutTicketCp" parameterClass="java.util.HashMap">
	INSERT INTO hc_orderinfo_pssm_cp
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="cp_id">
				cp_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_name">
				user_name
			</isNotEmpty>
			<isNotEmpty prepend="," property="ticket_type">
				ticket_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="ids_type">
				cert_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_ids">
				cert_no
			</isNotEmpty>
			<isNotEmpty prepend="," property="seat_type">
				seat_type
			</isNotEmpty>
			<isNotEmpty prepend="," property="pay_money">
				pay_money
			</isNotEmpty>
			,create_time
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ticket_type">
				#ticket_type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="ids_type">
				#ids_type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="user_ids">
				#user_ids:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="seat_type">
				#seat_type:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="pay_money">
				#pay_money:VARCHAR#
			</isNotEmpty>
			,NOW()
			)
		</dynamic>
	</insert>
	
	<!-- 修改hc表到正在预定 -->
	<update id="updateHcOrderTo22" parameterClass="java.lang.String">
		update hc_orderinfo set order_status='22' where order_id = #orderId:VARCHAR# AND order_status ='12'
	</update>
	<!-- 插入学生票 特殊信息[] -->
	<insert id="addStudentInfo" parameterClass="com.l9e.transaction.vo.DBStudentInfo">
		insert into cp_orderinfo_student
		<dynamic prepend="(">
			<isNotEmpty  property="province_name">
				province_name,
			</isNotEmpty>
			<isNotEmpty  property="province_code">
				province_code,
			</isNotEmpty>
			<isNotEmpty  property="school_code">
				school_code,
			</isNotEmpty>
			<isNotEmpty  property="school_name">
				school_name,
			</isNotEmpty>
			<isNotEmpty  property="student_no">
				student_no,
			</isNotEmpty>
			<isNotEmpty  property="school_system">
				school_system,
			</isNotEmpty>
			<isNotEmpty  property="enter_year">
				enter_year,
			</isNotEmpty>
			<isNotEmpty  property="preference_from_station_name">
				preference_from_station_name,
			</isNotEmpty>
			<isNotEmpty  property="preference_from_station_code">
				preference_from_station_code,
			</isNotEmpty>
			<isNotEmpty  property="preference_to_station_name">
				preference_to_station_name,
			</isNotEmpty>
			<isNotEmpty  property="preference_to_station_code">
				preference_to_station_code,
			</isNotEmpty>
			<isNotEmpty  property="channel">
				channel,
			</isNotEmpty>
			cp_id,
			order_id
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty  property="province_name">
				#province_name:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="province_code">
				#province_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="school_code">
				#school_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="school_name">
				#school_name:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="student_no">
				#student_no:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="school_system">
				#school_system:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty  property="enter_year">
				#enter_year:DECIMAL#,
			</isNotEmpty>
			<isNotEmpty  property="preference_from_station_name">
				#preference_from_station_name:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="preference_from_station_code">
				#preference_from_station_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="preference_to_station_name">
				#preference_to_station_name:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="preference_to_station_code">
				#preference_to_station_code:VARCHAR#,
			</isNotEmpty>
			<isNotEmpty property="channel">
				#channel:VARCHAR#,
			</isNotEmpty>
				#cp_id:VARCHAR#,
				#order_id:VARCHAR#
			)
		</dynamic>
	</insert>
	
	
</sqlMap>