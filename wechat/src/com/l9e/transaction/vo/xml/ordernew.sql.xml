<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="order">

	<!-- 创建订单 -->
	<insert id="addOrderInfo"
		parameterClass="com.l9e.transaction.vo.OrderInfo">
		insert into app_orderinfo
		<dynamic prepend="(">
			order_id,opt_time,
			<isNotNull prepend="," property="order_name">
				order_name
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="ticket_pay_money">
				ticket_pay_money
			</isNotNull>
			<isNotNull prepend="," property="bx_pay_money">
				bx_pay_money
			</isNotNull>
			<isNotNull prepend="," property="order_status">
				order_status
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="link_name">
				link_name
			</isNotNull>
			<isNotNull prepend="," property="link_phone">
				link_phone
			</isNotNull>
			<isNotNull prepend="," property="sms_notify">
				sms_notify
			</isNotNull>
			<isNotNull prepend="," property="order_level">
				order_level
			</isNotNull>
			<isNotNull prepend="," property="user_id">
				user_id
			</isNotNull>
			<isNotNull prepend="," property="product_type">
				product_type
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#order_id:VARCHAR#,now(),
			<isNotNull prepend="," property="order_name">
				#order_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="ticket_pay_money">
				#ticket_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="bx_pay_money">
				#bx_pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="order_status">
				#order_status:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="link_name">
				#link_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="link_phone">
				#link_phone:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="sms_notify">
				#sms_notify:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="order_level">
				#order_level:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_id">
				#user_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="product_type">
				#product_type:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>


	<!-- 车票 -->
	<insert id="addOrderInfoCp"
		parameterClass="com.l9e.transaction.vo.OrderInfoCp">
		insert into app_orderinfo_cp
		<dynamic prepend="(">
			cp_id,
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				user_name
			</isNotNull>
			<isNotNull prepend="," property="ticket_type">
				ticket_type
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				ids_type
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				user_ids
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				telephone
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				seat_type
			</isNotNull>
			<isNotNull prepend="," property="from_time">
				from_time
			</isNotNull>
			<isNotNull prepend="," property="arrive_time">
				arrive_time
			</isNotNull>
			<isNotNull prepend="," property="travel_time">
				travel_time
			</isNotNull>
			<isNotNull prepend="," property="from_station">
				from_station
			</isNotNull>
			<isNotNull prepend="," property="arrive_station">
				arrive_station
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				train_no
			</isNotNull>
			,refund_status )
		</dynamic>
		values
		<dynamic prepend="(">
			#cp_id:VARCHAR#,
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ticket_type">
				#ticket_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				#ids_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				#user_ids:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				#telephone:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="seat_type">
				#seat_type:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="from_time">
				DATE_FORMAT(STR_TO_DATE(#from_time:VARCHAR#,'%Y-%m-%d
				%H:%i:%s'), '%H:%i')
			</isNotNull>
			<isNotNull prepend="," property="arrive_time">
				DATE_FORMAT(STR_TO_DATE(#arrive_time:VARCHAR#,'%Y-%m-%d
				%H:%i:%s'), '%H:%i')
			</isNotNull>
			<isNotNull prepend="," property="travel_time">
				DATE_FORMAT(STR_TO_DATE(#travel_time:VARCHAR#,'%Y-%m-%d
				%H:%i:%s'), '%Y-%m-%d')
			</isNotNull>
			<isNotNull prepend="," property="from_station">
				#from_station:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="arrive_station">
				#arrive_station:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				#train_no:VARCHAR#
			</isNotNull>
			,'00' )
		</dynamic>
	</insert>


	<!-- 保险 -->
	<insert id="addOrderInfoBx"
		parameterClass="com.l9e.transaction.vo.OrderInfoBx">
		insert into app_orderinfo_bx
		<dynamic prepend="(">
			bx_id,
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="cp_id">cp_id</isNotNull>
			<isNotNull prepend="," property="from_name">
				from_name
			</isNotNull>
			<isNotNull prepend="," property="to_name">
				to_name
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				ids_type
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				user_name
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				user_ids
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="bx_status">
				bx_status
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				pay_money
			</isNotNull>
			<isNotNull prepend="," property="product_id">
				product_id
			</isNotNull>
			<isNotNull prepend="," property="effect_date">
				effect_date
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				train_no
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				telephone
			</isNotNull>
			<isNotNull prepend="," property="bx_channel">
				bx_channel
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			#bx_id:VARCHAR#,
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="from_name">
				#from_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="to_name">
				#to_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="ids_type">
				#ids_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_name">
				#user_name:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_ids">
				#user_ids:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="bx_status">
				#bx_status:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="pay_money">
				#pay_money:DECIMAL#
			</isNotNull>
			<isNotNull prepend="," property="product_id">
				#product_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="effect_date">
				#effect_date:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="train_no">
				#train_no:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="telephone">
				#telephone:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="bx_channel">
				#bx_channel:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>

	<!-- 根据订单号查询订单信息 -->
	<select id="queryOrderInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT ao.order_id,ao.order_status,convert(aoc.travel_time,
		char) AS travel_time, convert(aoc.from_time, CHAR) as from_time,
		convert(aoc.arrive_time, CHAR) as arrive_time,aoc.train_no,
		aoc.from_station, aoc.arrive_station,aoc.seat_type,
		convert(ao.refund_total, CHAR) as refund_total,
		DATE_FORMAT(ao.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
		DATE_FORMAT(ao.finish_time,'%Y-%m-%d %H:%i:%s') AS finish_time,
		DATE_FORMAT(ao.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		convert(ao.ticket_pay_money, CHAR) as ticket_pay_money,
		convert(ao.bx_pay_money, CHAR) AS bx_pay_money,
		convert(ao.pay_money, CHAR) as pay_money,
		convert(ao.buy_money,CHAR) as buy_money,aoc.out_ticket_billno,
		ao.can_refund,ao.ext_seat,ao.link_phone, ao.transaction_id, ao.notify_id FROM app_orderinfo ao
		left join app_orderinfo_cp aoc on ao.order_id=aoc.order_id WHERE
		ao.order_id=#order_id:VARCHAR# limit 1
	</select>

	<!-- 根据订单号查询车票以及保险信息 -->
	<select id="queryOrderDetailList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.order_id,cp.cp_id,cp.seat_type,
		CONVERT(TRUNCATE(cp.pay_money,1),CHAR) AS cp_pay_money,
		CONVERT(cp.buy_money,CHAR) AS cp_buy_money,
		cp.train_box,cp.seat_no, CONVERT(cp.ticket_type,CHAR) AS
		ticket_type,cp.user_name,CONVERT(cp.ids_type,CHAR) AS
		ids_type,cp.user_ids,cp.train_box,cp.seat_no,
		bx.bx_id,bx.bx_billno,bx.bx_code,TRUNCATE(bx.pay_money,1) AS
		bx_pay_money,bx.product_id FROM app_orderinfo_cp cp LEFT JOIN
		app_orderinfo_bx bx ON cp.order_id=bx.order_id AND
		cp.cp_id=bx.cp_id WHERE cp.order_id=#order_id:VARCHAR#
	</select>

	<!-- 查询订单列表 -->
	<select id="queryOrderList" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT hc.order_id,hc.order_status,cp.train_no,cp.from_station,
		cp.arrive_station,cp.from_time,cp.arrive_time AS to_time,
		DATE_FORMAT(cp.travel_time,'%Y-%m-%d') AS travel_time,
		cp.out_ticket_billno,DATE_FORMAT(hc.pay_time,'%Y-%m-%d
		%H:%i:%s') AS pay_time, DATE_FORMAT(hc.finish_time,'%Y-%m-%d
		%H:%i:%s') AS out_ticket_time, cp.seat_type,
		convert(hc.ticket_pay_money,CHAR) as ticket_pay_money,
		convert(hc.bx_pay_money,CHAR) AS bx_pay_money,
		convert(hc.pay_money,CHAR) as pay_money,hc.buy_money,
		hc.can_refund,hc.ext_seat, hc.link_phone, re.refund_status FROM
		app_orderinfo hc left join app_orderinfo_cp cp on
		hc.order_id=cp.order_id LEFT JOIN app_orderinfo_refundstream re
		ON re.order_id=hc.order_id WHERE hc.order_status NOT
		IN('33','11','88') and hc.user_id=#user_id:VARCHAR#
		<isNotEmpty prepend=" and " property="order_id">
			hc.order_id=#order_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="out_ticket_billno">
			cp.out_ticket_billno=#out_ticket_billno:VARCHAR#
		</isNotEmpty>
		group by hc.order_id ORDER BY hc.create_time DESC
		<!-- LIMIT #everyPagefrom:Integer#, #pageSize:Integer# -->
	</select>

	<!-- 查询某个订单里面的乘客姓名信息 -->
	<select id="queryPassengerList" parameterClass="java.lang.String"
		resultClass="java.lang.String">
		SELECT user_name FROM app_orderinfo_cp WHERE
		order_id=#order_id:VARCHAR#
	</select>

	<!-- 查询订单列表条数 -->
	<select id="queryOrderListCount" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM app_orderinfo hc WHERE hc.order_status
		<![CDATA[<>]]>
		'00' and hc.link_phone=#link_phone:VARCHAR#
		<isNotEmpty prepend=" and " property="order_id">
			hc.order_id=#order_id:VARCHAR#
		</isNotEmpty>
	</select>

	<!-- 更新订单状态（支付） -->
	<update id="updateOrderEopInfo"
		parameterClass="java.util.HashMap">
		UPDATE app_orderinfo SET order_status=#order_status:VARCHAR#
		<isEqual prepend="," compareValue="11"
			property="order_status">
			pay_time=NOW()
		</isEqual>
		WHERE order_id=#order_id:VARCHAR#
		<isNotEmpty prepend=" and " property="old_status">
			order_status=#old_status:VARCHAR#
		</isNotEmpty>
	</update>

	<!-- 查询通知出票系统的订单列表 -->
	<select id="queryNotifyCpOrderInfo"
		resultClass="java.util.HashMap">
		SELECT hc.order_id, hc.order_name,
		CONVERT(hc.ticket_pay_money,CHAR) AS ticket_pay_money,
		CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money, cp.from_station,
		cp.arrive_station, DATE_FORMAT(cp.from_time,'%H:%i') as
		from_time, DATE_FORMAT(cp.arrive_time,'%H:%i') as arrive_time,
		DATE_FORMAT(cp.travel_time,'%Y-%m-%d') as travel_time
		,cp.train_no,CONVERT(cp.seat_type,CHAR) as seat_type,hc.ext_seat
		FROM app_orderinfo hc left join app_orderinfo_cp on
		hc.order_id=cp.order_id WHERE hc.order_status='11' AND
		hc.order_id=#order_id:VARCHAR# limit 1
	</select>

	<!-- 查询保险金额 -->
	<select id="queryBxPayMoneyAtPaySucc"
		parameterClass="java.lang.String" resultClass="java.lang.String">
		SELECT CONVERT(hc.bx_pay_money, CHAR) AS bx_pay_money FROM
		app_orderinfo hc WHERE hc.order_status='11' AND
		hc.order_id=#order_id:VARCHAR#
	</select>

	<!-- 更新订单信息 -->
	<update id="updateOrderInfo" parameterClass="java.util.HashMap">
		update app_orderinfo set opt_time=now(), opt_ren='book app'
		<isNotEmpty prepend="," property="user_id">
			user_id=#user_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="pay_type">
			pay_type=#pay_type:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="order_status">
			order_status=#order_status:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="transaction_id">
			transaction_id=#transaction_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="notify_id">
			notify_id=#notify_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="pay_time">
			pay_time=str_to_date(#pay_time:VARCHAR#, '%Y-%m-%d
			%H:%i:%s')
		</isNotEmpty>
		<isNotEmpty prepend="," property="return_fee">
			return_fee=#return_fee:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="discount">
			discount=#discount:VARCHAR#
		</isNotEmpty>
		WHERE order_id=#order_id:VARCHAR#
	</update>
	<!-- 通知出票系统的车票信息 -->
	<select id="queryCpInfoList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.cp_id,cp.order_id,cp.user_name,
		CONVERT(cp.ticket_type,CHAR) as ticket_type,
		CONVERT(cp.ids_type,CHAR) as ids_type,cp.user_ids,
		CONVERT(cp.seat_type,CHAR) as seat_type,
		CONVERT(cp.pay_money,CHAR) as pay_money FROM app_orderinfo_cp cp
		WHERE cp.order_id=#order_id:VARCHAR#
	</select>

	<!-- 定时查询待发货通知列表 -->
	<select id="queryTimedSendList" resultClass="java.util.HashMap">
		SELECT hc.order_id,hc.user_id FROM app_orderinfo hc WHERE
		hc.order_status='11' AND hc.create_time
		<![CDATA[>]]>
		DATE_SUB(NOW(),INTERVAL 1 DAY) ORDER BY hc.create_time DESC
		LIMIT 0, 20
	</select>

	<!-- 查询火车票明细短信通知信息 -->
	<select id="queryCpContactInfo" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp.train_box,cp.seat_no,cp.user_name FROM
		app_orderinfo_cp cp WHERE cp.order_id=#order_id:VARCHAR#
	</select>

	<!-- 更新保险状态未发送 -->
	<update id="updateBxStatusNotSend"
		parameterClass="java.lang.String">
		UPDATE app_orderinfo_bx b SET b.bx_status=0 WHERE
		b.order_id=#order_id:VARCHAR#
	</update>

	<!-- 查询订单差额数据 -->
	<select id="queryOrderDiffer" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT CONVERT(ticket_pay_money-buy_money,CHAR) AS refund_money,
		order_id, CONVERT(IFNULL(refund_total,0),CHAR) AS refund_total,
		date_format(finish_time, "%Y-%m-d %H:%i:%s") AS finish_time FROM
		app_orderinfo WHERE order_id=#order_id:VARCHAR# AND
		order_status='44' AND ticket_pay_money-buy_money>0
	</select>



	<!-- 查询退款需要上传小票的时间点 列车发车前3小时 -->
	<select id="queryUploadTipTime" resultClass="java.lang.String"
		parameterClass="java.lang.String">
		SELECT DATE_FORMAT(DATE_SUB(h.from_time, INTERVAL 3
		HOUR),'%Y-%m-%d %H:%i:%s') as from_time FROM app_orderinfo h
		WHERE h.order_id=#order_id:VARCHAR#
	</select>

	<!-- 查询最近订单列表 -->
	<select id="queryLastestOrderList"
		parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		select hcp.*, r.refund_status from (SELECT hc.order_id,
		hc.order_status, cp.from_station, cp.arrive_station,
		convert(hc.ticket_pay_money,CHAR) as ticket_pay_money,
		convert(hc.bx_pay_money, CHAR) as bx_pay_money,
		convert(hc.pay_money, CHAR) as pay_money,hc.user_id,
		DATE_FORMAT(hc.pay_time,'%Y-%m-%d %H:%i:%s') AS pay_time,
		DATE_FORMAT(hc.finish_time,'%Y-%m-%d %H:%i:%s') AS finish_time,
		DATE_FORMAT(hc.create_time,'%Y-%m-%d %H:%i:%s') AS create_time,
		IFNULL(hc.refund_deadline_ignore,'0') AS deadline_ignore,
		DATE_FORMAT(cp.travel_time,'%Y-%m-%d') AS
		travel_time,cp.train_no FROM app_orderinfo hc left join
		app_orderinfo_cp cp on hc.order_id=cp.order_id ) as hcp
		LEFT JOIN app_orderinfo_refundstream r ON
		hcp.order_id=r.order_id WHERE hcp.order_status
		<![CDATA[<>]]>
		'00' and hcp.user_id=#user_id:VARCHAR# ORDER BY hcp.create_time
		DESC LIMIT 0,3
	</select>

	<!-- 更新订单表退款总额 -->
	<update id="updateOrderRefundTotal"
		parameterClass="java.util.HashMap">
		UPDATE app_orderinfo hc SET
		hc.refund_total=#refund_total:VARCHAR#
		<isNotEmpty prepend="," property="can_refund">
			hc.can_refund=#can_refund:VARCHAR#
		</isNotEmpty>
		WHERE hc.order_id=#order_id:VARCHAR#
	</update>

	<!-- 添加退款流水 -->
	<insert id="addRefundStream" parameterClass="java.util.HashMap">
		insert into app_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				refund_type
			</isNotNull>
			<isNotNull prepend="," property="cp_id">cp_id</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="refund_plan_time">
				refund_plan_time
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				user_remark
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				refund_status
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				refund_percent
			</isNotNull>
			<isNotNull prepend="," property="refund_amt">
				refund_amt
			</isNotNull>
			<isNotNull prepend="," property="refund_no">
				refund_no
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				#refund_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:DECIMAL#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="refund_plan_time">
				STR_TO_DATE(#refund_plan_time:VARCHAR#,'%Y-%m-%d
				%H:%i:%s')
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				#user_remark:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				#refund_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				#refund_percent:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_amt">
				#refund_amt:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_no">
				#refund_no:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>


	<!-- 向通知表添加数据 -->
	<insert id="insertIntoNotify" parameterClass="java.util.HashMap">
		insert into app_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				refund_type
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="notify_status">
				notify_status
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="notify_time">
				notify_time
			</isNotNull>
			<isNotNull prepend="," property="notify_num">
				notify_num
			</isNotNull>
			<isNotNull prepend="," property="order_money">
				order_money
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				#refund_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="notify_status">
				#notify_status:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="notify_time">
				#notify_time:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="notify_num">
				#notify_num:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="order_money">
				#order_money:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>

	<!-- 退款流水中是否包含该车票的退款信息 -->
	<select id="queryRefundStreamContainCp"
		parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM app_orderinfo_refundstream hc WHERE
		hc.order_id=#order_id:VARCHAR# AND hc.cp_id=#cp_id:VARCHAR# AND
		hc.refund_type='1' AND hc.refund_status
		<![CDATA[<>]]>
		'55'
	</select>

	<!-- 查询退款流水列表 -->
	<select id="queryRefundStreamList" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT rs.order_id,rs.cp_id,rs.refund_type,rs.refund_status,
		CONVERT(refund_money, CHAR) as
		refund_money,rs.our_remark,rs.user_remark,
		DATE_FORMAT(rs.refund_time,'%Y-%m-%d %H:%i:%s') AS refund_time
		FROM app_orderinfo_refundstream rs WHERE
		rs.order_id=#order_id:VARCHAR# ORDER BY rs.refund_type,
		rs.create_time DESC
	</select>

	<!-- 查询未发生退款的票数 -->
	<select id="queryRefundLeftCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT a.num-b.num AS left_count FROM (SELECT COUNT(1) AS num
		FROM app_orderinfo_cp WHERE order_id=#order_id:VARCHAR#) AS a,(
		SELECT COUNT(1) AS num FROM app_orderinfo_refundstream WHERE
		order_id=#order_id:VARCHAR# AND refund_type='1' and
		refund_status
		<![CDATA[<>]]>
		'55') AS b
	</select>

	<!-- 删除老的拒绝退款的退款流水 -->
	<delete id="deleteRefundStreamOnRefuse"
		parameterClass="java.util.HashMap">
		DELETE FROM app_orderinfo_refundstream WHERE
		order_id=#order_id:VARCHAR# AND cp_id=#cp_id:VARCHAR# AND
		refund_type='1' AND refund_status='55'
	</delete>

	<!-- 定时查询可以发起退款的退款流水 -->
	<select id="queryTimedRefundStreamList"
		resultClass="java.util.HashMap">
		SELECT CONVERT(rs.stream_id,CHAR) AS stream_id,wo.pay_type,
		rs.order_id,rs.refund_type,rs.cp_id,rs.refund_seq,rs.refund_no,
		CONVERT(rs.refund_money, CHAR) AS refund_money,
		DATE_FORMAT(wo.pay_time,'%Y%m%d') AS pay_time,
		convert(wo.pay_money, CHAR) as pay_money FROM
		app_orderinfo_refundstream rs join app_orderinfo as wo on
		wo.order_id=rs.order_id join app_orderinfo_refundnotify aor on
		aor.order_id=wo.order_id WHERE (rs.refund_status='11' OR
		(rs.refund_status='22' AND DATE_ADD(aor.notify_time, INTERVAL 5
		MINUTE)<![CDATA[<=]]>NOW())) AND rs.refund_plan_time
		<![CDATA[<=]]>
		NOW() and aor.notify_num
		<![CDATA[<]]>5 ORDER BY rs.create_time DESC LIMIT 0,10
	</select>

	<!-- 添加订单操作日志 -->
	<insert id="addOrderOptLog" parameterClass="java.util.HashMap">
		INSERT INTO app_orderinfo_history
		(order_id,order_optlog,create_time,opter)
		VALUES(#order_id:VARCHAR#,#order_optlog:VARCHAR#,NOW(),#opter:VARCHAR#)
	</insert>

	<!-- 更新退款流水请求开始 -->
	<update id="updateRefundStreamBegin"
		parameterClass="java.util.HashMap">
		UPDATE app_orderinfo_refundstream set
		refund_status=#refund_status:VARCHAR# WHERE
		stream_id=#stream_id:INTEGER# AND order_id=#order_id:VARCHAR#
	</update>

	<!-- 更新退款流水状态信息 -->
	<update id="updateOrderStreamStatus"
		parameterClass="java.util.HashMap">
		UPDATE app_orderinfo_refundstream SET
		refund_status=#refund_status:VARCHAR#
		<isNotEmpty prepend="," property="refund_time">
			refund_time=STR_TO_DATE(#refund_time:VARCHAR#,'%Y-%m-%d
			%H:%i:%s')
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_amt">
			refund_amt=#refund_amt:DECIMAL#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_id">
			refund_id=#refund_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_channel">
			refund_channel=#refund_channel:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_fail_reason">
			refund_fail_reason=#refund_fail_reason:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_fee">
			refund_fee=#refund_fee:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="discount">
			discount=#discount:VARCHAR#
		</isNotEmpty>
		WHERE order_id=#order_id:VARCHAR#
		<isNotEmpty prepend=" and " property="stream_id">
			stream_id=#stream_id:INTEGER#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="refund_seq">
			refund_seq=#refund_seq:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="refund_no">
			refund_no=#refund_no:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend=" and " property="old_refund_status">
			refund_status=#old_refund_status:VARCHAR#
		</isNotEmpty>
	</update>

	<!-- 查询发车前的特殊时间点-->
	<select id="querySpecTimeBeforeFrom" resultClass="java.util.HashMap"
		parameterClass="java.lang.String">
		SELECT DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(h.travel_time, "
		", h.from_time, "00"), "%Y-%m-%d %H:%i:%s"), INTERVAL 4
		HOUR),'%Y-%m-%d %H:%i:%s') AS from_time_3,
		DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(h.travel_time, " ",
		h.from_time,"00"), "%Y-%m-%d %H:%i:%s"), INTERVAL 24
		HOUR),'%Y-%m-%d %H:%i:%s') AS
		from_time_24,DATE_FORMAT(DATE_SUB(STR_TO_DATE(CONCAT(h.travel_time,
		" ", h.from_time), "%Y-%m-%d %H:%i:%s"), INTERVAL 48
		HOUR),'%Y-%m-%d %H:%i:%s') AS from_time_48 FROM app_orderinfo_cp
		h WHERE h.order_id=#order_id:VARCHAR# limit 1
	</select>

	<!-- 查询预订订单列表 -->
	<select id="queryScanedOrderList" resultClass="java.util.HashMap">
		select count(distinct(order_id)), hcp.* from (SELECT
		hc.order_id, hc.order_name, CONVERT(hc.ticket_pay_money,CHAR) AS
		ticket_pay_money, CONVERT(hc.bx_pay_money, CHAR) AS
		bx_pay_money, cp.from_station,hc.channel,
		cp.arrive_station,CONCAT(cp.travel_time, " ", cp.from_time) as
		from_time, CONCAT(cp.travel_time, " ", cp.arrive_time) as
		to_time, DATE_FORMAT(cp.travel_time,'%Y-%m-%d') as travel_time
		,cp.train_no,CONVERT(cp.seat_type,CHAR) as seat_type,hc.ext_seat
		FROM app_orderinfo hc left join app_orderinfo_cp cp on
		hc.order_id=cp.order_id WHERE hc.order_status='11' AND
		hc.create_time
		<![CDATA[>]]>
		DATE_SUB(NOW(),INTERVAL 1 DAY) ORDER BY hc.create_time DESC) as
		hcp group by order_id LIMIT 0,5
	</select>

	<!-- 修改通知信息 -->
	<update id="updateScanInfoById"
		parameterClass="java.util.HashMap">
		UPDATE app_orderinfo hc SET hc.order_status='22' WHERE
		hc.order_id=#order_id:VARCHAR# and hc.order_status='12'
	</update>

	<!-- 添加保险发票 -->
	<insert id="addOrderInfoBxfp" parameterClass="java.util.HashMap">
		insert into app_orderinfo_bxfp
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				order_id
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_receiver">
				fp_receiver
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_phone">
				fp_phone
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_zip_code">
				fp_zip_code
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_address">
				fp_address
			</isNotEmpty>
			,create_time )
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotEmpty prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_receiver">
				#fp_receiver:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_phone">
				#fp_phone:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_zip_code">
				#fp_zip_code:VARCHAR#
			</isNotEmpty>
			<isNotEmpty prepend="," property="fp_address">
				#fp_address:VARCHAR#
			</isNotEmpty>
			,NOW() )
		</dynamic>
	</insert>

	<update id="updateOrderPayNo" parameterClass="java.util.HashMap">
		update app_orderinfo set pay_time=now()
		<isNotEmpty prepend="," property="pay_order_id">
			pay_order_id = #pay_order_id:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="order_status">
			order_status = #order_status:VARCHAR#
		</isNotEmpty>
		<isNotEmpty prepend="," property="pay_type">
			pay_type=#pay_type:VARCHAR#
		</isNotEmpty>
		WHERE order_id = #order_id:VARCHAR#
	</update>


</sqlMap>
