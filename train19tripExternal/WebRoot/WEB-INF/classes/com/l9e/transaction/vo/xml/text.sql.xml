<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="text">


	<!-- 查询带出票订单id list     'zhongyidong','elong','xinjiang','wuyiqi','yingtong','19trip'-->
	<select id="queryOutTicket"  resultClass="java.lang.String">
		select order_id from cp_orderinfo  where order_status='00' and channel in(
		SELECT merchant_id FROM ext_merchantinfo 
		) order by create_time desc limit 0,20
	<!--
	 update elong_orderinfo_returnnotify set 
	  <![CDATA[
	 notify_status=NULL 
	  ]]>
	 where order_id='liuyiceshi001'
	-->
	</select>
	
	
	
	<!-- 查询带出票订单id list     'zhongyidong','elong','xinjiang','wuyiqi','yingtong','19trip'-->
	<select id="queryPaySuccess"  resultClass="java.lang.String">
	select cp.order_id from cp_orderinfo cp where  cp.order_status='33' and 
		 cp.channel in(
		SELECT merchant_id FROM ext_merchantinfo 
		)
		and (select count(1) from ext_orderinfo_eopandpaynotify where order_id = cp.order_id)
		 order by create_time desc limit 0,20
		<!--
		 update elong_orderinfo_returnnotify set 
		  <![CDATA[
		 notify_status=NULL 
		  ]]>
		 where order_id='liuyiceshi001'
		-->
	</select>
	
	
	<!-- 查询带出票订单id list     'zhongyidong','elong','xinjiang','wuyiqi','yingtong','19trip'-->
	<select id="queryRefundTicket"  resultClass="java.util.HashMap">
		select * from ext_orderinfo_refundstream  where refund_status='00' and refund_type='1' and 
		create_time  <![CDATA[>]]> '2015-11-24'
		<!-- channel in(
		'xinjiang','wuyiqi','yingtong','xiaobaikj','zhongyidong','jsshiji','hangxinda',
		'jifuyi','jintai','suning','jike','sichuantrip','zhongyidong','juyou','hangxin','minsheng','suiyixing'
		)-->
		</select>
	
	
	
	<select id="queryYdToOutTicket" resultClass="java.lang.String">
		select order_id from cp_orderinfo  where order_status='33'  
		AND DATE_ADD(create_time, INTERVAL 25 MINUTE)<![CDATA[<=]]>NOW()
		 order by create_time desc limit 0,20
	</select>

	<select id="queryOrderInfo" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		select * from cp_orderinfo  where order_id=#orderId:VARCHAR#
	</select>

	<select id="queryOutTicketCpId" resultClass="java.lang.String">
		select cp_id from cp_orderinfo_cp where order_id=#orderId:VARCHAR#
	</select>

	<select id="queryCpInfo" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		select * from cp_orderinfo_cp where cp_id=#cp_id:VARCHAR#
	</select>

	<update id="updateCpInfo"  parameterClass="java.util.HashMap" >
		update cp_orderinfo_cp  set train_box=#train_box:VARCHAR# ,seat_no=#seat_no:VARCHAR# , buy_money=#buy_money:VARCHAR# where cp_id=#cp_id:VARCHAR#
	</update>
	<update id="updateOrderInfo" parameterClass="java.util.HashMap" >
		update cp_orderinfo set 
		<isNotNull  property="order_status">
				order_status=#order_status:VARCHAR#,
		</isNotNull>
		<isNotNull  property="buy_money">
				buy_money=#buy_money:VARCHAR# ,
		</isNotNull>
		<isNotNull  property="out_ticket_billno">
				out_ticket_billno=#out_ticket_billno:VARCHAR#,
		</isNotNull>
		<isNotNull  property="bank_pay_seq">
				bank_pay_seq=#bank_pay_seq:VARCHAR# ,
		</isNotNull>
		<isNotNull  property="error_info">
				error_info=#error_info:VARCHAR# ,
		</isNotNull>
		out_ticket_time=now() ,
		pay_time=now()
		where order_id=#order_id:VARCHAR#
	</update>
	
	<update id="updateNoticeInfo" parameterClass="java.util.HashMap"  >
		update cp_orderinfo_notify set notify_status='5',notify_num=1,notify_time=now(),notify_next_time=now() where order_id=#order_id:VARCHAR#
	</update>
	
	
	<update id="updateRefundOrderInfo" parameterClass="java.util.HashMap"  >
		UPDATE ext_orderinfo_refundstream SET 
		<isNotNull  property="refund_status">
				refund_status=#refund_status:VARCHAR#,
		</isNotNull>
		<isNotNull  property="actual_refund_money">
				actual_refund_money=#actual_refund_money:VARCHAR# ,
		</isNotNull>
		<isNotNull  property="refund_12306_seq">
				refund_12306_seq=#refund_12306_seq:VARCHAR#
		</isNotNull>
		where order_id=#order_id:VARCHAR# AND cp_id=#cp_id:VARCHAR#  and refund_type='1' and channel=#channel:VARCHAR# 
	</update>
	
	
	<!-- 退款流水中是否包含该车票的退款信息 -->
	<select id="queryRefundStreamContainCp" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM ext_orderinfo_refundstream er
		WHERE er.order_id=#order_id:VARCHAR#
		AND er.cp_id=#cp_id:VARCHAR#
		AND er.refund_type='1'
		AND er.refund_status <![CDATA[<>]]> '22'
	</select>
	
	<!-- 根据cp_id查询乘客信息 -->
	<select id="queryPassengerInfoByCpId" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT user_name,user_ids FROM ext_orderinfo_cp WHERE cp_id=#cp_id:VARCHAR#
	</select>
	
	<!-- 删除老的拒绝退款的退款流水 -->
	<delete id="deleteRefundStreamOnRefuse" parameterClass="java.util.HashMap">
		DELETE FROM ext_orderinfo_refundstream
		WHERE order_id=#order_id:VARCHAR#
		AND cp_id=#cp_id:VARCHAR#
		AND refund_type='1'
		AND refund_status='22'
	</delete>
	
	<!-- 添加退款流水 -->
	<insert id="addRefundStream" parameterClass="java.util.HashMap">
		insert into ext_orderinfo_refundstream
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="merchant_order_id">
				merchant_order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				refund_type
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				cp_id
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="merchant_refund_seq">
				merchant_refund_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="refund_purl">
				refund_purl
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				user_remark
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				refund_status
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				refund_percent
			</isNotNull>
			<isNotNull prepend="," property="channel">
				channel
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="merchant_order_id">
				#merchant_order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_type">
				#refund_type:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="cp_id">
				#cp_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="merchant_refund_seq">
				#merchant_refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:DECIMAL#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="refund_purl">
				#refund_purl:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="user_remark">
				#user_remark:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_status">
				#refund_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_percent">
				#refund_percent:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="channel">
				#channel:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 查询发车前的特殊时间点-->
	<select id="querySpecTimeBeforeFrom" resultClass="java.util.HashMap"
		parameterClass="java.lang.String">
		select h.from_time,DATE_FORMAT(h.travel_time,'%Y-%m-%d') AS travel_time 
		FROM ext_orderinfo h 
		WHERE h.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 添加退款流水 -->
	<insert id="addRefundNotify" parameterClass="java.util.HashMap">
		insert into ext_orderinfo_refundnotify
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="notify_status">
				notify_status
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				notify_url
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="notify_status">
				#notify_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				#notify_url:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 查询退款总计 -->
	<select id="queryRefundTotalInOrder" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT CONVERT(IFNULL(h.refund_total,0),CHAR) AS refund_total
			FROM ext_orderinfo h 
		WHERE h.order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 查询未发生退款的票数 -->
	<select id="queryRefundLeftCount" parameterClass="java.lang.String"
		resultClass="java.lang.Integer">
		SELECT a.num-b.num AS left_count
		FROM (SELECT COUNT(1) AS num FROM ext_orderinfo_cp 
		WHERE order_id=#order_id:VARCHAR#) AS a,( 
		SELECT COUNT(1) AS num FROM  ext_orderinfo_refundstream
		WHERE order_id=#order_id:VARCHAR#
		AND refund_type='1' and refund_status <![CDATA[<>]]> '22') AS b
	</select> 
	
	<!-- 定时查询待通知退票结果的列表 -->
	<select id="queryRefundResultWaitList" resultClass="java.util.HashMap">
		SELECT CONVERT(er.notify_id,CHAR) AS notify_id,er.order_id,er.refund_seq,notify_url,er.notify_status
			FROM ext_orderinfo_refundnotify er
			WHERE (er.notify_status='11' OR (er.notify_status='22' AND DATE_ADD(er.notify_time, INTERVAL 5 MINUTE)<![CDATA[<=]]>NOW()))
			AND er.notify_num <![CDATA[<]]>10
			ORDER BY er.create_time DESC
			LIMIT 0,20
	</select>
	
	<!-- 根据流水号查询退票的流水 -->
	<select id="queryRefundStreamListBySeq" parameterClass="java.util.HashMap"
		resultClass="java.util.HashMap">
		SELECT order_id,merchant_order_id,refund_type,cp_id,refund_seq,
			merchant_refund_seq,CONVERT(refund_money,CHAR) as refund_money,our_remark,refund_status,channel
			FROM ext_orderinfo_refundstream
			WHERE refund_seq=#refund_seq:VARCHAR#
			AND order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 根据订单号查询车票信息 -->
	<select id="queryCpListByOrderId" parameterClass="java.lang.String"
		resultClass="java.util.HashMap">
		SELECT cp_id,order_id,user_name,ids_type,user_ids,ticket_type
			FROM  ext_orderinfo_cp 
			WHERE order_id=#order_id:VARCHAR#
	</select>
	
	<!-- 更新退款结果通知请求开始  -->
	<update id="updateRefundNotfiyBegin" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundnotify
		set
		notify_time=NOW(),
		notify_num=notify_num+1,
		notify_status=#notify_status:VARCHAR#
		WHERE notify_id=#notify_id:INTEGER#
		AND order_id=#order_id:VARCHAR#
		AND notify_status=#old_notify_status:VARCHAR#
	</update>
	
	<!-- 更新退退款结果通知请求完成 -->
	<update id="updateRefundNotfiyFinish" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundnotify
		set
		notify_finish_time=NOW(),
		notify_status=#notify_status:VARCHAR#
		WHERE notify_id=#notify_id:INTEGER#
		AND order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 验证退票申请是否为重复申请 -->
	<select id="queryRefundCountByMerchantSeq" parameterClass="java.util.HashMap"
		resultClass="java.lang.Integer">
		SELECT COUNT(1) FROM ext_orderinfo_refundstream 
		WHERE merchant_refund_seq=#merchant_refund_seq:VARCHAR#
		AND channel=#channel:VARCHAR#
		AND merchant_order_id=#merchant_order_id:VARCHAR#
	</select>
	
	<!-- 验证是否出票完成的，否则不能进行退票申请 -->
	<select id="queryOrderStatusById" parameterClass="java.util.HashMap"
		resultClass="java.lang.String">
		SELECT order_status FROM ext_orderinfo 
		WHERE order_id=#order_id:VARCHAR#
		AND merchant_order_id=#merchant_order_id:VARCHAR#
		AND merchant_id=#merchant_id:VARCHAR#
	</select>
	
	<!-- 更新退票状态 -->
	<update id="updateOrderRefundStatus" parameterClass="java.util.HashMap">
		update ext_orderinfo set refund_status=#status:VARCHAR# 
			WHERE order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 添加退款流水 -->
	<insert id="addEopRefundNotify" parameterClass="java.util.HashMap">
		insert into ext_orderinfo_refundeopnotify
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				order_id
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				eop_order_id
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				refund_seq
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				refund_money
			</isNotNull>
			<isNotNull prepend="," property="refund_reason">
				refund_reason
			</isNotNull>
			,create_time
			<isNotNull prepend="," property="notify_status">
				notify_status
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				notify_url
			</isNotNull>
			)
		</dynamic>
		values
		<dynamic prepend="(">
			<isNotNull prepend="," property="order_id">
				#order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="eop_order_id">
				#eop_order_id:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_seq">
				#refund_seq:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="refund_money">
				#refund_money:DOUBLE#
			</isNotNull>
			<isNotNull prepend="," property="refund_reason">
				#refund_reason:VARCHAR#
			</isNotNull>
			,NOW()
			<isNotNull prepend="," property="notify_status">
				#notify_status:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="notify_url">
				#notify_url:VARCHAR#
			</isNotNull>
			)
		</dynamic>
	</insert>
	
	<!-- 更新退款通知平台请求开始  -->
	<update id="updateEopRefundNotfiyBegin" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundeopnotify
		set
		notify_time=NOW(),
		notify_num=notify_num+1,
		notify_status=#notify_status:VARCHAR#
		WHERE notify_id=#notify_id:INTEGER#
		AND order_id=#order_id:VARCHAR#
		AND notify_status=#old_notify_status:VARCHAR#
	</update>
	
	<!-- 更新退款通知平台请求完成 -->
	<update id="updateEopRefundNotfiyFinish" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundeopnotify
		set
		notify_finish_time=NOW(),
		notify_status=#notify_status:VARCHAR#
		WHERE notify_id=#notify_id:INTEGER#
		AND order_id=#order_id:VARCHAR#
	</update>
	
	<!-- 定时查询待通知退票结果的列表 -->
	<select id="queryEopRefundResultWaitList" resultClass="java.util.HashMap">
		SELECT CONVERT(er.notify_id,CHAR) AS notify_id,er.order_id,er.refund_seq,notify_url
			,er.notify_status,er.eop_order_id,er.refund_money,er.refund_reason
			FROM ext_orderinfo_refundeopnotify er
			WHERE (er.notify_status='11' OR (er.notify_status='22' AND DATE_ADD(er.notify_time, INTERVAL 5 MINUTE)<![CDATA[<=]]>NOW()))
			AND er.notify_num <![CDATA[<]]>10
			ORDER BY er.create_time DESC
			LIMIT 0,20
	</select>
	
	<!-- 更新退款表平台申请退款流水号 -->
	<update id="updateRefundStreamEopRefundSeq" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundstream
		set eop_refund_seq=#eop_refund_seq:VARCHAR# 
		WHERE refund_seq=#refund_seq:VARCHAR#
	</update>
	
	<!-- 根据平台退款异步通知结果更新退款表数据 -->
	<update id="updateEopRefundStreamInfo" parameterClass="java.util.HashMap">
		UPDATE ext_orderinfo_refundstream
		set
		eop_refund_status=#eop_refund_status:VARCHAR#,
		<isNotEmpty property="eop_refund_money">
			eop_refund_money=#eop_refund_money:DECIMAL#,
		</isNotEmpty>
		<isNotEmpty property="refund_status">
			refund_status=#refund_status:DECIMAL#,
		</isNotEmpty>
		eop_refund_time=#eop_refund_time:VARCHAR#
		WHERE eop_refund_seq=#eop_refund_seq:VARCHAR# 
	</update>
	
	
		<!-- 根据平台退款异步通知结果更新退款表数据 -->
	<update id="updateRefundNoticeInfo" parameterClass="java.util.HashMap">
		update ext_orderinfo_refundnotify set notify_status='11' where order_id=#order_id:VARCHAR# and refund_seq =#refund_seq:VARCHAR#
	</update>
	
	
	<select id="queryMerchantinfo" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		select * from ext_merchantinfo where merchant_id=#channel:VARCHAR#
	</select>
	
	
	<select id="selectCountNumFromNotice" parameterClass="java.util.HashMap" resultClass="java.lang.Integer">
		select count(1) from cp_orderinfo_notify where order_id=#order_id:VARCHAR#
	</select>
	
	<select id="selectSeatType" parameterClass="java.lang.String" resultClass="java.lang.String">
		select elong_seat_type from elong_orderinfo where order_id=#order_id:VARCHAR#
	</select>
</sqlMap>